<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="budgetBynan">
<meta name="theme-color" content="#0c0c0e">
<title>budgetBynan</title>
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Nanthe27/Budget/02b41c9ee340c694bb67a8f4f8d27bfa08ad862b/logo.jpg">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%230c0c0e'/></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ══════════════════════════════════════════
   TOKENS
══════════════════════════════════════════ */
:root{
  --font:'Sora',sans-serif;--mono:'Space Mono',monospace;
  --bg:#f7f7f5;--bg2:#fff;--bg3:#efefec;
  --surface:#fff;--surface2:#f2f2ef;
  --border:rgba(0,0,0,.09);--border2:rgba(0,0,0,.05);
  --text:#0c0c0e;--text2:#5c5c64;--text3:#9c9ca4;
  --logo-budget:#0c0c0e;--logo-bynan:#0c0c0e;
  --green:#1a9e52;--green-bg:rgba(26,158,82,.08);
  --red:#d93025;--red-bg:rgba(217,48,37,.08);
  --blue:#1a73e8;--blue-bg:rgba(26,115,232,.08);
  --amber:#e37400;--amber-bg:rgba(227,116,0,.1);
  --purple:#7c3aed;--purple-bg:rgba(124,58,237,.1);
  --shadow-sm:0 1px 4px rgba(0,0,0,.06);
  --shadow:0 4px 20px rgba(0,0,0,.08);
  --shadow-lg:0 16px 48px rgba(0,0,0,.14);
  --r-sm:6px;--r:12px;--r-lg:18px;--r-xl:24px;
  --nav-h:68px;--safe-b:env(safe-area-inset-bottom,12px);--safe-t:env(safe-area-inset-top,0px);
  --sidebar-w:240px;
}
[data-theme=dark]{
  --bg:#0c0c0e;--bg2:#131316;--bg3:#1a1a1f;
  --surface:#1a1a1f;--surface2:#202028;
  --border:rgba(255,255,255,.08);--border2:rgba(255,255,255,.04);
  --text:#f0f0f5;--text2:#8c8ca0;--text3:#5c5c6e;
  --logo-budget:#fff;--logo-bynan:#f0f0f5;
  --green:#34d472;--green-bg:rgba(52,212,114,.1);
  --red:#f05450;--red-bg:rgba(240,84,80,.1);
  --blue:#6aa6f0;--blue-bg:rgba(106,166,240,.1);
  --amber:#ffb840;--amber-bg:rgba(255,184,64,.1);
  --purple:#a78bfa;--purple-bg:rgba(167,139,250,.1);
  --shadow-sm:0 1px 4px rgba(0,0,0,.4);
  --shadow:0 4px 20px rgba(0,0,0,.5);
  --shadow-lg:0 16px 48px rgba(0,0,0,.7);
}

/* ══════════════════════════════════════════
   RESET
══════════════════════════════════════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height:100%;touch-action:manipulation;-webkit-text-size-adjust:100%;}
body{font-family:var(--font);background:var(--bg);color:var(--text);height:100%;min-height:100dvh;overflow:hidden;-webkit-font-smoothing:antialiased;}
button{font-family:var(--font);cursor:pointer;border:none;outline:none;background:none;}
input,select,textarea{font-family:var(--font);outline:none;border:none;background:none;}
ul,li{list-style:none;}a{text-decoration:none;color:inherit;}
select{appearance:none;-webkit-appearance:none;}

/* ══════════════════════════════════════════
   LOGO
══════════════════════════════════════════ */
.logo{display:flex;align-items:baseline;font-size:22px;font-weight:800;letter-spacing:-.8px;user-select:none;}
.logo .budget{color:var(--logo-budget);}
.logo .bynan{color:var(--logo-bynan);font-weight:300;}
.logo-sm{font-size:18px;}.logo-lg{font-size:28px;}

/* ══════════════════════════════════════════
   APP SHELL
══════════════════════════════════════════ */
#app{width:100%;height:100dvh;display:flex;overflow:hidden;}
.screen{display:none;flex-direction:column;width:100%;height:100%;overflow:hidden;}
.screen.active{display:flex;animation:sIn .18s ease;}
@keyframes sIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}

/* ══════════════════════════════════════════
   SIDEBAR
══════════════════════════════════════════ */
.sidebar{display:none;}
.sidebar-nav{flex:1;display:flex;flex-direction:column;gap:2px;padding:0 12px;}
.sidebar-bottom{padding:0 12px;display:flex;flex-direction:column;gap:2px;}
.sidebar-logo{padding:0 24px 32px;}
.sidebar-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--r-sm);cursor:pointer;font-size:14px;font-weight:500;color:var(--text2);transition:all .15s;}
.sidebar-item:hover{background:var(--bg3);color:var(--text);}
.sidebar-item.active{background:var(--bg3);color:var(--text);font-weight:600;}
.sidebar-item .sico{width:30px;height:30px;border-radius:var(--r-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;}
.sidebar-item.active .sico{background:var(--text);}
.sidebar-item.active .sico svg{stroke:var(--bg);}
.sidebar-item .sico svg{width:15px;height:15px;stroke:var(--text2);stroke-width:1.8;fill:none;}

/* ══════════════════════════════════════════
   DESKTOP
══════════════════════════════════════════ */
@media(min-width:960px){
  #app{flex-direction:row;}
  .sidebar{display:flex;flex-direction:column;width:var(--sidebar-w);height:100%;background:var(--surface);border-right:1px solid var(--border);padding:32px 0 24px;flex-shrink:0;z-index:10;}
  .desktop-main{flex:1;min-width:0;height:100%;overflow:hidden;position:relative;display:flex;flex-direction:column;}
  .screen{position:absolute;top:0;left:0;right:0;bottom:0;display:none;}
  .screen.active{display:flex;}
  .bottom-nav{display:none!important;}
  .fab{display:none!important;}
  .desktop-add-btn{display:flex!important;}
}
@media(max-width:959px){
  .sidebar{display:none!important;}
  .desktop-main{display:contents;}
  .desktop-add-btn{display:none!important;}
}

/* ══════════════════════════════════════════
   PAGE LAYOUT
══════════════════════════════════════════ */
.main-layout{display:flex;flex-direction:column;width:100%;height:100%;overflow:hidden;}
.page-content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:calc(var(--nav-h) + var(--safe-b) + 36px);}
.page-content::-webkit-scrollbar{display:none;}
@media(min-width:960px){.page-content{padding-bottom:24px;}}

/* ── Header ── */
.page-header{display:flex;align-items:center;gap:12px;padding:max(var(--safe-t),16px) 16px 12px;position:sticky;top:0;z-index:50;background:var(--bg);transition:box-shadow .2s;}
.page-header.scrolled{box-shadow:0 1px 0 var(--border);}
.page-header h1{font-size:20px;font-weight:700;flex:1;letter-spacing:-.3px;}
@media(min-width:960px){.page-header{padding:20px 32px 16px;}}

/* icon btn */
.icon-btn{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--surface);border:1px solid var(--border);cursor:pointer;transition:all .15s;flex-shrink:0;}
.icon-btn:hover{background:var(--bg3);}
.icon-btn:active{transform:scale(.92);}
.icon-btn svg{width:16px;height:16px;stroke:var(--text2);stroke-width:1.8;fill:none;}

/* desktop add btn */
.desktop-add-btn{display:none;align-items:center;gap:7px;padding:8px 18px;background:var(--text);color:var(--bg);border-radius:100px;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;}
.desktop-add-btn:hover{opacity:.85;}
.desktop-add-btn svg{width:14px;height:14px;stroke:var(--bg);stroke-width:2.2;fill:none;}

/* ══════════════════════════════════════════
   BOTTOM NAV
══════════════════════════════════════════ */
.bottom-nav{
  position:fixed;
  bottom:0;left:0;right:0;
  z-index:200;
  padding:8px 20px calc(env(safe-area-inset-bottom,0px) + 12px);
  pointer-events:none;
}
.bottom-nav.hidden{display:none!important;}
.nav-pills{
  display:flex;align-items:center;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:100px;
  padding:5px;gap:2px;
  box-shadow:0 8px 32px rgba(0,0,0,.18),0 2px 8px rgba(0,0,0,.1);
  max-width:420px;margin:0 auto;
  pointer-events:all;
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
}
.nav-pill{flex:1;display:flex;flex-direction:column;align-items:center;padding:11px 4px;border-radius:100px;cursor:pointer;transition:all .15s;}
.nav-pill svg{width:22px;height:22px;stroke:var(--text3);stroke-width:1.8;fill:none;transition:stroke .15s;}
.nav-pill.active{background:var(--text);}
.nav-pill.active svg{stroke:var(--bg);}
/* page content needs enough bottom padding to clear the floating nav */
.page-content{padding-bottom:calc(env(safe-area-inset-bottom,0px) + 100px)!important;}
@media(min-width:960px){
  .bottom-nav{display:none!important;}
  .page-content{padding-bottom:24px!important;}
}

/* ══════════════════════════════════════════
   FAB
══════════════════════════════════════════ */
.fab{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 22px);right:20px;z-index:199;width:52px;height:52px;border-radius:50%;background:var(--text);color:var(--bg);display:flex;align-items:center;justify-content:center;box-shadow:0 4px 16px rgba(0,0,0,.25);cursor:pointer;transition:all .15s;}
.fab:active{transform:scale(.92);}
.fab svg{width:22px;height:22px;stroke:var(--bg);stroke-width:2.2;fill:none;}

/* ══════════════════════════════════════════
   CARDS / SECTION
══════════════════════════════════════════ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);box-shadow:var(--shadow-sm);}
.section-title{font-size:12px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;padding:0 16px 8px;}
@media(min-width:960px){.section-title{padding:0 32px 8px;}}

/* ══════════════════════════════════════════
   TOAST
══════════════════════════════════════════ */
#toast-container{position:fixed;top:max(var(--safe-t),16px);left:50%;transform:translateX(-50%);z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{background:var(--text);color:var(--bg);padding:10px 18px;border-radius:100px;font-size:13px;font-weight:500;animation:toastIn .2s ease;white-space:nowrap;pointer-events:none;}
.toast.error{background:var(--red);}
.toast.success{background:var(--green);}
@keyframes toastIn{from{opacity:0;transform:translateY(-8px) scale(.95)}to{opacity:1;transform:none}}

/* ══════════════════════════════════════════
   MODALS
══════════════════════════════════════════ */
.modal-overlay{display:none;position:fixed;inset:0;z-index:500;align-items:flex-end;}
.modal-overlay.open{display:flex;}
.backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);}
.bottom-sheet{position:relative;width:100%;max-width:520px;margin:0 auto;background:var(--surface);border-radius:var(--r-xl) var(--r-xl) 0 0;padding:0 0 calc(env(safe-area-inset-bottom,0px)+8px);max-height:92dvh;display:flex;flex-direction:column;animation:sheetUp .22s cubic-bezier(.34,1.1,.64,1);}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:none}}
.sheet-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 4px;}
.sheet-header{display:flex;align-items:center;justify-content:space-between;padding:8px 20px 12px;}
.sheet-header h3{font-size:17px;font-weight:700;}
.sheet-close{width:32px;height:32px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;}
.sheet-close svg{width:14px;height:14px;stroke:var(--text2);stroke-width:2;fill:none;}
.sheet-body{padding:0 20px;overflow-y:auto;flex:1;}
.sheet-footer{padding:16px 20px 4px;border-top:1px solid var(--border);margin-top:8px;}

/* ══════════════════════════════════════════
   FORMS
══════════════════════════════════════════ */
.form-group{margin-bottom:14px;}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
.form-input{width:100%;padding:12px 14px;background:var(--bg3);border-radius:var(--r);font-size:15px;color:var(--text);border:1.5px solid transparent;transition:border-color .15s;}
.form-input:focus{border-color:var(--text3);}
.form-input::placeholder{color:var(--text3);}
select.form-input{cursor:pointer;}
.btn-primary{width:100%;padding:14px;background:var(--text);color:var(--bg);border-radius:var(--r);font-size:15px;font-weight:600;cursor:pointer;transition:opacity .15s;}
.btn-primary:hover{opacity:.85;}
.btn-primary:active{opacity:.7;transform:scale(.98);}
.btn-primary:disabled{opacity:.4;cursor:not-allowed;transform:none;}
.btn-secondary{width:100%;padding:12px;background:var(--bg3);color:var(--text);border-radius:var(--r);font-size:14px;font-weight:600;cursor:pointer;border:1px solid var(--border);}

/* ══════════════════════════════════════════
   AMOUNT INPUT
══════════════════════════════════════════ */
.amount-display{text-align:center;padding:20px 0 8px;}
.amount-display .currency{font-size:28px;font-weight:300;color:var(--text2);font-family:var(--mono);}
.amount-display .amount-val{font-size:52px;font-weight:700;letter-spacing:-2px;font-family:var(--mono);color:var(--text);}
.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:8px 0 16px;}
.numpad-btn{padding:16px;border-radius:var(--r);background:var(--bg3);font-size:20px;font-weight:500;color:var(--text);cursor:pointer;transition:all .1s;border:1px solid var(--border);}
.numpad-btn:active{transform:scale(.92);background:var(--surface2);}
.numpad-btn.delete{background:transparent;border-color:transparent;}
.numpad-btn.delete svg{width:20px;height:20px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.numpad-btn.empty{background:transparent;border-color:transparent;pointer-events:none;}
.type-toggle{display:flex;background:var(--bg3);border-radius:var(--r);padding:3px;gap:3px;margin-bottom:14px;}
.type-btn{flex:1;padding:9px;border-radius:var(--r-sm);font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;color:var(--text3);text-align:center;}
.type-btn.active.expense{background:var(--red);color:#fff;}
.type-btn.active.income{background:var(--green);color:#fff;}

/* ══════════════════════════════════════════
   CATEGORY GRID
══════════════════════════════════════════ */
.cat-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding-bottom:8px;}
.cat-item-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:10px 6px;border-radius:var(--r);border:2px solid transparent;cursor:pointer;transition:all .15s;background:var(--bg3);}
.cat-item-btn:active{transform:scale(.93);}
.cat-item-btn.selected{border-color:var(--text);}
.cat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.cat-dot-lg{width:28px;height:28px;border-radius:50%;flex-shrink:0;}
.cat-item-btn .cat-dot-lg{margin:0 auto;}
.cat-item-btn span{font-size:10px;font-weight:600;color:var(--text2);text-align:center;line-height:1.2;}

/* ══════════════════════════════════════════
   TRANSACTIONS LIST
══════════════════════════════════════════ */
.txn-list{padding:0 16px;}
@media(min-width:960px){.txn-list{padding:0 32px;}}
.txn-item{display:flex;align-items:center;gap:12px;padding:12px;border-radius:var(--r);cursor:pointer;transition:background .12s;-webkit-user-select:none;}
.txn-item:hover{background:var(--bg3);}
.txn-item:active{background:var(--surface2);}
.txn-icon{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.txn-icon svg{width:16px;height:16px;stroke-width:2.2;fill:none;}
.txn-info{flex:1;min-width:0;}
.txn-name{font-size:14px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.txn-meta{font-size:12px;color:var(--text3);margin-top:1px;}
.txn-amount{font-size:15px;font-weight:700;font-family:var(--mono);white-space:nowrap;}
.txn-amount.income{color:var(--green);}
.txn-amount.expense{color:var(--red);}
/* deleting state */
.txn-item.deleting{opacity:.4;pointer-events:none;}

/* ══════════════════════════════════════════
   EMPTY STATE
══════════════════════════════════════════ */
.empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;gap:12px;color:var(--text3);}
.empty-state svg{width:40px;height:40px;stroke:var(--text3);stroke-width:1.2;fill:none;opacity:.5;}
.empty-state p{font-size:14px;text-align:center;}

/* ══════════════════════════════════════════
   FILTER CHIPS
══════════════════════════════════════════ */
.filter-row{display:flex;gap:6px;padding:0 16px 12px;overflow-x:auto;scrollbar-width:none;}
.filter-row::-webkit-scrollbar{display:none;}
@media(min-width:960px){.filter-row{padding:0 32px 12px;}}
.filter-chip{padding:6px 14px;border-radius:100px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;background:var(--bg3);color:var(--text2);border:1px solid transparent;transition:all .15s;}
.filter-chip.active{background:var(--text);color:var(--bg);}

/* ══════════════════════════════════════════
   HOME SCREEN
══════════════════════════════════════════ */
#home-screen .page-content{padding-top:0;}
.home-hero{margin:10px 16px 16px;background:var(--text);border-radius:var(--r-xl);padding:24px 22px 20px;color:var(--bg);position:relative;overflow:hidden;box-sizing:border-box;}
.home-hero::before{content:'';position:absolute;top:-50px;right:-50px;width:180px;height:180px;background:rgba(255,255,255,.03);border-radius:50%;}
@media(min-width:960px){.home-hero{margin:16px 32px 18px;}}
.hero-period{font-size:11px;font-weight:500;opacity:.5;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;display:flex;align-items:center;gap:8px;}
.hero-period button{background:rgba(255,255,255,.14);color:inherit;border:none;border-radius:20px;padding:3px 10px;font-size:10px;cursor:pointer;font-family:var(--font);font-weight:500;}
.hero-balance{font-size:36px;font-weight:800;letter-spacing:-1.5px;line-height:1;margin-bottom:4px;font-family:var(--mono);}
.hero-balance .currency{font-size:18px;font-weight:400;opacity:.6;margin-right:2px;vertical-align:3px;font-family:var(--font);}
.hero-label{font-size:11px;opacity:.45;margin-bottom:18px;}
.hero-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;position:relative;z-index:1;width:100%;}
.hero-stat{background:rgba(255,255,255,.1);border-radius:var(--r);padding:12px;min-width:0;}
.hero-stat-label{font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;display:flex;align-items:center;gap:5px;}
.hero-stat-label svg{width:10px;height:10px;stroke:currentColor;stroke-width:2.2;fill:none;flex-shrink:0;}
.hero-stat-value{font-size:17px;font-weight:700;letter-spacing:-.5px;font-family:var(--mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hero-stat-value.income{color:#6ee7b7;}
.hero-stat-value.expense{color:#fca5a5;}

/* quick actions */
.quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:0 16px 16px;}
@media(min-width:960px){.quick-actions{padding:0 32px 18px;max-width:600px;}}
.quick-action{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:13px 8px;text-align:center;cursor:pointer;transition:all .15s;box-shadow:var(--shadow-sm);}
.quick-action:hover{box-shadow:var(--shadow);}
.quick-action:active{transform:scale(.94);}
.qa-icon{width:34px;height:34px;border-radius:var(--r-sm);background:var(--bg3);margin:0 auto 7px;display:flex;align-items:center;justify-content:center;}
.qa-icon svg{width:16px;height:16px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.qa-label{font-size:11px;font-weight:600;color:var(--text2);}

/* spending chart */
.chart-wrap{padding:0 16px 16px;}
@media(min-width:960px){.chart-wrap{padding:0 32px 16px;}}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;box-shadow:var(--shadow-sm);}
.chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
.chart-label{font-size:12px;font-weight:600;color:var(--text2);}
.chart-total{font-size:16px;font-weight:700;font-family:var(--mono);}
.mini-chart{display:flex;align-items:flex-end;gap:4px;height:60px;}
.chart-col{display:flex;flex-direction:column;align-items:center;flex:1;gap:4px;}
.chart-bar{background:var(--border);border-radius:4px;width:100%;transition:height .3s ease;}
.chart-bar.active{background:var(--text);}
.chart-bar-label{font-size:9px;color:var(--text3);font-weight:500;}

/* recent txns */
.section-header{display:flex;align-items:center;justify-content:space-between;padding:0 16px 8px;}
@media(min-width:960px){.section-header{padding:0 32px 8px;}}
.section-link{font-size:12px;color:var(--blue);font-weight:600;cursor:pointer;}

/* cycle badge */
.cycle-badge{margin:0 16px 12px;padding:10px 14px;background:var(--green-bg);border-radius:var(--r);display:flex;align-items:center;gap:8px;}
@media(min-width:960px){.cycle-badge{margin:0 32px 12px;}}
.cycle-badge svg{width:14px;height:14px;stroke:var(--green);stroke-width:2;fill:none;flex-shrink:0;}
.cycle-badge span{font-size:12px;color:var(--green);font-weight:600;}

/* ══════════════════════════════════════════
   ANALYTICS
══════════════════════════════════════════ */
.ana-cards{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 16px 16px;}
@media(min-width:960px){.ana-cards{grid-template-columns:repeat(4,1fr);padding:0 32px 16px;}}
.ac{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:14px;box-shadow:var(--shadow-sm);}
.ac-label{font-size:11px;color:var(--text3);margin-bottom:5px;font-weight:500;}
.ac-value{font-size:17px;font-weight:700;font-family:var(--mono);}
.ac-value.green{color:var(--green);}
.ac-value.red{color:var(--red);}
.donut-wrap{padding:0 16px 16px;}
@media(min-width:960px){.donut-wrap{padding:0 32px 16px;}}
.donut-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;box-shadow:var(--shadow-sm);display:flex;gap:16px;align-items:center;}
#donut-svg{width:100px;height:100px;flex-shrink:0;}
.donut-legend{flex:1;display:flex;flex-direction:column;gap:6px;}
.legend-item{display:flex;align-items:center;gap:7px;font-size:12px;}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.legend-name{flex:1;color:var(--text2);}
.legend-pct{font-weight:700;font-family:var(--mono);color:var(--text);}
.budget-list{padding:0 16px 16px;}
@media(min-width:960px){.budget-list{padding:0 32px 16px;}}
.budget-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--r);padding:12px;margin-bottom:8px;box-shadow:var(--shadow-sm);}
.budget-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.budget-name{font-size:13px;font-weight:600;}
.budget-amounts{font-size:12px;color:var(--text2);font-family:var(--mono);}
.budget-bar-bg{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.budget-bar-fill{height:100%;border-radius:3px;transition:width .5s ease;}

/* ══════════════════════════════════════════
   SETTINGS / MORE
══════════════════════════════════════════ */
.menu-list{padding:0 16px;}
@media(min-width:960px){.menu-list{padding:0 32px;}}
.menu-item{display:flex;align-items:center;gap:12px;padding:13px 14px;background:var(--surface);border-radius:var(--r);margin-bottom:8px;cursor:pointer;border:1px solid var(--border);transition:all .15s;}
.menu-item:hover{background:var(--bg3);}
.menu-item:active{transform:scale(.98);}
.menu-icon{width:36px;height:36px;border-radius:var(--r-sm);background:var(--bg3);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.menu-icon svg{width:16px;height:16px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.menu-label{flex:1;font-size:14px;font-weight:500;}
.menu-arrow{width:16px;height:16px;stroke:var(--text3);stroke-width:2;fill:none;}

/* ══════════════════════════════════════════
   PROFILE
══════════════════════════════════════════ */
.profile-header{display:flex;flex-direction:column;align-items:center;padding:24px 16px 20px;gap:12px;}
.avatar-wrap{position:relative;width:80px;height:80px;}
.avatar-img{width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--border);}
.avatar-fallback{width:80px;height:80px;border-radius:50%;background:var(--bg3);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:var(--text2);}
.profile-name{font-size:20px;font-weight:700;}
.profile-sub{font-size:13px;color:var(--text3);}

/* ══════════════════════════════════════════
   CATEGORIES MANAGEMENT
══════════════════════════════════════════ */
.cat-manage-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border-radius:var(--r);margin-bottom:6px;border:1px solid var(--border);}
.cat-manage-item .cat-dot{width:10px;height:10px;border-radius:50%;}
.cat-manage-name{flex:1;font-size:14px;font-weight:500;}
.cat-manage-type{font-size:11px;color:var(--text3);background:var(--bg3);padding:2px 7px;border-radius:20px;font-weight:500;}
.cat-delete{width:30px;height:30px;border-radius:50%;background:var(--red-bg);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.cat-delete svg{width:13px;height:13px;stroke:var(--red);stroke-width:2;fill:none;}
.color-swatches{display:flex;flex-wrap:wrap;gap:8px;padding:4px 0 8px;}
.color-swatch{width:28px;height:28px;border-radius:50%;cursor:pointer;transition:transform .1s;border:2px solid transparent;}
.color-swatch:active{transform:scale(.85);}
.color-swatch.selected{border-color:var(--text);transform:scale(1.15);}

/* ══════════════════════════════════════════
   INCOME SOURCES
══════════════════════════════════════════ */
.source-item{display:flex;align-items:center;gap:10px;padding:12px 14px;background:var(--surface);border-radius:var(--r);margin-bottom:6px;border:1px solid var(--border);}
.source-name{flex:1;font-size:14px;font-weight:500;}
.is-delete{width:30px;height:30px;border-radius:50%;background:var(--red-bg);display:flex;align-items:center;justify-content:center;}
.is-delete svg{width:13px;height:13px;stroke:var(--red);stroke-width:2;fill:none;}

/* ══════════════════════════════════════════
   LOGIN
══════════════════════════════════════════ */
#login-screen{align-items:center;justify-content:center;padding:max(var(--safe-t),24px) 24px calc(var(--safe-b)+24px);background:var(--bg);width:100%;height:100%;}
.login-inner{width:100%;max-width:340px;}
.login-logo{text-align:center;margin-bottom:32px;}
.login-logo .logo-mark{width:64px;height:64px;background:var(--text);border-radius:18px;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;}
.login-logo .logo-mark svg{width:32px;height:32px;stroke:var(--bg);stroke-width:1.8;fill:none;}
.user-list{display:flex;flex-direction:column;gap:10px;margin-bottom:24px;align-items:center;}
.user-card{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border-radius:var(--r-lg);cursor:pointer;border:2px solid var(--border);transition:all .15s;box-shadow:var(--shadow-sm);width:100%;}
.user-card:hover{border-color:var(--text3);box-shadow:var(--shadow);}
.user-card:active{transform:scale(.97);}
.uav{width:40px;height:40px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
.uav img{width:100%;height:100%;object-fit:cover;}
.uname{font-size:15px;font-weight:600;}

/* pin */
.pin-dots{display:flex;justify-content:center;gap:12px;margin:20px 0;}
.pin-dot{width:14px;height:14px;border-radius:50%;background:var(--border);transition:all .15s;}
.pin-dot.filled{background:var(--text);}
.pin-dot.error{background:var(--red);}

/* ══════════════════════════════════════════
   TRIP MODE
══════════════════════════════════════════ */
.trip-card{margin:0 16px 10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px;cursor:pointer;box-shadow:var(--shadow-sm);transition:all .15s;}
.trip-card:hover{box-shadow:var(--shadow);}
.trip-card:active{transform:scale(.98);}
@media(min-width:960px){.trip-card{margin:0 32px 10px;}}
.trip-card-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.trip-card-icon{width:36px;height:36px;border-radius:var(--r-sm);background:var(--purple-bg);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.trip-card-icon svg{width:16px;height:16px;stroke:var(--purple);stroke-width:1.8;fill:none;}
.trip-card-name{font-size:14px;font-weight:700;flex:1;}
.trip-status{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;text-transform:uppercase;letter-spacing:.5px;}
.trip-status.active{background:var(--green-bg);color:var(--green);}
.trip-status.ended{background:var(--bg3);color:var(--text3);}
.trip-dates{font-size:11px;color:var(--text3);margin-bottom:8px;}
.trip-progress-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
.trip-spent{font-size:13px;font-weight:700;font-family:var(--mono);}
.trip-budget{font-size:11px;color:var(--text3);font-family:var(--mono);}
.trip-bar-bg{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.trip-bar-fill{height:100%;border-radius:3px;background:var(--purple);transition:width .5s ease;}

/* trip detail */
.trip-detail-hero{margin:10px 16px 14px;background:var(--purple);border-radius:var(--r-xl);padding:22px;color:#fff;position:relative;overflow:hidden;}
@media(min-width:960px){.trip-detail-hero{margin:16px 32px 14px;}}
.trip-detail-hero::before{content:'';position:absolute;top:-40px;right:-40px;width:160px;height:160px;background:rgba(255,255,255,.05);border-radius:50%;}
.tdh-name{font-size:20px;font-weight:800;margin-bottom:3px;}
.tdh-dates{font-size:12px;opacity:.6;margin-bottom:16px;}
.tdh-balance{font-size:32px;font-weight:800;font-family:var(--mono);letter-spacing:-1px;}
.tdh-label{font-size:11px;opacity:.5;margin-bottom:4px;}
.tdh-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;}
.tdh-stat{background:rgba(255,255,255,.12);border-radius:var(--r);padding:10px;}
.tdh-stat-label{font-size:10px;opacity:.6;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
.tdh-stat-value{font-size:15px;font-weight:700;font-family:var(--mono);}

/* ══════════════════════════════════════════
   CONFIRM DIALOG
══════════════════════════════════════════ */
#confirm-overlay{display:none;position:fixed;inset:0;z-index:800;align-items:center;justify-content:center;padding:24px;}
#confirm-overlay.open{display:flex;}
#confirm-overlay .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.5);}
.confirm-box{position:relative;background:var(--surface);border-radius:var(--r-xl);padding:24px;max-width:320px;width:100%;box-shadow:var(--shadow-lg);}
.confirm-box h3{font-size:17px;font-weight:700;margin-bottom:8px;}
.confirm-box p{font-size:14px;color:var(--text2);margin-bottom:20px;line-height:1.5;}
.confirm-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.confirm-cancel{padding:12px;border-radius:var(--r);background:var(--bg3);font-size:14px;font-weight:600;cursor:pointer;}
.confirm-ok{padding:12px;border-radius:var(--r);background:var(--red);color:#fff;font-size:14px;font-weight:600;cursor:pointer;}

/* ══════════════════════════════════════════
   MONTH NAV
══════════════════════════════════════════ */
.month-nav{display:flex;align-items:center;gap:8px;}
.month-nav button{width:30px;height:30px;border-radius:50%;background:var(--bg3);display:flex;align-items:center;justify-content:center;cursor:pointer;}
.month-nav button svg{width:14px;height:14px;stroke:var(--text2);stroke-width:2;fill:none;}
.month-nav span{font-size:13px;font-weight:600;min-width:80px;text-align:center;}

/* ══════════════════════════════════════════
   LOADING OVERLAY
══════════════════════════════════════════ */
#loading-overlay{position:fixed;inset:0;background:var(--bg);z-index:9000;display:flex;align-items:center;justify-content:center;transition:opacity .3s;}
#loading-overlay.hidden{opacity:0;pointer-events:none;}
.spinner{width:32px;height:32px;border:2px solid var(--border);border-top-color:var(--text);border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.icon-btn.syncing svg{animation:spin .7s linear infinite;}
</style>
</head>
<body>
<div id="loading-overlay"><div class="spinner"></div></div>
<div id="toast-container"></div>

<!-- ══════════════════════════════════════════
     CONFIRM DIALOG
══════════════════════════════════════════ -->
<div id="confirm-overlay">
  <div class="backdrop" id="confirm-backdrop"></div>
  <div class="confirm-box">
    <h3 id="confirm-title">Are you sure?</h3>
    <p id="confirm-msg">This action cannot be undone.</p>
    <div class="confirm-actions">
      <button class="confirm-cancel" id="confirm-cancel">Cancel</button>
      <button class="confirm-ok" id="confirm-ok">Delete</button>
    </div>
  </div>
</div>

<!-- ══════════════════════════════════════════
     APP
══════════════════════════════════════════ -->
<div id="app">

<!-- SIDEBAR (desktop) -->
<nav class="sidebar" id="sidebar" style="display:none">
  <div class="sidebar-logo"><div class="logo logo-sm"><span class="budget">budget</span><span class="bynan">Bynan</span></div></div>
  <div class="sidebar-nav">
    <div class="sidebar-item active" data-screen="home" id="sb-home">
      <div class="sico"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>Overview
    </div>
    <div class="sidebar-item" data-screen="transactions" id="sb-transactions">
      <div class="sico"><svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg></div>Transactions
    </div>
    <div class="sidebar-item" data-screen="analytics" id="sb-analytics">
      <div class="sico"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></div>Analytics
    </div>
    <div class="sidebar-item" data-screen="trips" id="sb-trips">
      <div class="sico"><svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>Trips
    </div>
    <div class="sidebar-item" data-screen="more" id="sb-more">
      <div class="sico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg></div>Settings
    </div>
  </div>
  <div class="sidebar-bottom">
    <div class="sidebar-item" id="sidebar-theme">
      <div class="sico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></div>
      <span id="sidebar-theme-label">Light Mode</span>
    </div>
    <div class="sidebar-item" id="sidebar-logout">
      <div class="sico"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>Sign Out
    </div>
  </div>
</nav>

<div class="desktop-main" id="desktop-main">

<!-- ══════ LOGIN ══════ -->
<div class="screen active" id="login-screen">
  <div class="login-inner">
    <div class="login-logo">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      </div>
      <div class="logo logo-lg" style="justify-content:center"><span class="budget">budget</span><span class="bynan">Bynan</span></div>
    </div>
    <div id="step-select">
      <div class="user-list" id="user-list"></div>
    </div>
    <div id="step-pin" style="display:none">
      <p style="text-align:center;font-size:14px;color:var(--text2);margin-bottom:4px">Enter PIN for</p>
      <p style="text-align:center;font-size:18px;font-weight:700;margin-bottom:0" id="pin-user-name"></p>
      <div class="pin-dots">
        <div class="pin-dot" id="pd0"></div>
        <div class="pin-dot" id="pd1"></div>
        <div class="pin-dot" id="pd2"></div>
        <div class="pin-dot" id="pd3"></div>
      </div>
      <div class="numpad">
        <button class="numpad-btn" data-n="1">1</button>
        <button class="numpad-btn" data-n="2">2</button>
        <button class="numpad-btn" data-n="3">3</button>
        <button class="numpad-btn" data-n="4">4</button>
        <button class="numpad-btn" data-n="5">5</button>
        <button class="numpad-btn" data-n="6">6</button>
        <button class="numpad-btn" data-n="7">7</button>
        <button class="numpad-btn" data-n="8">8</button>
        <button class="numpad-btn" data-n="9">9</button>
        <button class="numpad-btn empty"></button>
        <button class="numpad-btn" data-n="0">0</button>
        <button class="numpad-btn delete" id="pin-delete"><svg viewBox="0 0 24 24"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg></button>
      </div>
      <button class="btn-secondary" id="pin-back" style="margin-top:4px">← Back</button>
    </div>
  </div>
</div>

<!-- ══════ HOME ══════ -->
<div class="screen" id="home-screen">
  <div class="main-layout">
    <div class="page-header" id="home-header">
      <div style="flex:1">
        <div style="font-size:12px;color:var(--text3);font-weight:500" id="greeting-time">Good morning</div>
        <div style="font-size:18px;font-weight:700;letter-spacing:-.3px" id="home-username-display"></div>
      </div>
      <button class="icon-btn" id="sync-btn" title="Sync"><svg viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg></button>
      <button class="icon-btn" id="theme-toggle-home"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
      <button class="icon-btn" id="logout-btn"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
      <button class="desktop-add-btn" id="desktop-add-btn">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Transaction
      </button>
    </div>
    <div class="page-content" id="home-content">
      <!-- hero -->
      <div class="home-hero">
        <div class="hero-period">
          <button id="hero-period-btn">← prev</button>
          <span id="hero-period-label"></span>
        </div>
        <div class="hero-label" id="cycle-label">Balance</div>
        <div class="hero-balance"><span class="currency">$</span><span id="hero-balance">0</span></div>
        <div class="hero-stats" style="margin-top:16px">
          <div class="hero-stat">
            <div class="hero-stat-label">
              <svg viewBox="0 0 24 24"><polyline points="17 11 12 6 7 11"/><line x1="12" y1="6" x2="12" y2="18"/></svg>
              EXPENSES
            </div>
            <div class="hero-stat-value expense" id="hero-expense">$0</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-label">
              <svg viewBox="0 0 24 24"><polyline points="7 13 12 18 17 13"/><line x1="12" y1="6" x2="12" y2="18"/></svg>
              INCOME
            </div>
            <div class="hero-stat-value income" id="hero-income">$0</div>
          </div>
        </div>
      </div>
      <!-- cycle badge -->
      <div class="cycle-badge" id="cycle-badge" style="display:none">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        <span id="cycle-badge-text">Cycle started</span>
      </div>
      <!-- quick actions -->
      <div class="quick-actions">
        <div class="quick-action" id="qa-add-expense">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><polyline points="17 11 12 6 7 11"/><line x1="12" y1="6" x2="12" y2="18"/></svg></div>
          <div class="qa-label">Expense</div>
        </div>
        <div class="quick-action" id="qa-add-income">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><polyline points="7 13 12 18 17 13"/><line x1="12" y1="6" x2="12" y2="18"/></svg></div>
          <div class="qa-label">Income</div>
        </div>
        <div class="quick-action" id="qa-budgets">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
          <div class="qa-label">Budgets</div>
        </div>
        <div class="quick-action" id="qa-trip">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
          <div class="qa-label">Trips</div>
        </div>
      </div>
      <!-- spending chart -->
      <div class="chart-wrap">
        <div class="chart-card">
          <div class="chart-header">
            <div class="chart-label">7-day spending</div>
            <div class="chart-total" id="chart-total">$0</div>
          </div>
          <div class="mini-chart" id="mini-chart"></div>
        </div>
      </div>
      <!-- recent txns -->
      <div class="section-header">
        <div class="section-title" style="padding:0">Recent</div>
        <div class="section-link" id="see-all-link">See all</div>
      </div>
      <div id="recent-txn-list"></div>
    </div>
  </div>
</div>

<!-- ══════ TRANSACTIONS ══════ -->
<div class="screen" id="transactions-screen">
  <div class="main-layout">
    <div class="page-header" id="txn-header">
      <h1>Transactions</h1>
      <div class="month-nav">
        <button id="txn-prev-month"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
        <span id="txn-month-label"></span>
        <button id="txn-next-month"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button>
      </div>
      <button class="desktop-add-btn" id="desktop-add-btn-txn">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add
      </button>
    </div>
    <div class="filter-row" id="txn-filter-row">
      <div class="filter-chip active" data-ttype="all">All</div>
      <div class="filter-chip" data-ttype="expense">Expenses</div>
      <div class="filter-chip" data-ttype="income">Income</div>
    </div>
    <div class="page-content" id="txn-content">
      <div class="txn-list" id="txn-list"></div>
    </div>
  </div>
</div>

<!-- ══════ ANALYTICS ══════ -->
<div class="screen" id="analytics-screen">
  <div class="main-layout">
    <div class="page-header">
      <h1>Analytics</h1>
      <div class="month-nav">
        <button id="ana-prev-month"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
        <span id="ana-month-label"></span>
        <button id="ana-next-month"><svg viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg></button>
      </div>
      <button class="desktop-add-btn" id="desktop-add-btn-ana">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add
      </button>
    </div>
    <div class="page-content">
      <div class="ana-cards">
        <div class="ac"><div class="ac-label">Income</div><div class="ac-value green" id="ana-income">$0</div></div>
        <div class="ac"><div class="ac-label">Expenses</div><div class="ac-value red" id="ana-expense">$0</div></div>
        <div class="ac"><div class="ac-label">Balance</div><div class="ac-value" id="ana-balance">$0</div></div>
        <div class="ac"><div class="ac-label" id="ana-vsmonth-label">vs last month</div><div class="ac-value" id="ana-vsmonth">—</div></div>
      </div>
      <div class="donut-wrap">
        <div class="donut-card">
          <svg id="donut-svg" viewBox="0 0 100 100"></svg>
          <div class="donut-legend" id="donut-legend"></div>
        </div>
      </div>
      <div class="section-header">
        <div class="section-title" style="padding:0">Budgets</div>
        <div class="section-link" id="edit-budgets-link">Edit</div>
      </div>
      <div class="budget-list" id="budget-list"></div>
    </div>
  </div>
</div>

<!-- ══════ TRIPS ══════ -->
<div class="screen" id="trips-screen">
  <div class="main-layout">
    <div class="page-header">
      <h1>Trips</h1>
      <button class="desktop-add-btn" id="desktop-add-trip-btn" style="display:flex">
        <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Trip
      </button>
    </div>
    <div class="page-content">
      <div id="trips-list"></div>
    </div>
  </div>
</div>

<!-- ══════ TRIP DETAIL ══════ -->
<div class="screen" id="trip-detail-screen">
  <div class="main-layout">
    <div class="page-header">
      <button class="icon-btn" id="trip-detail-back"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
      <h1 id="trip-detail-title">Trip</h1>
      <button class="icon-btn" id="trip-end-btn" title="End Trip"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg></button>
    </div>
    <div class="page-content">
      <div class="trip-detail-hero" id="trip-detail-hero">
        <div style="position:relative;z-index:1">
          <div class="tdh-name" id="tdh-name"></div>
          <div class="tdh-dates" id="tdh-dates"></div>
          <div class="tdh-label">Budget Remaining</div>
          <div class="tdh-balance" id="tdh-balance">$0</div>
          <div class="tdh-stats">
            <div class="tdh-stat"><div class="tdh-stat-label">Spent</div><div class="tdh-stat-value" id="tdh-spent">$0</div></div>
            <div class="tdh-stat"><div class="tdh-stat-label">Budget</div><div class="tdh-stat-value" id="tdh-budget">$0</div></div>
          </div>
        </div>
      </div>
      <div class="section-header" style="padding:0 16px 8px">
        <div class="section-title" style="padding:0">Spending</div>
        <button class="desktop-add-btn" id="trip-add-expense-btn" style="display:flex;padding:6px 14px;font-size:12px">
          <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add
        </button>
      </div>
      <div class="txn-list" id="trip-txn-list"></div>
    </div>
  </div>
</div>

<!-- ══════ MORE / SETTINGS ══════ -->
<div class="screen" id="more-screen">
  <div class="main-layout">
    <div class="page-header">
      <h1>Settings</h1>
      <button class="icon-btn" id="dark-mode-toggle"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button>
    </div>
    <div class="page-content">
      <div id="more-profile-area" style="padding:0 16px 16px"></div>
      <div class="menu-list" id="more-menu"></div>
    </div>
  </div>
</div>

<!-- ══════ PROFILE SCREEN ══════ -->
<div class="screen" id="profile-screen">
  <div class="main-layout">
    <div class="page-header">
      <button class="icon-btn" id="profile-back"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
      <h1>Profile</h1>
    </div>
    <div class="page-content">
      <div class="profile-header">
        <div class="avatar-wrap" id="profile-avatar-wrap"></div>
        <div class="profile-name" id="profile-name-display"></div>
        <div class="profile-sub" id="profile-sub-display"></div>
      </div>
      <div style="padding:0 16px">
        <div class="form-group">
          <label class="form-label">Profile Picture URL</label>
          <input class="form-input" id="profile-img-url" type="url" placeholder="https://...image.jpg">
        </div>
        <button class="btn-primary" id="save-profile-img">Save Photo</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════ SOURCES ══════ -->
<div class="screen" id="sources-screen">
  <div class="main-layout">
    <div class="page-header">
      <button class="icon-btn" id="sources-back"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
      <h1>Income Sources</h1>
    </div>
    <div class="page-content">
      <div style="padding:0 16px 12px">
        <button class="btn-secondary" id="add-source-btn" style="margin-bottom:12px">+ Add Source</button>
        <div id="source-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══════ CATEGORIES ══════ -->
<div class="screen" id="categories-screen">
  <div class="main-layout">
    <div class="page-header">
      <button class="icon-btn" id="categories-back"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
      <h1>Categories</h1>
    </div>
    <div class="filter-row" id="cat-type-filter">
      <div class="filter-chip active" data-ctype="expense">Expense</div>
      <div class="filter-chip" data-ctype="income">Income</div>
    </div>
    <div class="page-content">
      <div style="padding:0 16px 12px">
        <button class="btn-secondary" id="add-cat-btn" style="margin-bottom:12px">+ Add Category</button>
        <div id="cat-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- ══════ FAB ══════ -->
<button class="fab" id="fab" style="display:none">
  <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>
<button class="fab" id="fab-txn" style="display:none">
  <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
</button>

<!-- ══════ BOTTOM NAV ══════ -->
<nav class="bottom-nav hidden" id="bottom-nav">
  <div class="nav-pills">
    <div class="nav-pill active" data-screen="home">
      <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    </div>
    <div class="nav-pill" data-screen="transactions">
      <svg viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
    </div>
    <div class="nav-pill" data-screen="analytics">
      <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    </div>
    <div class="nav-pill" data-screen="trips">
      <svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
    </div>
    <div class="nav-pill" data-screen="more">
      <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
    </div>
  </div>
</nav>

</div><!-- /desktop-main -->
</div><!-- /app -->

<!-- ══════════════════════════════════════════
     MODALS
══════════════════════════════════════════ -->
<!-- Add Transaction -->
<div class="modal-overlay" id="add-txn-modal">
  <div class="backdrop" id="add-txn-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 id="add-txn-title">Add Transaction</h3>
      <button class="sheet-close" id="add-txn-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="type-toggle">
        <div class="type-btn active expense" id="type-expense">↑ Expense</div>
        <div class="type-btn income" id="type-income">↓ Income</div>
      </div>
      <div class="amount-display">
        <span class="currency">$</span><span class="amount-val" id="txn-amount-display">0</span>
      </div>
      <div class="numpad" id="txn-numpad">
        <button class="numpad-btn" data-n="1">1</button>
        <button class="numpad-btn" data-n="2">2</button>
        <button class="numpad-btn" data-n="3">3</button>
        <button class="numpad-btn" data-n="4">4</button>
        <button class="numpad-btn" data-n="5">5</button>
        <button class="numpad-btn" data-n="6">6</button>
        <button class="numpad-btn" data-n="7">7</button>
        <button class="numpad-btn" data-n="8">8</button>
        <button class="numpad-btn" data-n="9">9</button>
        <button class="numpad-btn" data-n=".">.</button>
        <button class="numpad-btn" data-n="0">0</button>
        <button class="numpad-btn delete" id="txn-delete-btn"><svg viewBox="0 0 24 24"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg></button>
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <div class="cat-grid" id="txn-cat-grid"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input class="form-input" id="txn-desc" type="text" placeholder="Optional note">
      </div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" id="txn-date" type="date">
      </div>
      <div class="form-group" id="source-group">
        <label class="form-label">Income Source</label>
        <select class="form-input" id="txn-source"></select>
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-txn-btn">Add Transaction</button>
    </div>
  </div>
</div>

<!-- Budget Modal -->
<div class="modal-overlay" id="budget-modal">
  <div class="backdrop" id="budget-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>Set Budget</h3>
      <button class="sheet-close" id="budget-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-input" id="budget-cat"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Monthly Limit ($)</label>
        <input class="form-input" id="budget-amount" type="number" placeholder="e.g. 500" inputmode="decimal">
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-budget-btn">Save Budget</button>
    </div>
  </div>
</div>

<!-- Add Source Modal -->
<div class="modal-overlay" id="add-source-modal">
  <div class="backdrop" id="add-source-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>Add Income Source</h3>
      <button class="sheet-close" id="add-source-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Source Name</label>
        <input class="form-input" id="source-name" type="text" placeholder="e.g. Primary Job">
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-source-btn">Add Source</button>
    </div>
  </div>
</div>

<!-- Add Category Modal -->
<div class="modal-overlay" id="add-cat-modal">
  <div class="backdrop" id="add-cat-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>Add Category</h3>
      <button class="sheet-close" id="add-cat-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" id="cat-name" type="text" placeholder="e.g. Gym">
      </div>
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-input" id="cat-type-select"><option value="expense">Expense</option><option value="income">Income</option></select>
      </div>
      <div class="form-group">
        <label class="form-label">Color</label>
        <div class="color-swatches" id="color-swatches"></div>
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-cat-btn">Add Category</button>
    </div>
  </div>
</div>

<!-- New Trip Modal -->
<div class="modal-overlay" id="add-trip-modal">
  <div class="backdrop" id="add-trip-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>New Trip</h3>
      <button class="sheet-close" id="add-trip-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Trip Name</label>
        <input class="form-input" id="trip-name" type="text" placeholder="e.g. Bangkok 2025">
      </div>
      <div class="form-group">
        <label class="form-label">Budget ($)</label>
        <input class="form-input" id="trip-budget" type="number" placeholder="e.g. 1500" inputmode="decimal">
      </div>
      <div class="form-group">
        <label class="form-label">Start Date</label>
        <input class="form-input" id="trip-start" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">End Date (optional)</label>
        <input class="form-input" id="trip-end" type="date">
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-trip-btn">Create Trip</button>
    </div>
  </div>
</div>

<script>
'use strict';
/* ══════════════════════════════════════════
   CONFIG
══════════════════════════════════════════ */
const GAS_URL='https://script.google.com/macros/s/AKfycbzFUCJ79JXodkV9J0YXqT-uudzzErXZJkZsExFxa_yqCyQyYl0KLT0TA6IWZP1DPTQo/exec';
const COLORS=['#ef4444','#f97316','#f59e0b','#10b981','#06b6d4','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#84cc16','#6b7280','#1a1a1f'];

/* ══════════════════════════════════════════
   STATE
══════════════════════════════════════════ */
const now=new Date();
const state={
  user:null, users:[], theme:localStorage.getItem('bbn-theme')||'auto',
  transactions:[], categories:[], budgets:[], sources:[], summary:null,
  trips:[], activeTrip:null,
  txnType:'expense', txnAmount:'', txnCat:'', txnSource:'',
  catFilter:'expense', selectedColor:COLORS[0],
  currentMonth:now.getMonth()+1, currentYear:now.getFullYear(),
  txnMonth:now.getMonth()+1, txnYear:now.getFullYear(),
  anaMonth:now.getMonth()+1, anaYear:now.getFullYear(),
  txnFilter:'all',
  isSaving:false, // prevent double-submit
};

/* ══════════════════════════════════════════
   HELPERS
══════════════════════════════════════════ */
function todayStr(){return new Date().toISOString().split('T')[0];}
function fmt(n,sign=false){const s=Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:2});return (sign&&n>0?'+':'')+(n<0?'-':'')+'$'+s;}
function monthName(m,y){return new Date(y,m-1,1).toLocaleDateString('en-US',{month:'short',year:'numeric'});}
function greeting(){const h=new Date().getHours();return h<12?'Good morning':h<17?'Good afternoon':'Good evening';}
function getCat(name,type){return state.categories.find(c=>c.name===name&&c.type===type)||{name,color:'#888',type};}

/* ══════════════════════════════════════════
   TOAST
══════════════════════════════════════════ */
function toast(msg,type=''){
  const el=document.createElement('div');
  el.className='toast'+(type?' '+type:'');
  el.textContent=msg;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>el.remove(),2500);
}

/* ══════════════════════════════════════════
   CONFIRM
══════════════════════════════════════════ */
function confirmDlg(title,msg,okLabel='Delete'){
  return new Promise(res=>{
    document.getElementById('confirm-title').textContent=title;
    document.getElementById('confirm-msg').textContent=msg;
    document.getElementById('confirm-ok').textContent=okLabel;
    const ov=document.getElementById('confirm-overlay');
    ov.classList.add('open');
    const ok=document.getElementById('confirm-ok');
    const ca=document.getElementById('confirm-cancel');
    const bd=document.getElementById('confirm-backdrop');
    const done=(v)=>{ov.classList.remove('open');ok.onclick=null;ca.onclick=null;bd.onclick=null;res(v);};
    ok.onclick=()=>done(true);
    ca.onclick=()=>done(false);
    bd.onclick=()=>done(false);
  });
}

/* ══════════════════════════════════════════
   MODALS
══════════════════════════════════════════ */
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}
['add-txn','add-source','budget','add-cat','add-trip'].forEach(id=>{
  document.getElementById(id+'-backdrop')?.addEventListener('click',()=>closeModal(id+'-modal'));
  document.getElementById(id+'-close')?.addEventListener('click',()=>closeModal(id+'-modal'));
});

/* ══════════════════════════════════════════
   THEME
══════════════════════════════════════════ */
function applyTheme(){
  const sys=window.matchMedia('(prefers-color-scheme:dark)').matches;
  const dark=state.theme==='dark'||(state.theme==='auto'&&sys);
  document.documentElement.setAttribute('data-theme',dark?'dark':'light');
  document.querySelector('meta[name="theme-color"]').content=dark?'#0c0c0e':'#f7f7f5';
  const sl=document.getElementById('sidebar-theme-label');
  if(sl) sl.textContent=dark?'Light Mode':'Dark Mode';
}
function toggleTheme(){
  const dark=document.documentElement.getAttribute('data-theme')==='dark';
  state.theme=dark?'light':'dark';
  localStorage.setItem('bbn-theme',state.theme);
  applyTheme();
}
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{if(state.theme==='auto')applyTheme();});
document.getElementById('theme-toggle-home').addEventListener('click',toggleTheme);
document.getElementById('dark-mode-toggle').addEventListener('click',toggleTheme);
document.getElementById('sidebar-theme')?.addEventListener('click',toggleTheme);

/* ══════════════════════════════════════════
   API — optimistic UI approach
══════════════════════════════════════════ */
async function api(action,data={}){
  if(!GAS_URL||GAS_URL.includes('YOUR_GOOGLE')) return mockAPI(action,data);
  try{
    const r=await fetch(GAS_URL,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action,data})});
    const txt=await r.text();
    try{return JSON.parse(txt);}
    catch(e){console.error('GAS non-JSON:',txt.slice(0,200));return{success:false,error:'Server error'};}
  }catch(e){console.error('API error:',e);return{success:false,error:e.message};}
}

/* ══════════════════════════════════════════
   MOCK DB (used when no GAS_URL set)
══════════════════════════════════════════ */
const mockDB={
  users:[{userId:'u1',name:'Nan',photoUrl:''}],
  pins:{u1:'1234'},
  transactions:[
    {txnId:'t1',userId:'u1',type:'expense',amount:42.5,category:'Food',description:'Lunch',date:todayStr(),incomeSourceId:'',createdAt:todayStr()},
    {txnId:'t2',userId:'u1',type:'expense',amount:25,category:'Transport',description:'Ride',date:todayStr(),incomeSourceId:'',createdAt:todayStr()},
    {txnId:'t3',userId:'u1',type:'income',amount:3200,category:'Salary',description:'Monthly salary',date:todayStr(),incomeSourceId:'src1',createdAt:todayStr(),isSalary:true},
  ],
  categories:[
    {catId:'cat1',userId:'default',type:'expense',name:'Food',color:'#ef4444'},
    {catId:'cat2',userId:'default',type:'expense',name:'Transport',color:'#3b82f6'},
    {catId:'cat3',userId:'default',type:'expense',name:'Shopping',color:'#f59e0b'},
    {catId:'cat4',userId:'default',type:'expense',name:'Bills',color:'#10b981'},
    {catId:'cat5',userId:'default',type:'expense',name:'Entertainment',color:'#8b5cf6'},
    {catId:'cat6',userId:'default',type:'expense',name:'Health',color:'#ec4899'},
    {catId:'cat7',userId:'default',type:'expense',name:'Travel',color:'#06b6d4'},
    {catId:'cat8',userId:'default',type:'expense',name:'Other',color:'#6b7280'},
    {catId:'cat9',userId:'default',type:'income',name:'Salary',color:'#10b981'},
    {catId:'cat10',userId:'default',type:'income',name:'Freelance',color:'#3b82f6'},
    {catId:'cat11',userId:'default',type:'income',name:'Investment',color:'#8b5cf6'},
    {catId:'cat12',userId:'default',type:'income',name:'Other Income',color:'#14b8a6'},
  ],
  budgets:[
    {budgetId:'b1',userId:'u1',category:'Food',amount:300,period:'monthly',updatedAt:todayStr()},
  ],
  sources:[{sourceId:'src1',userId:'u1',name:'Primary Job',isActive:true}],
  trips:[],
};

function mockAPI(action,data){
  switch(action){
    case 'getUsers':return{success:true,users:mockDB.users.map(u=>({userId:u.userId,name:u.name,photoUrl:u.photoUrl||''}))};
    case 'login':{const u=mockDB.users.find(x=>x.userId===data.userId);if(u&&String(mockDB.pins[data.userId])===String(data.pin))return{success:true,user:u};return{success:false,error:'Invalid PIN'};}
    case 'getTransactions':{
      let t=mockDB.transactions.filter(x=>x.userId===data.userId);
      if(data.month)t=t.filter(x=>new Date(x.date).getMonth()+1===+data.month);
      if(data.year)t=t.filter(x=>new Date(x.date).getFullYear()===+data.year);
      if(data.type)t=t.filter(x=>x.type===data.type);
      if(data.tripId)t=t.filter(x=>x.tripId===data.tripId);
      t.sort((a,b)=>new Date(b.date)-new Date(a.date));
      return{success:true,transactions:t};
    }
    case 'addTransaction':{const t={txnId:'t'+Date.now(),...data,createdAt:new Date().toISOString()};mockDB.transactions.push(t);return{success:true,txnId:t.txnId};}
    case 'deleteTransaction':{const i=mockDB.transactions.findIndex(t=>t.txnId===data.txnId&&t.userId===data.userId);if(i>-1)mockDB.transactions.splice(i,1);return{success:true};}
    case 'getCategories':return{success:true,categories:mockDB.categories.filter(x=>x.userId==='default'||x.userId===data.userId)};
    case 'addCategory':{mockDB.categories.push({catId:'cat_'+Date.now(),...data});return{success:true};}
    case 'deleteCategory':{const i=mockDB.categories.findIndex(c=>c.catId===data.catId);if(i>-1)mockDB.categories.splice(i,1);return{success:true};}
    case 'getBudgets':return{success:true,budgets:mockDB.budgets.filter(b=>b.userId===data.userId)};
    case 'setBudget':{const i=mockDB.budgets.findIndex(b=>b.userId===data.userId&&b.category===data.category);if(i>-1)mockDB.budgets[i]={...mockDB.budgets[i],amount:data.amount};else mockDB.budgets.push({budgetId:'b'+Date.now(),...data,updatedAt:todayStr()});return{success:true};}
    case 'getIncomeSources':return{success:true,sources:mockDB.sources.filter(s=>s.userId===data.userId&&s.isActive)};
    case 'addIncomeSource':{const s={sourceId:'src'+Date.now(),...data,isActive:true};mockDB.sources.push(s);return{success:true,sourceId:s.sourceId};}
    case 'deleteIncomeSource':{const s=mockDB.sources.find(x=>x.sourceId===data.sourceId&&x.userId===data.userId);if(s)s.isActive=false;return{success:true};}
    case 'getTrips':return{success:true,trips:mockDB.trips.filter(t=>t.userId===data.userId)};
    case 'addTrip':{const t={tripId:'trip'+Date.now(),...data,createdAt:new Date().toISOString(),isActive:true};mockDB.trips.push(t);return{success:true,tripId:t.tripId};}
    case 'endTrip':{const t=mockDB.trips.find(x=>x.tripId===data.tripId);if(t){t.isActive=false;t.endDate=data.endDate||todayStr();}return{success:true};}
    case 'updateUserPhoto':{const u=mockDB.users.find(x=>x.userId===data.userId);if(u)u.photoUrl=data.photoUrl;return{success:true};}
    case 'getSummary':{
      const m=data.month||now.getMonth()+1;
      const y=data.year||now.getFullYear();
      const all=mockDB.transactions.filter(t=>t.userId===data.userId);
      const cur=all.filter(t=>{const d=new Date(t.date);return d.getMonth()+1===+m&&d.getFullYear()===+y;});
      let inc=0,exp=0;const ec={},ic={};
      cur.forEach(t=>{if(t.type==='income'){inc+=t.amount;ic[t.category]=(ic[t.category]||0)+t.amount;}else{exp+=t.amount;ec[t.category]=(ec[t.category]||0)+t.amount;}});
      const daily={};const td=new Date();
      for(let i=6;i>=0;i--){const d=new Date(td);d.setDate(d.getDate()-i);daily[d.toISOString().split('T')[0]]=0;}
      all.forEach(t=>{const k=new Date(t.date).toISOString().split('T')[0];if(k in daily&&t.type==='expense')daily[k]+=t.amount;});
      const pm=m===1?12:m-1;const py=m===1?y-1:y;
      let prevExp=0;all.forEach(t=>{const d=new Date(t.date);if(d.getMonth()+1===pm&&d.getFullYear()===py&&t.type==='expense')prevExp+=t.amount;});
      // find last salary for cycle
      const salaries=all.filter(t=>t.isSalary||t.category==='Salary').sort((a,b)=>new Date(b.date)-new Date(a.date));
      const lastSalary=salaries[0]||null;
      return{success:true,summary:{month:m,year:y,totalIncome:inc,totalExpense:exp,balance:inc-exp,expenseByCategory:ec,incomeByCategory:ic,dailySpending:daily,prevMonthExpense:prevExp,recentTransactions:all.sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5),lastSalaryDate:lastSalary?.date||null,lastSalaryAmount:lastSalary?.amount||0}};
    }
    default:return{success:false,error:'Unknown action'};
  }
}

/* ══════════════════════════════════════════
   SIDEBAR + SCREEN NAV
══════════════════════════════════════════ */
function showSidebar(show){
  const sb=document.getElementById('sidebar');
  sb.style.display=(show&&window.innerWidth>=960)?'flex':'none';
}
function showNav(show){
  const nav=document.getElementById('bottom-nav');
  if(show) nav.classList.remove('hidden');
  else nav.classList.add('hidden');
}
window.addEventListener('resize',()=>{if(state.user){showSidebar(true);}});

function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
}

function navTo(screen){
  // update nav pills
  document.querySelectorAll('.nav-pill').forEach(p=>{p.classList.toggle('active',p.dataset.screen===screen);});
  // update sidebar
  document.querySelectorAll('.sidebar-item[data-screen]').forEach(p=>{p.classList.toggle('active',p.dataset.screen===screen);});
  showScreen(screen+'-screen');
  if(screen==='transactions') loadTransactions();
  else if(screen==='analytics') loadAnalytics();
  else if(screen==='trips') loadTrips();
  else if(screen==='more') renderMore();
}

document.querySelectorAll('.nav-pill').forEach(p=>p.addEventListener('click',()=>navTo(p.dataset.screen)));
document.querySelectorAll('.sidebar-item[data-screen]').forEach(p=>p.addEventListener('click',()=>navTo(p.dataset.screen)));

/* ══════════════════════════════════════════
   LOGIN
══════════════════════════════════════════ */
let pinBuffer='', selectedUser=null;

async function initLogin(){
  const r=await api('getUsers');
  if(r.success){state.users=r.users;renderUserList();}
}

function renderUserList(){
  const el=document.getElementById('user-list');
  if(!state.users.length){
    el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg><p>No users found.</p></div>';
    return;
  }
  el.innerHTML=state.users.map(u=>`
    <div class="user-card" data-uid="${u.userId}">
      <div class="uav">${u.photoUrl?`<img src="${u.photoUrl}" onerror="this.style.display='none'">`:'<svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--text2);stroke-width:1.8;fill:none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'}</div>
      <div class="uname">${u.name}</div>
    </div>
  `).join('');
  el.querySelectorAll('.user-card').forEach(c=>{
    c.addEventListener('click',()=>{
      selectedUser=state.users.find(u=>u.userId===c.dataset.uid);
      document.getElementById('pin-user-name').textContent=selectedUser.name;
      document.getElementById('step-select').style.display='none';
      document.getElementById('step-pin').style.display='block';
      pinBuffer=''; updatePinDots();
    });
  });
}

function updatePinDots(){
  for(let i=0;i<4;i++){
    document.getElementById('pd'+i)?.classList.toggle('filled',i<pinBuffer.length);
  }
}

document.querySelectorAll('#step-pin .numpad-btn[data-n]').forEach(b=>{
  b.addEventListener('click',async()=>{
    if(pinBuffer.length>=4) return;
    pinBuffer+=b.dataset.n;
    updatePinDots();
    if(pinBuffer.length===4){
      const r=await api('login',{userId:selectedUser.userId,pin:pinBuffer});
      if(r.success){
        state.user=r.user;
        localStorage.setItem('bbn-user',JSON.stringify(r.user));
        afterLogin();
      } else {
        document.querySelectorAll('.pin-dot').forEach(d=>d.classList.add('error'));
        setTimeout(()=>{document.querySelectorAll('.pin-dot').forEach(d=>{d.classList.remove('error');d.classList.remove('filled');});pinBuffer='';},800);
      }
    }
  });
});
document.getElementById('pin-delete').addEventListener('click',()=>{pinBuffer=pinBuffer.slice(0,-1);updatePinDots();});
document.getElementById('pin-back').addEventListener('click',()=>{
  document.getElementById('step-select').style.display='block';
  document.getElementById('step-pin').style.display='none';
  pinBuffer='';
});

/* ══════════════════════════════════════════
   AFTER LOGIN
══════════════════════════════════════════ */
function afterLogin(){
  showSidebar(true);
  showNav(true);
  document.getElementById('fab').style.display='flex';
  showScreen('home-screen');
  document.getElementById('greeting-time').textContent=greeting();
  document.getElementById('home-username-display').textContent=state.user.name;
  // Load from cache immediately
  const cached=localStorage.getItem('bbn-data-'+state.user.userId);
  if(cached){try{const d=JSON.parse(cached);if(d.categories)state.categories=d.categories;if(d.sources)state.sources=d.sources;if(d.budgets)state.budgets=d.budgets;if(d.trips)state.trips=d.trips;if(d.transactions)state.transactions=d.transactions;}catch(e){}}
  // Render home immediately with cached/mock data then sync
  refreshHome();
  syncInBackground();
}

async function syncInBackground(){
  if(!state.user) return;
  const uid=state.user.userId;
  const [rc,rs,rb,rt,rtxn]=await Promise.all([
    api('getCategories',{userId:uid}),
    api('getIncomeSources',{userId:uid}),
    api('getBudgets',{userId:uid}),
    api('getTrips',{userId:uid}),
    api('getTransactions',{userId:uid}),
  ]);
  if(rc.success)state.categories=rc.categories;
  if(rs.success)state.sources=rs.sources;
  if(rb.success)state.budgets=rb.budgets;
  if(rt.success)state.trips=rt.trips;
  if(rtxn.success)state.transactions=rtxn.transactions;
  saveCache();
  refreshCurrentScreen();
}

async function forceSync(){
  const btn=document.getElementById('sync-btn');
  if(btn) btn.classList.add('syncing');
  await syncInBackground();
  if(btn) btn.classList.remove('syncing');
  toast('Synced ✓','success');
}

function refreshCurrentScreen(){
  const active=document.querySelector('.screen.active')?.id;
  if(active==='home-screen') renderHomeFromTransactions(state.transactions);
  else if(active==='analytics-screen') loadAnalytics();
  else if(active==='trips-screen') loadTrips();
  else if(active==='transactions-screen') renderTxnList(state.transactions);
}

document.getElementById('sync-btn').addEventListener('click',forceSync);

function saveCache(){
  if(!state.user) return;
  localStorage.setItem('bbn-data-'+state.user.userId,JSON.stringify({categories:state.categories,sources:state.sources,budgets:state.budgets,trips:state.trips,transactions:state.transactions.slice(0,200)}));
}

/* ══════════════════════════════════════════
   HOME
══════════════════════════════════════════ */
async function refreshHome(){
  // Render cached immediately
  if(state.transactions.length) renderHomeFromTransactions(state.transactions);
  // Background fetch summary
  const r=await api('getSummary',{userId:state.user.userId,month:state.currentMonth,year:state.currentYear});
  if(!r.success) return;
  const s=r.summary;
  state.summary=s;
  renderHomeFromSummary(s);
}

function dateStr(v){return String(v).split('T')[0];}
function safeDate(v){return new Date(dateStr(v)+'T00:00');}

function renderHomeFromTransactions(txns){
  // Compute cycle from last salary
  const allSalaries=txns.filter(t=>t.isSalary||t.category==='Salary').sort((a,b)=>safeDate(b.date)-safeDate(a.date));
  const lastSalary=allSalaries[0]||null;
  if(lastSalary){
    const cycleStart=safeDate(lastSalary.date);
    const cycleTxns=txns.filter(t=>safeDate(t.date)>=cycleStart);
    const inc=cycleTxns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const exp=cycleTxns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    document.getElementById('hero-balance').textContent=fmt(inc-exp).replace('$','');
    document.getElementById('hero-income').textContent=fmt(inc);
    document.getElementById('hero-expense').textContent=fmt(exp);
    const d=safeDate(lastSalary.date);
    document.getElementById('cycle-label').textContent='Since '+d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    document.getElementById('cycle-badge').style.display='flex';
    document.getElementById('cycle-badge-text').textContent='Cycle '+d.toLocaleDateString('en-US',{month:'short',day:'numeric'})+' · '+fmt(lastSalary.amount);
  } else {
    const m=state.currentMonth, y=state.currentYear;
    const cur=txns.filter(t=>{const d=new Date(t.date);return(d.getMonth()+1)===m&&d.getFullYear()===y;});
    const inc=cur.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
    const exp=cur.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    document.getElementById('hero-balance').textContent=fmt(inc-exp).replace('$','');
    document.getElementById('hero-income').textContent=fmt(inc);
    document.getElementById('hero-expense').textContent=fmt(exp);
    document.getElementById('cycle-label').textContent='Balance';
    document.getElementById('cycle-badge').style.display='none';
  }
  document.getElementById('hero-period-label').textContent=monthName(state.currentMonth,state.currentYear);
  // mini chart from state
  const daily={};const td=new Date();
  for(let i=6;i>=0;i--){const d=new Date(td);d.setDate(d.getDate()-i);daily[d.toISOString().split('T')[0]]=0;}
  txns.forEach(t=>{const k=dateStr(t.date);if(k in daily&&t.type==='expense')daily[k]+=t.amount;});
  renderMiniChart(daily);
  // recent
  const recent=[...txns].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  renderRecentTxns(recent);
}

function renderHomeFromSummary(s){
  // Recalculate cycle from full transaction list (use state.transactions which is now synced)
  renderHomeFromTransactions(state.transactions.length ? state.transactions : s.recentTransactions);
}

function renderMiniChart(daily){
  const keys=Object.keys(daily);const vals=keys.map(k=>daily[k]);
  const max=Math.max(...vals,1);
  document.getElementById('chart-total').textContent=fmt(vals.reduce((a,b)=>a+b,0));
  document.getElementById('mini-chart').innerHTML=keys.map((k,i)=>{
    const h=Math.max((vals[i]/max)*52,2);
    const day=new Date(k+'T00:00').toLocaleDateString('en-US',{weekday:'short'}).slice(0,2);
    const isToday=k===todayStr();
    return`<div class="chart-col"><div class="chart-bar${isToday?' active':''}" style="height:${h}px"></div><div class="chart-bar-label">${day}</div></div>`;
  }).join('');
}

function renderRecentTxns(txns){
  const el=document.getElementById('recent-txn-list');
  if(!txns||!txns.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg><p>No transactions yet</p></div>';return;}
  el.innerHTML='<div class="txn-list">'+txns.map(t=>txnHtml(t)).join('')+'</div>';
  el.querySelectorAll('.txn-item').forEach(item=>{item.addEventListener('click',()=>handleDeleteTxn(item.dataset.id,item));});
}

/* ══════════════════════════════════════════
   TXN HTML
══════════════════════════════════════════ */
function txnHtml(t){
  const cat=getCat(t.category,t.type);
  // expense = arrow up (↑), income = arrow down (↓)
  const icon=t.type==='expense'
    ?`<svg viewBox="0 0 24 24"><polyline points="17 11 12 6 7 11"/><line x1="12" y1="6" x2="12" y2="18"/></svg>`
    :`<svg viewBox="0 0 24 24"><polyline points="7 13 12 18 17 13"/><line x1="12" y1="6" x2="12" y2="18"/></svg>`;
  const d=safeDate(t.date);
  const dateStr2=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  const salaryBadge=t.isSalary?'<span style="font-size:9px;background:var(--green-bg);color:var(--green);padding:1px 5px;border-radius:8px;font-weight:700;margin-left:4px">SALARY</span>':'';
  const tripBadge=t.tripId?'<span style="font-size:9px;background:var(--purple-bg);color:var(--purple);padding:1px 5px;border-radius:8px;font-weight:700;margin-left:4px">TRIP</span>':'';
  return`<div class="txn-item" data-id="${t.txnId}">
    <div class="txn-icon" style="background:${cat.color}20">${icon.replace('svg ','svg style="stroke:'+cat.color+'" ')}</div>
    <div class="txn-info">
      <div class="txn-name">${t.description||t.category}${salaryBadge}${tripBadge}</div>
      <div class="txn-meta">${t.category} · ${dateStr2}</div>
    </div>
    <div class="txn-amount ${t.type}">${t.type==='expense'?'-':'+'}${fmt(t.amount)}</div>
  </div>`;
}

/* ══════════════════════════════════════════
   DELETE TXN — optimistic
══════════════════════════════════════════ */
async function handleDeleteTxn(txnId,el){
  const ok=await confirmDlg('Delete transaction','This will be removed permanently.');
  if(!ok) return;
  // Optimistic: remove from UI & state immediately
  if(el){el.style.transition='opacity .15s,transform .15s';el.style.opacity='0';el.style.transform='translateX(20px)';setTimeout(()=>el.remove(),150);}
  state.transactions=state.transactions.filter(t=>t.txnId!==txnId);
  saveCache();
  // Update home balance in background without reloading whole screen
  const active=document.querySelector('.screen.active')?.id;
  if(active==='home-screen') renderHomeFromTransactions(state.transactions);
  // Background delete
  api('deleteTransaction',{txnId,userId:state.user.userId});
}

/* ══════════════════════════════════════════
   ADD TRANSACTION — optimistic
══════════════════════════════════════════ */
function openAddTxnModal(type='expense',tripId=null){
  state.txnType=type; state.txnAmount=''; state.txnCat=''; state.txnSource='';
  state.currentTripId=tripId||null;
  document.getElementById('txn-amount-display').textContent='0';
  document.getElementById('txn-desc').value='';
  document.getElementById('txn-date').value=todayStr();
  document.getElementById('add-txn-title').textContent=tripId?'Add Trip Expense':'Add Transaction';
  renderTypeToggle();
  renderCatGrid();
  renderSourceSelect();
  openModal('add-txn-modal');
}

function renderTypeToggle(){
  const exp=document.getElementById('type-expense');
  const inc=document.getElementById('type-income');
  const isExp=state.txnType==='expense';
  exp.classList.toggle('active',isExp);
  inc.classList.toggle('active',!isExp);
  document.getElementById('source-group').style.display=isExp?'none':'block';
  // if tripId, lock to expense
  if(state.currentTripId){exp.classList.add('active');inc.classList.remove('active');inc.style.opacity='.3';inc.style.pointerEvents='none';}
  else{inc.style.opacity='';inc.style.pointerEvents='';}
  renderCatGrid();
}

document.getElementById('type-expense').addEventListener('click',()=>{state.txnType='expense';renderTypeToggle();});
document.getElementById('type-income').addEventListener('click',()=>{if(!state.currentTripId){state.txnType='income';renderTypeToggle();}});

function renderCatGrid(){
  const cats=state.categories.filter(c=>c.type===state.txnType);
  document.getElementById('txn-cat-grid').innerHTML=cats.map(c=>`
    <div class="cat-item-btn${state.txnCat===c.name?' selected':''}" data-cat="${c.name}">
      <div class="cat-dot-lg" style="background:${c.color}"></div>
      <span>${c.name}</span>
    </div>
  `).join('');
  document.querySelectorAll('#txn-cat-grid .cat-item-btn').forEach(b=>{
    b.addEventListener('click',()=>{state.txnCat=b.dataset.cat;renderCatGrid();});
  });
}

function renderSourceSelect(){
  const sel=document.getElementById('txn-source');
  sel.innerHTML='<option value="">No source</option>'+state.sources.filter(s=>s.userId===state.user.userId||s.userId).map(s=>`<option value="${s.sourceId}">${s.name}</option>`).join('');
}

// Numpad
document.getElementById('txn-numpad').querySelectorAll('.numpad-btn[data-n]').forEach(b=>{
  b.addEventListener('click',()=>{
    const n=b.dataset.n;
    if(n==='.'&&state.txnAmount.includes('.')) return;
    if(state.txnAmount.length>=10) return;
    if(n==='0'&&state.txnAmount==='') return;
    state.txnAmount+=n;
    document.getElementById('txn-amount-display').textContent=state.txnAmount||'0';
  });
});
document.getElementById('txn-delete-btn').addEventListener('click',()=>{
  state.txnAmount=state.txnAmount.slice(0,-1);
  document.getElementById('txn-amount-display').textContent=state.txnAmount||'0';
});

document.getElementById('save-txn-btn').addEventListener('click',async()=>{
  if(state.isSaving) return;
  const amount=parseFloat(state.txnAmount);
  if(!amount||amount<=0){toast('Enter an amount','error');return;}
  if(!state.txnCat){toast('Select a category','error');return;}
  state.isSaving=true;
  const btn=document.getElementById('save-txn-btn');
  btn.disabled=true; btn.textContent='Saving…';

  const txnData={
    userId:state.user.userId, type:state.txnType, amount, category:state.txnCat,
    description:document.getElementById('txn-desc').value.trim(),
    date:document.getElementById('txn-date').value||todayStr(),
    incomeSourceId:document.getElementById('txn-source').value||'',
    isSalary:state.txnType==='income'&&state.txnCat==='Salary',
    tripId:state.currentTripId||'',
  };

  // Optimistic: close modal & update UI immediately
  closeModal('add-txn-modal');
  toast('Saved ✓','success');
  const tmpId='tmp'+Date.now();
  const optimisticTxn={...txnData,txnId:tmpId,createdAt:new Date().toISOString()};
  state.transactions.unshift(optimisticTxn);
  saveCache();
  const active=document.querySelector('.screen.active')?.id;
  if(active==='home-screen') renderHomeFromTransactions(state.transactions);
  else if(active==='transactions-screen') renderTxnList(state.transactions);
  else if(active==='trip-detail-screen') loadTripDetail(state.activeTrip);

  // Background save - replace tmp id with real one
  const r=await api('addTransaction',txnData);
  if(r.success){
    const idx=state.transactions.findIndex(t=>t.txnId===tmpId);
    if(idx>-1) state.transactions[idx].txnId=r.txnId;
    saveCache();
  }
  state.isSaving=false;
  btn.disabled=false; btn.textContent='Add Transaction';
});

/* ══════════════════════════════════════════
   MONTH NAV
══════════════════════════════════════════ */
document.getElementById('hero-period-btn').addEventListener('click',()=>{state.currentMonth--;if(state.currentMonth<1){state.currentMonth=12;state.currentYear--;}refreshHome();});
document.getElementById('txn-prev-month').addEventListener('click',()=>{state.txnMonth--;if(state.txnMonth<1){state.txnMonth=12;state.txnYear--;}loadTransactions();});
document.getElementById('txn-next-month').addEventListener('click',()=>{state.txnMonth++;if(state.txnMonth>12){state.txnMonth=1;state.txnYear++;}loadTransactions();});
document.getElementById('ana-prev-month').addEventListener('click',()=>{state.anaMonth--;if(state.anaMonth<1){state.anaMonth=12;state.anaYear--;}loadAnalytics();});
document.getElementById('ana-next-month').addEventListener('click',()=>{state.anaMonth++;if(state.anaMonth>12){state.anaMonth=1;state.anaYear++;}loadAnalytics();});

/* ══════════════════════════════════════════
   TRANSACTIONS SCREEN
══════════════════════════════════════════ */
function renderTxnList(txns){
  document.getElementById('txn-month-label').textContent=monthName(state.txnMonth,state.txnYear);
  let filtered=txns.filter(t=>{const d=new Date(t.date);return(d.getMonth()+1)===state.txnMonth&&d.getFullYear()===state.txnYear;});
  if(state.txnFilter!=='all') filtered=filtered.filter(t=>t.type===state.txnFilter);
  const el=document.getElementById('txn-list');
  if(!filtered.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg><p>No transactions</p></div>';return;}
  el.innerHTML=filtered.map(t=>txnHtml(t)).join('');
  el.querySelectorAll('.txn-item').forEach(item=>{item.addEventListener('click',()=>handleDeleteTxn(item.dataset.id,item));});
}

async function loadTransactions(){
  // Render from cache immediately (instant)
  renderTxnList(state.transactions);
  // Fetch in background
  const r=await api('getTransactions',{userId:state.user.userId,month:state.txnMonth,year:state.txnYear});
  if(!r.success) return;
  // Merge fetched into state (replace same month+year)
  const fetched=r.transactions;
  const others=state.transactions.filter(t=>{const d=new Date(t.date);return!((d.getMonth()+1)===state.txnMonth&&d.getFullYear()===state.txnYear);});
  state.transactions=[...fetched,...others];
  saveCache();
  renderTxnList(state.transactions);
}

document.getElementById('txn-filter-row').querySelectorAll('.filter-chip').forEach(c=>{
  c.addEventListener('click',()=>{
    document.getElementById('txn-filter-row').querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); state.txnFilter=c.dataset.ttype; loadTransactions();
  });
});

/* ══════════════════════════════════════════
   ANALYTICS
══════════════════════════════════════════ */
async function loadAnalytics(){
  // Render from cached summary first if available
  if(state.summary) renderAnalytics(state.summary);
  const r=await api('getSummary',{userId:state.user.userId,month:state.anaMonth,year:state.anaYear});
  if(!r.success) return;
  state.summary=r.summary;
  renderAnalytics(r.summary);
}

function renderAnalytics(s){
  document.getElementById('ana-month-label').textContent=monthName(state.anaMonth,state.anaYear);
  document.getElementById('ana-income').textContent=fmt(s.totalIncome);
  document.getElementById('ana-expense').textContent=fmt(s.totalExpense);
  document.getElementById('ana-balance').textContent=fmt(s.balance);
  document.getElementById('ana-balance').className='ac-value '+(s.balance>=0?'green':'red');
  if(s.prevMonthExpense){
    const diff=((s.totalExpense-s.prevMonthExpense)/s.prevMonthExpense*100).toFixed(1);
    document.getElementById('ana-vsmonth').textContent=fmt(s.totalExpense-s.prevMonthExpense,true);
    document.getElementById('ana-vsmonth').className='ac-value '+(+diff<=0?'green':'red');
    document.getElementById('ana-vsmonth-label').textContent=`${diff>0?'+':''}${diff}% vs last month`;
  }
  renderDonut(s.expenseByCategory);
  renderBudgets(s.expenseByCategory);
}

function renderDonut(expCat){
  const entries=Object.entries(expCat).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const total=entries.reduce((s,[,v])=>s+v,0);
  const svg=document.getElementById('donut-svg');
  const legend=document.getElementById('donut-legend');
  if(!total){svg.innerHTML='<circle cx="50" cy="50" r="36" fill="none" stroke="var(--border)" stroke-width="12"/>';legend.innerHTML='<div style="font-size:12px;color:var(--text3)">No expense data</div>';return;}
  let arcs='<circle cx="50" cy="50" r="36" fill="none" stroke="var(--border)" stroke-width="12"/>';
  let cum=0; const circ=2*Math.PI*36; legend.innerHTML='';
  entries.forEach(([name,val])=>{
    const cat=getCat(name,'expense');
    const pct=val/total; const dash=pct*circ; const gap=circ-dash;
    const rot=cum*360-90;
    arcs+=`<circle cx="50" cy="50" r="36" fill="none" stroke="${cat.color}" stroke-width="12" stroke-dasharray="${dash} ${gap}" transform="rotate(${rot} 50 50)" style="transition:stroke-dasharray .5s"/>`;
    cum+=pct;
    legend.innerHTML+=`<div class="legend-item"><div class="legend-dot" style="background:${cat.color}"></div><span class="legend-name">${name}</span><span class="legend-pct">${(pct*100).toFixed(0)}%</span></div>`;
  });
  svg.innerHTML=arcs;
}

function renderBudgets(expCat){
  const el=document.getElementById('budget-list');
  if(!state.budgets.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><p>No budgets set</p></div>';return;}
  el.innerHTML=state.budgets.filter(b=>b.userId===state.user.userId).map(b=>{
    const spent=expCat[b.category]||0; const pct=Math.min((spent/b.amount)*100,100);
    const color=pct>=100?'var(--red)':pct>=75?'var(--amber)':'var(--green)';
    return`<div class="budget-item">
      <div class="budget-row"><div class="budget-name">${b.category}</div><div class="budget-amounts">${fmt(spent)} / ${fmt(b.amount)}</div></div>
      <div class="budget-bar-bg"><div class="budget-bar-fill" style="width:${pct}%;background:${color}"></div></div>
    </div>`;
  }).join('');
}

/* ══════════════════════════════════════════
   BUDGET MODAL
══════════════════════════════════════════ */
function openBudgetModal(){
  const sel=document.getElementById('budget-cat');
  sel.innerHTML=state.categories.filter(c=>c.type==='expense').map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
  document.getElementById('budget-amount').value='';
  openModal('budget-modal');
}
document.getElementById('save-budget-btn').addEventListener('click',async()=>{
  const cat=document.getElementById('budget-cat').value;
  const amount=parseFloat(document.getElementById('budget-amount').value);
  if(!amount||amount<=0){toast('Enter a valid amount','error');return;}
  closeModal('budget-modal');
  const i=state.budgets.findIndex(b=>b.userId===state.user.userId&&b.category===cat);
  if(i>-1) state.budgets[i].amount=amount;
  else state.budgets.push({budgetId:'tmp'+Date.now(),userId:state.user.userId,category:cat,amount,period:'monthly'});
  toast('Budget saved','success');
  await api('setBudget',{userId:state.user.userId,category:cat,amount,period:'monthly'});
});

/* ══════════════════════════════════════════
   TRIPS
══════════════════════════════════════════ */
function loadTrips(){
  renderTrips();
}

function renderTrips(){
  const el=document.getElementById('trips-list');
  if(!state.trips.length){
    el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><p>No trips yet.<br>Create your first trip!</p></div>';
    // show fab for mobile
    document.getElementById('fab').style.display='flex';
    document.getElementById('fab').onclick=()=>openModal('add-trip-modal');
    return;
  }
  el.innerHTML=state.trips.map(t=>{
    const spent=t.spent||0; const pct=t.budget?Math.min((spent/t.budget)*100,100):0;
    const start=t.startDate?safeDate(t.startDate).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';
    const end=t.endDate?safeDate(t.endDate).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'ongoing';
    return`<div class="trip-card" data-tid="${t.tripId}">
      <div class="trip-card-header">
        <div class="trip-card-icon"><svg viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>
        <div class="trip-card-name">${t.name}</div>
        <div class="trip-status ${t.isActive?'active':'ended'}">${t.isActive?'Active':'Ended'}</div>
      </div>
      <div class="trip-dates">${start} → ${end}</div>
      ${t.budget?`
        <div class="trip-progress-row">
          <div class="trip-spent">${fmt(spent)} spent</div>
          <div class="trip-budget">of ${fmt(t.budget)}</div>
        </div>
        <div class="trip-bar-bg"><div class="trip-bar-fill" style="width:${pct}%"></div></div>
      `:''}
    </div>`;
  }).join('');
  el.querySelectorAll('.trip-card').forEach(c=>{
    c.addEventListener('click',()=>{
      const trip=state.trips.find(t=>t.tripId===c.dataset.tid);
      if(trip) openTripDetail(trip);
    });
  });
  // fab for new trip
  document.getElementById('fab').style.display='flex';
  document.getElementById('fab').onclick=()=>openModal('add-trip-modal');
}

async function openTripDetail(trip){
  state.activeTrip=trip;
  showScreen('trip-detail-screen');
  document.getElementById('trip-detail-title').textContent=trip.name;
  document.getElementById('trip-end-btn').style.display=trip.isActive?'flex':'none';
  loadTripDetail(trip);
}

async function loadTripDetail(trip){
  document.getElementById('tdh-name').textContent=trip.name;
  const s=trip.startDate?safeDate(trip.startDate).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'';
  const e=trip.endDate?safeDate(trip.endDate).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'ongoing';
  document.getElementById('tdh-dates').textContent=`${s} → ${e}`;
  const r=await api('getTransactions',{userId:state.user.userId,tripId:trip.tripId});
  let spent=0;
  if(r.success){
    spent=r.transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
    const el=document.getElementById('trip-txn-list');
    if(!r.transactions.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg><p>No spending yet</p></div>';
    } else {
      el.innerHTML=r.transactions.map(t=>txnHtml(t)).join('');
      el.querySelectorAll('.txn-item').forEach(item=>{item.addEventListener('click',()=>handleDeleteTxn(item.dataset.id,item));});
    }
  }
  // update trip spent in state
  const idx=state.trips.findIndex(t=>t.tripId===trip.tripId);
  if(idx>-1) state.trips[idx].spent=spent;
  document.getElementById('tdh-spent').textContent=fmt(spent);
  document.getElementById('tdh-budget').textContent=trip.budget?fmt(trip.budget):'No limit';
  const rem=trip.budget?trip.budget-spent:null;
  document.getElementById('tdh-balance').textContent=rem!==null?fmt(rem):'—';
}

document.getElementById('trip-detail-back').addEventListener('click',()=>{navTo('trips');});
document.getElementById('trip-end-btn').addEventListener('click',async()=>{
  const ok=await confirmDlg('End Trip?','This will mark the trip as ended. You can still view its transactions.','End Trip');
  if(!ok) return;
  const trip=state.activeTrip;
  trip.isActive=false; trip.endDate=todayStr();
  document.getElementById('trip-end-btn').style.display='none';
  toast('Trip ended','success');
  await api('endTrip',{tripId:trip.tripId,userId:state.user.userId,endDate:todayStr()});
  syncInBackground();
});

document.getElementById('trip-add-expense-btn').addEventListener('click',()=>{openAddTxnModal('expense',state.activeTrip?.tripId);});

// Save new trip
document.getElementById('save-trip-btn').addEventListener('click',async()=>{
  const name=document.getElementById('trip-name').value.trim();
  const budget=parseFloat(document.getElementById('trip-budget').value)||0;
  const startDate=document.getElementById('trip-start').value||todayStr();
  const endDate=document.getElementById('trip-end').value||'';
  if(!name){toast('Enter a trip name','error');return;}
  closeModal('add-trip-modal');
  const newTrip={tripId:'trip'+Date.now(),userId:state.user.userId,name,budget,startDate,endDate,isActive:true,spent:0};
  state.trips.unshift(newTrip);
  renderTrips();
  toast('Trip created','success');
  const r=await api('addTrip',{userId:state.user.userId,name,budget,startDate,endDate});
  if(r.success){newTrip.tripId=r.tripId;}
  document.getElementById('trip-name').value='';
  document.getElementById('trip-budget').value='';
  document.getElementById('trip-start').value='';
  document.getElementById('trip-end').value='';
  syncInBackground();
});

document.getElementById('desktop-add-trip-btn').addEventListener('click',()=>openModal('add-trip-modal'));
document.getElementById('add-trip-backdrop').addEventListener('click',()=>closeModal('add-trip-modal'));
document.getElementById('add-trip-close').addEventListener('click',()=>closeModal('add-trip-modal'));

/* ══════════════════════════════════════════
   SETTINGS / MORE
══════════════════════════════════════════ */
function renderMore(){
  // profile area
  const u=state.user;
  const pa=document.getElementById('more-profile-area');
  pa.innerHTML=`
    <div style="display:flex;align-items:center;gap:14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;cursor:pointer" id="profile-area-btn">
      <div class="uav" style="width:48px;height:48px;border-radius:50%;background:var(--bg3);overflow:hidden;display:flex;align-items:center;justify-content:center;flex-shrink:0">
        ${u.photoUrl?`<img src="${u.photoUrl}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'">`:'<svg viewBox="0 0 24 24" style="width:22px;height:22px;stroke:var(--text2);stroke-width:1.8;fill:none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'}
      </div>
      <div style="flex:1"><div style="font-size:16px;font-weight:700">${u.name}</div><div style="font-size:12px;color:var(--text3)">Tap to edit profile</div></div>
      <svg viewBox="0 0 24 24" style="width:16px;height:16px;stroke:var(--text3);stroke-width:2;fill:none"><polyline points="9 18 15 12 9 6"/></svg>
    </div>`;
  document.getElementById('profile-area-btn').addEventListener('click',openProfileScreen);

  document.getElementById('more-menu').innerHTML=`
    <div class="menu-item" id="ml-categories">
      <div class="menu-icon"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></div>
      <div class="menu-label">Categories</div>
      <svg class="menu-arrow" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
    </div>
    <div class="menu-item" id="ml-income-sources">
      <div class="menu-icon"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
      <div class="menu-label">Income Sources</div>
      <svg class="menu-arrow" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
    </div>
    <div class="menu-item" id="ml-budgets-more">
      <div class="menu-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div>
      <div class="menu-label">Budgets</div>
      <svg class="menu-arrow" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"/></svg>
    </div>
    <div class="menu-item" id="ml-logout" style="border-color:var(--red-bg)">
      <div class="menu-icon" style="background:var(--red-bg)"><svg viewBox="0 0 24 24" style="stroke:var(--red)"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>
      <div class="menu-label" style="color:var(--red)">Sign Out</div>
    </div>`;
  document.getElementById('ml-categories').addEventListener('click',()=>{showScreen('categories-screen');renderCatList();});
  document.getElementById('ml-income-sources').addEventListener('click',()=>{showScreen('sources-screen');renderSourcesList();});
  document.getElementById('ml-budgets-more').addEventListener('click',openBudgetModal);
  document.getElementById('ml-logout').addEventListener('click',logout);
}

/* ══════════════════════════════════════════
   PROFILE
══════════════════════════════════════════ */
function openProfileScreen(){
  showScreen('profile-screen');
  const u=state.user;
  const wrap=document.getElementById('profile-avatar-wrap');
  wrap.innerHTML=u.photoUrl
    ?`<img class="avatar-img" src="${u.photoUrl}" onerror="this.outerHTML='<div class=\'avatar-fallback\'>${u.name[0].toUpperCase()}</div>'">`
    :`<div class="avatar-fallback">${u.name[0].toUpperCase()}</div>`;
  document.getElementById('profile-name-display').textContent=u.name;
  document.getElementById('profile-sub-display').textContent='User ID: '+u.userId;
  document.getElementById('profile-img-url').value=u.photoUrl||'';
}

document.getElementById('profile-back').addEventListener('click',()=>{showScreen('more-screen');renderMore();});
document.getElementById('save-profile-img').addEventListener('click',async()=>{
  const url=document.getElementById('profile-img-url').value.trim();
  state.user.photoUrl=url;
  localStorage.setItem('bbn-user',JSON.stringify(state.user));
  openProfileScreen();
  toast('Photo saved','success');
  await api('updateUserPhoto',{userId:state.user.userId,photoUrl:url});
});

/* ══════════════════════════════════════════
   SOURCES
══════════════════════════════════════════ */
async function renderSourcesList(){
  const r=await api('getIncomeSources',{userId:state.user.userId});
  if(r.success) state.sources=r.sources;
  const el=document.getElementById('source-list');
  if(!state.sources.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><p>No income sources</p></div>';return;}
  el.innerHTML=state.sources.map(s=>`
    <div class="source-item">
      <div class="source-name">${s.name}</div>
      <button class="is-delete" data-id="${s.sourceId}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>
    </div>`).join('');
  el.querySelectorAll('.is-delete').forEach(b=>{
    b.addEventListener('click',async()=>{
      const ok=await confirmDlg('Delete Source','Remove this income source?');
      if(!ok) return;
      b.closest('.source-item').remove();
      state.sources=state.sources.filter(s=>s.sourceId!==b.dataset.id);
      await api('deleteIncomeSource',{sourceId:b.dataset.id,userId:state.user.userId});
      toast('Removed','success');
    });
  });
}
document.getElementById('sources-back').addEventListener('click',()=>{showScreen('more-screen');renderMore();});
document.getElementById('add-source-btn').addEventListener('click',()=>openModal('add-source-modal'));
document.getElementById('save-source-btn').addEventListener('click',async()=>{
  const name=document.getElementById('source-name').value.trim();
  if(!name){toast('Enter a name','error');return;}
  closeModal('add-source-modal');
  const newSrc={sourceId:'src'+Date.now(),userId:state.user.userId,name,isActive:true};
  state.sources.push(newSrc);
  renderSourcesList();
  document.getElementById('source-name').value='';
  toast('Source added','success');
  await api('addIncomeSource',{userId:state.user.userId,name});
});

/* ══════════════════════════════════════════
   CATEGORIES
══════════════════════════════════════════ */
async function renderCatList(){
  const r=await api('getCategories',{userId:state.user.userId});
  if(r.success) state.categories=r.categories;
  const cats=state.categories.filter(c=>c.type===state.catFilter&&(c.userId==='default'||c.userId===state.user.userId));
  const el=document.getElementById('cat-list');
  if(!cats.length){el.innerHTML='<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><p>No categories</p></div>';return;}
  el.innerHTML=cats.map(c=>`
    <div class="cat-manage-item">
      <div class="cat-dot" style="background:${c.color}"></div>
      <div class="cat-manage-name">${c.name}</div>
      <div class="cat-manage-type">${c.type}</div>
      ${c.userId!=='default'?`<button class="cat-delete" data-id="${c.catId}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>`:''}
    </div>`).join('');
  el.querySelectorAll('.cat-delete').forEach(b=>{
    b.addEventListener('click',async()=>{
      const ok=await confirmDlg('Delete Category','Remove this category?');
      if(!ok) return;
      b.closest('.cat-manage-item').remove();
      state.categories=state.categories.filter(c=>c.catId!==b.dataset.id);
      await api('deleteCategory',{catId:b.dataset.id});
      toast('Removed','success');
    });
  });
}

document.getElementById('categories-back').addEventListener('click',()=>{showScreen('more-screen');renderMore();});
document.getElementById('cat-type-filter').querySelectorAll('.filter-chip').forEach(c=>{
  c.addEventListener('click',()=>{
    document.getElementById('cat-type-filter').querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active'); state.catFilter=c.dataset.ctype; renderCatList();
  });
});
document.getElementById('add-cat-btn').addEventListener('click',()=>{
  const sw=document.getElementById('color-swatches');
  sw.innerHTML=COLORS.map(c=>`<div class="color-swatch${c===state.selectedColor?' selected':''}" data-color="${c}" style="background:${c}"></div>`).join('');
  sw.querySelectorAll('.color-swatch').forEach(s=>{s.addEventListener('click',()=>{sw.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('selected'));s.classList.add('selected');state.selectedColor=s.dataset.color;});});
  openModal('add-cat-modal');
});
document.getElementById('save-cat-btn').addEventListener('click',async()=>{
  const name=document.getElementById('cat-name').value.trim();
  const type=document.getElementById('cat-type-select').value;
  if(!name){toast('Enter a name','error');return;}
  closeModal('add-cat-modal');
  state.categories.push({catId:'cat_'+Date.now(),userId:state.user.userId,type,name,color:state.selectedColor});
  renderCatList();
  document.getElementById('cat-name').value='';
  toast('Category added','success');
  await api('addCategory',{userId:state.user.userId,type,name,color:state.selectedColor});
});

/* ══════════════════════════════════════════
   QUICK ACTIONS
══════════════════════════════════════════ */
document.getElementById('fab').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('desktop-add-btn').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('desktop-add-btn-txn').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('desktop-add-btn-ana').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('qa-add-expense').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('qa-add-income').addEventListener('click',()=>openAddTxnModal('income'));
document.getElementById('qa-budgets').addEventListener('click',openBudgetModal);
document.getElementById('qa-trip').addEventListener('click',()=>navTo('trips'));
document.getElementById('see-all-link').addEventListener('click',()=>navTo('transactions'));
document.getElementById('edit-budgets-link').addEventListener('click',openBudgetModal);
document.getElementById('logout-btn').addEventListener('click',logout);
document.getElementById('sidebar-logout')?.addEventListener('click',logout);

document.getElementById('home-content').addEventListener('scroll',function(){
  document.getElementById('home-header').classList.toggle('scrolled',this.scrollTop>8);
});
document.getElementById('txn-content').addEventListener('scroll',function(){
  document.getElementById('txn-header').classList.toggle('scrolled',this.scrollTop>8);
});

/* ══════════════════════════════════════════
   LOGOUT
══════════════════════════════════════════ */
function logout(){
  state.user=null; state.transactions=[]; state.summary=null; state.trips=[];
  localStorage.removeItem('bbn-user');
  showSidebar(false);
  showNav(false);
  document.getElementById('fab').style.display='none';
  showScreen('login-screen');
  document.getElementById('step-select').style.display='block';
  document.getElementById('step-pin').style.display='none';
  initLogin();
}

/* ══════════════════════════════════════════
   INIT
══════════════════════════════════════════ */
applyTheme();
document.getElementById('txn-date').value=todayStr();

const savedUser=localStorage.getItem('bbn-user');
if(savedUser){
  try{
    state.user=JSON.parse(savedUser);
    showSidebar(true);
    showNav(true);
    document.getElementById('fab').style.display='flex';
    document.getElementById('greeting-time').textContent=greeting();
    document.getElementById('home-username-display').textContent=state.user.name;
    showScreen('home-screen');
    const cached=localStorage.getItem('bbn-data-'+state.user.userId);
    if(cached){try{const d=JSON.parse(cached);if(d.categories)state.categories=d.categories;if(d.sources)state.sources=d.sources;if(d.budgets)state.budgets=d.budgets;if(d.trips)state.trips=d.trips;if(d.transactions)state.transactions=d.transactions;}catch(e){}}
    refreshHome();
    syncInBackground();
  }catch(e){localStorage.removeItem('bbn-user');initLogin();}
} else {
  initLogin();
}

document.getElementById('loading-overlay').classList.add('hidden');
</script>
</body>
</html>
