<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="budgetBynan">
<meta name="theme-color" content="#0c0c0e">
<title>budgetBynan</title>
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAhUlEQVR42mNgwAOkpOT/UwMzkAKoZSlZjqG15XgdQS/LsTqC3pZjOGJkO2CgLIc7YtQB5Gj68OErTkx1B+CzjFhMcQjQyvKhEQXEOoQuiZCaQU/QAdRIfMQ4avCGwKBMAwOWCwa0HBgUJeGgLYiGR3U82iYcFA4Y8I7JoOiaDYrO6UB0zwE6I0WdgSgNlwAAAABJRU5ErkJggg==">
<link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAC7klEQVR42u3cMY6DUBAFwX8OEu5/OxLHICdObckJTJelvsDwSrteaVnrIZ9t2089p+Vj3ILE6AWD0SuNwUNVEoKHqCQED01JCB6SshA8GGUReCBKIvAQlIXg8MoicHBlETi0sggcWFkEDqs0AkdVFoCDKovAIZVF4IBKI3A8ZQE4nNIIHE1ZAA6mNALHUhaAQymNwJGUBeBASiNwHAEgFQE4jNIIHEUASEUADqI0AscQABIAEgASABIAEgASANJMAA6hNAJHEAASABIAEgASABIAEgASABIAEgASABIA+q/jeH1yDwBSg/+WewGQGTsUABg8EAAYOxQAGDwQABg8EAAYOxQAGDwQABg7FAAYPBAAGDsUTQAGBkQGgPFAAYAA8CsQFMYOABAGDwAQBg8AFMYOABAGDwAUxg4AEAYPABTGDgAQBg+Af4oXAF6LIgCGgHA3ALwaUQCUfhq4DwC+C0ABgC+/QABg8EAAYOxQAGDwQABg7FAAYPBAAGDsUABg8EAAYJRQpAAYHBApAAYFRAaAsUDhJwAUxg4AEAYPABAGDwAUxg4AEAYPABTGDgAQBg8AFMYOABAGDwAUxg6At0IIAO8FEgDeDCcAvBtUAHg7tACY9mXYXQHw51AgAPC3fygAMHggADB2KAAweCAAMHYoADB4IKoAjBSKFAADBCIFwMCAyAAwHigAEAB+BYLC2AEAwuABgMLYAQDC4AGAwtgBAMLgAYDC2AEAwuABAMLgAfBP8QLAa1EEwAAU7gWAVyMKAAkACQAJAAkACQAJAAkACQAJAAkACQDpNwDvj0MoO34ABIBjCAAJAAkACQAJAAkAaTYACJQePwACwFFUBgCB0uMHQAA4jsoAIFB6/AAoDwACpccPgPIAIFB6/AAoDwACpccPgPIAIFB6/BAoP34IlB8/AMoDgEDp8UOg/PghUH78ECg/fgiUHz8Iyg8fAhk/BDJ+EGT4IMjwQZDhgyDDh0FGD4OMHhLjvuvnArFmV1QQE2UmAAAAAElFTkSuQmCC">
<!-- Apple touch icon (home screen) -->
<link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAC1klEQVR42u3cwWnDUBRFwVeHN+m/O2+yTkgBwWBI+O/8EZwGrgahSIpnDj4ej48vndc4gAUeYAEOseAGWWCDrDxsJ0gJ1E6KMrCdCGVQOwFKoDa6MrANrQxqAyuD2rBKoTaqMqANqgxqQyqD2oBKoTaeMqANpwxqgymF2ljKgDaUUqiNpAxoAymF2jgCWjoRtGGUQm0UAS0BLf0xaIMohdoYAloCWgJaAlpAS0BLR4E2hFKojSCgJaAloCWgBbQEtAS0BLQEtICWgJaAvqHn8/PX7AP0asCvsh/Qa/FCDvQVgAEHOg0YcKCzeCEH+grAgF8G+ia8kAdBA3s38IFXJeQDsErAB16VkA/AKgEfV2aVrtTj3lmle+nxdEOlpx3j+bNKz6PHG0KAvVgBHGCgIYcXaMABBrqO3HkBejVwuwO9Frk9gV4N3F5Ar0VuB6DTV2k7AZ2+j7Yj0PknHfYGOv0s2vkAOv+20HkDOv09B9AA+1AJaHghBxpgwIGGF/IcaMAAXwsaHshXgwYDcFdoAeweWu6hAQfYUw7I4QUacICBhty3HL6287Ud0IADDDTk8AINOMBA+69vAe13OYCWX04C2tXZVRpovz4qoJuP8OwOdPpFi/MCdP41uPMHtA+SgIYXcqABBhxogAG/BjR8kK8GDRbga0FDA3kCNBhgp285AAE4/0chRPCmH9uBBnD+xQqMd79gGa+8AQYacniBBhxgoCGHF+gqcOcB6NXA7Qz0WuT2A3o1cPsALQEtoCWgJaAloCWgBbQEtAS0BLQEtPKgfw5DKIMZaAEtAS0BLQEtoA0ioKUjQUOtFGagBbQEtPRPoKFWCjPQAlo6GTTUSmEGWjnQUCuFGWjlQEOtFGaolcMMtHKgoVYKM9TKYYZaOcxAKwcaaqUwQ60cZqiVwwy2cpChVhIz1MphBls5yFAriRls5SCDrSRkuJVEDDjADuCBffP4BuI/g5x/MO1FAAAAAElFTkSuQmCC">
<!-- PWA manifest -->
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjogImJ1ZGdldEJ5bmFuIiwgInNob3J0X25hbWUiOiAiYnVkZ2V0QnluYW4iLCAiZGVzY3JpcHRpb24iOiAiUGVyc29uYWwgZmluYW5jZSB0cmFja2VyIiwgInN0YXJ0X3VybCI6ICIuIiwgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwYzBjMGUiLCAidGhlbWVfY29sb3IiOiAiIzBjMGMwZSIsICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdC1wcmltYXJ5IiwgImljb25zIjogW3sic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBTUFBQUFEQUNBWUFBQUJTM0d3SEFBQUM3a2xFUVZSNDJ1M2NNWTZEVUJBRndYOE9FdTUvT3hMSElDZE9iY2tKVEplbHZzRHdTcnRlYVZucklaOXQyMDg5cCtWajNJTEU2QVdEMFN1TndVTlZFb0tIcUNRRUQwMUpDQjZTc2hBOEdHVVJlQ0JLSXZBUWxJWGc4TW9pY0hCbEVUaTBzZ2djV0ZrRURxczBBa2RWRm9DREtvdkFJWlZGNElCS0kzQThaUUU0bk5JSUhFMVpBQTZtTkFMSFVoYUFReW1Od0pHVUJlQkFTaU53SEFFZ0ZRRTRqTklJSEVVQVNFVUFEcUkwQXNjUUFCSUFFZ0FTQUJJQUVnQVNBTkpNQUE2aE5BSkhFQUFTQUJJQUVnQVNBQklBRWdBU0FCSUFFZ0FTQUJJQStxL2plSDF5RHdCU2cvK1dld0dRR1RzVUFCZzhFQUFZT3hRQUdEd1FBQmc4RUFBWU94UUFHRHdRQUJnN0ZBQVlQQkFBR0RzVVRRQUdCa1FHZ1BGQUFZQUE4Q3NRRk1ZT0FCQUdEd0FRQmc4QUZNWU9BQkFHRHdBVXhnNEFFQVlQQUJUR0RnQVFCZytBZjRvWEFGNkxJZ0NHZ0hBM0FMd2FVUUNVZmhxNER3QytDMEFCZ0MrL1FBQmc4RUFBWU94UUFHRHdRQUJnN0ZBQVlQQkFBR0RzVUFCZzhFQUFZSlJRcEFBWUhCQXBBQVlGUkFhQXNVRGhKd0FVeGc0QUVBWVBBQkFHRHdBVXhnNEFFQVlQQUJUR0RnQVFCZzhBRk1ZT0FCQUdEd0FVeGc2QXQwSUlBTzhGRWdEZURDY0F2QnRVQUhnN3RBQ1k5bVhZWFFIdzUxQWdBUEMzZnlnQU1IZ2dBREIyS0FBd2VDQUFNSFlvQURCNElLb0FqQlNLRkFBREJDSUZ3TUNBeUFBd0hpZ0FFQUIrQllMQzJBRUF3dUFCZ01MWUFRREM0QUdBd3RnQkFNTGdBWURDMkFFQXd1QUJBTUxnQWZCUDhRTEFhMUVFd0FBVTdnV0FWeU1LQUFrQUNRQUpBQWtBQ1FBSkFBa0FDUUFKQUFrQUNRRHBOd0R2ajBNb08zNEFCSUJqQ0FBSkFBa0FDUUFKQUFrQWFUWUFDSlFlUHdBQ3dGRlVCZ0NCMHVNSFFBQTRqc29BSUZCNi9BQW9Ed0FDcGNjUGdQSUFJRkI2L0FBb0R3QUNwY2NQZ1BJQUlGQjYvQkFvUDM0SWxCOC9BTW9EZ0VEcDhVT2cvUGdoVUg3OEVDZy9mZ2lVSHo4SXlnOGZBaGsvQkRKK0VHVDRJTWp3UVpEaGd5RERoMEZHRDRPTUhoTGp2dXZuQXJGbVYxUVFFMlVtQUFBQUFFbEZUa1N1UW1DQyIsICJzaXplcyI6ICIxOTJ4MTkyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIn0sIHsic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBZ0FBQUFJQUNBWUFBQUQwZU5UNkFBQUt4RWxFUVZSNDJ1M2JNYW9pVVJSRjBScEhKYzUvZHBVWUt4V0prWUtDdnJ2WGhUV0JWNTgrbSs3KzIrYVd2bjIvM0FCK3daL0F6aGx5QU9IZ25KRUhFQWZPNEFNZ0NKekJCMEFRT0lNUGdDQndSaDhBTWVBTVB3QkN3Qmw5QU1TQU0vd0FDQUZuOUFFUUE4N3dBeUFFbk9FSFFBZ1lmZ0FRQW9ZZkFJU0E4UWRBQkRqREQ0QVFjSVlmQUNIZ2pEOEFJc0FaZmdDRWdEUCtBSWdBWi9nQkVBTE8rQU1nQXB6eEIwQUVPTU1QZ0JBdy9uNndBQkFCeGg4QVJJRHhCd0FSWVBnQlFBZ1lmd0FRQWNZZkFFU0E4UWNBRVdEOEFVQUVHSDhBRUFIR0h3QkVnUEVIQUJGZy9BRkFCQmgvQUJBQnhoOEFzaEhnSXdOQUxBQjhZQUNJUllBUEN3Q3hDUEJCQVNBV0FUNGtBQVFqd0VjRWdGZ0ErSUFBRUlzQUh3NEFZaEhnZ3dGQU1BSjhMQUNJQllBUEJRQ3hDUENCQUNBWUFUNE9BTVFDd0ljQmdGZ0UrQ0FBRUl3QUh3TUFZZ0hnUXdCQU1BSjhCQUNJQllBUEFBQ3hDUER3QUJDTUFJOE9BTEVBOE9BQUVJd0FqdzBBc1FEdzBBQVFqQUNQREFDeEFQREFBQkNNQUk4TEFMRUE4TEFBRUl3QWp3b0FBZ0FBbUI0QUhoUUFnaEhnTVFFZ0ZnQWVFZ0NDRWVBUkFVQUFBQURUQThBREFrQXdBandlQU1RQ3dNTUJRREFDUEJvQUNBQUFZSG9BZURBQUNFYUF4d0lBQVFBQUNBQUFZRndBZUNnQUNFYUFSd0lBQVFBQUNBQUFZRndBZUNBQUNFYUF4d0VBQVFBQUNBQUFZRndBZUJnQUNFYUFSd0VBQVFBQUNBQUFRQUFBQUFJQUFCQUFBTUFLQWVCQkFDQVlBUjREQUFRQUFDQUFBQUFCQUFBSUFBQkFBQUFBQWdBQUVBQUFnQUFBQUFRQUFDQUFBQUFCQUFBSUFBRGdnd0R3RUFBUWpBQ1BBQUFDQUFBUUFBQ0FBQUFBQkFBQUlBQUFBQUVBQUFnQUFFQUFBQUFDQUFBUUFBQ0FBQUFBQkFBQUlBQUFBQUVBQUFnQUFFQUFBQUFDQUFBRUFBQWdBQUFBQVFBQUNBQUFRQUFBQUFJQUFCQUFBSUFBQUFBRUFBQWdBQUFBQVFBQUNBQUFRQUFBQUFJQUFCQUFBSUFBQUo0Y3g5VTdnQUFBQ29QL2luY0NBUUFNSC90M2VVOFFBRUJnOEFVQkNBQWdQdmFpQUFRQVlQQUZBUWdBd05pTEFoQUFnTUVYQkNBQUFJTXZDRUFBZ0xGSEZJQUFBSU9QSUFBQkFNWWVVUUFDQUF3K2dnQUVBQmg3UkFFSUFERDRDQUlRQUdEc0VRVWdBTURnSXdoQUFHRHdRUkNBQU1EWWd5Z0FBWURCQjBHQUFBQmpENklBQVFBR0h3UUJBZ0NNUFlnQ0JBQVlmQkFFQ0FBdzlpQUtFQUFZZkVBUUlBQXcrSUFnUUFCZzdBRlJnQURBNEFPQ0FBR0FzUWRFQVFJQWd3OElBZ1FBeGg0UUJRZ0FERDRnQ0JBQXhoNUFGQ0FBREQ2QUlFQUFHSHdBUVlBQU1QWUFva0FBWVBnQmhJQUFRQkFBR0h3QmdDZ0FNUFlDQUVFQVlQQUZBSUlBTVBnSUFFUUJZT3dSQUFnQ3dPQWpBQkFGZ0xGSEFDQUlBSU9QQUVBVUFNWWVBWUFnQUF3K0FnQlJBQmg3QkFDQ0FBdytDQUFFQVJoOEVBQ0lBakQySUFBUUJHRHdRUUFnQ3NEWUl3QkFFSURCUndDQUtBQmpqd0FBUVFBR0h3RUFvZ0JqRHdJQUJBRUdId1FBQ0FJTVBnZ0FFQVVZZXhBQUlBZ3crQ0FBUUJSZzdFRUFnQ0RBNElNQUFGR0FzUWNCQUlMQTRBTUNBRVNCc1FjRUFBZ0NndzhJQUJBRUJoOFFBQ0FLakQwZ0FFQVFHSHdRQUI0QlJJR3hCd0VBQ0FLRER3SUFpRVNCZHdFQkFFVC9Sc0Q3Z0FBQS9IOEFVUUFDQVBCYkFZSUFCQURnVndCRkFRZ0FvRFg0Z2dBRUFCQWZlMUVBQWdBdytJSUFCQUJnOEFVQkNBQXc5b2dDRUFCZzhCRUVJQURBMkNNS1FBQ0F3VWNRZ0FBQVk0OG9BQUVBQmg5QkFBSUFqRDJpQUFRQUdId0VBUWdBREQ0SUFoQUFHSHNRQlNBQU1QZ2dDQkFBWU94QkZDQUF3T0NESUVBQWdMRUhVWUFBQUlNUGdnQUJBTVllUkFFQ0FJTVBDQUlFQUFZZkVBUUlBSXc5SUFvUUFCaDhRQkFnQUREMmdDaEFBR0R3QVVHQUFNRFlBNklBQVlEQkJ3UUJBc0RZQTRnQ0JJREJCeEFFQ0FDRER5QUlFQURHSGtBVUNBQU1Qb0FnRUFBSUFnQ0RMd0FRQlFER1hnQWdDQUFNdmdCQUVBQUdId0dBS0FDTVBRSUFRUUFZZkFRQW9nQXc5Z2dBQkFGZzhCRUFpQUxBMkNNQUVBU0F3VWNBSUFvQVk0OEFRQkNBd1FjQmdDQUFndzhDQUZFQXhoNEVBSUlBREQ0SUFFUUJHSHNFQUFnQ01QZ0lBQkFGWU93UkFDQUl3T0FqQUVBVVlPeEJBSUFnd09DREFBQkJnTUVIQVFDaUFHTVBBZ0FFQVFZZkJBQ0lBb3c5Q0FBUUJCaDhFQUFnQ2pEMklBQkFFQmg4UUFDQUtERDJnQUFBUVdEd0FRRUFnc0RnQXdJQVJJR3hCd1FBQ0FLRER3TEFRNEFvTVBZZ0FBQkJZUEJCQUFDWktQQStJQUNBV0FSNEZ4QUFnSDhHRUFVZ0FBRC9FVkFRZ0FBQS9DcWdLQUFCQURSLzkxOFFnQUFBb21NdkNrQUFBQVpmRUlBQUFBeStJQUFCQU1ZZVVRQUNBQXcrZ2dBRUFCaDdSQUVJQURENENBSVFBR0RzRVFVZ0FNRGdJd2hBQUlDeFJ4U0FBQUNEanlBQUFZREJCMEVBQWdCakQ2SUFCQUFHSHdRQkFnQ01QWWdDQkFBWWZCQUVDQUF3OWlBS0VBQmc4RUVRSUFEQTJJTW9RQUJnOEFGQmdBREE0QU9DQUFHQXNRZEVBUUlBZ3c4SUFnUUF4aDRRQlFnQURENGdDQkFBR0h0QUZDQUFNUGlBSUVBQUdIc0FVWUFBTVBnQWdnQUJZUEFCQkFFQ3dOZ0RpQUlCZ01FSEVBUUNBQ0VBWVBnRkFLSUF3TmdMQUFRQmdNRVhBQWdDQUlNdkFCQUZnTEZIQUNBSUFJT1BBRUFVQU1ZZUFZQWdBQXcrQWdCUkFCaDdCQUNDQURENENBQkVBV0RzRVFBSUFqRDRJQUFRQkdEd1FRQWdDc0RZZ3dCQUVJREJCd0dBS0FCamp3RHdDQWdDTVBnSUFCQUZZT3dSQUNBSXdPQWpBRUFVWU94QkFJQWd3T0NEQUFCQmdNRUhBUUNpQUdNUEFnQUVBUVlmQkFDSUFvdzlDQUFRQkJoOEVBQWdDakQySUFCQUVCaDhRQUNBS0REMmdBQUFRV0R3QVFFQWdzRGdBd0lBUklHeEJ3UUFDQUtERHdnQUVBWEdIZ1FBSUFnTVBnZ0FJQmNGM2drRUFCQUlBdThBQWdBQUVBQUFnQUFBQUFRQUFDQUFBQUFCQUFBSUFBQkFBQUFBQWdBQUVBQUFnQUFBQUFRQUFDQUFBQUFCQUFBSUFBQkFBQUFBQWdBQUJBQUFJQUFBQUFFQUFBZ0FBRUFBQUFBQ0FBQVFBQUNBQUFBQUJBQUFJQUFBQUFFQUFBZ0FBRUFBQUFBQ0FBQVFBQUNBQUFBQUhnRndub2NBZ05qNEN3QUFFQUFBZ0FBQUFBUUFBQ0FBQUFBQkFBQUlBQUJBQUFBQUFnQUFFQUFBZ0FBQUFBUUFBQ0FBQUlBdkJJQUlBSURnK0FzQUFCQUFBSUFBQUFBRUFBQWdBQUFBQVFBQXJCUUFJZ0FBZ3VNdkFBQkFBQUFBQWdBQUdCc0FJZ0FBZ3VNdkFBQkFBQUFBQWdBQUdCc0FJZ0FBZ3VNdkFBQkFBQUFBQWdBQUdCc0FJZ0FBZ3VNdkFBQkFBQUFBbFFBUUFRQVFISDhCQUFEUkFCQUJBQkFjZndFQUFBSUFBS2dFZ0FnQWdPRDRDd0FBaUFhQUNBQ0E0UGdMQUFBUUFBQkFKUUJFQUFBRXgxOEFBRUEwQUVRQUFBVEhYd0FBUURRQVJBQUFCTWRmQUFCQU5BQkVBQUFFeDE4QUFFQTBBRVFBQUFUSFh3UUFRSFQ4QlFBQVJBTkFCQUJBY1B3RkFBQkVBMEFFQUVCdy9FVUFBRVRIWHdBQVFEUUFSQUFBQk1kZkJBQkFkUHdGQUFCRUEwQUVBRUJ3L0VVQUFFVEhYd1FBUUhUOEJRQUFSQU5BQkFCQWNQeEZBQUJFeDE4RUFFQjAvRVVBQUVUSFh3QUFRRFFBUkFBQUJNZGZCQUJBZFB4RkFBQkV4MThFQUdEODQrY0hBUURqTHdJQXdQaUxBQUF3L2lJQUFJeS9DQUFBNHk4Q0FNRDRDd0VBTVB3aUFBQ012d2dBQU9NdkFnREErQXNCQUREOElnQUFqTDhJQUFCTExBUUFNUHhPQkFCZy9KMFFBTUR3T3hFQWdQRjNRZ0FBdysrRUFBQ0czNGtBQUl5L0V3SUFHSDRuQkFBdy9FNElBR0Q0blJBQXdQQTdNUUJnOUowVEFnQ0czemt4QUdEMG5STUNBSWJmT1RFQVlQU2RFd1FBQnQ4NVFRQmc4SjBUQkFBRzN6bHhBR0RrblJNT2dDRjNmM0IzRXlGWm5xSlBnTmNBQUFBQVNVVk9SSzVDWUlJPSIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIiwgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIn1dfQ==">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════
   DESIGN TOKENS
═══════════════════════════════════════════════ */
:root {
  --font: 'Sora', sans-serif;
  --mono: 'Space Mono', monospace;

  /* Light */
  --bg:          #f7f7f5;
  --bg2:         #ffffff;
  --bg3:         #efefec;
  --surface:     #ffffff;
  --surface2:    #f2f2ef;
  --border:      rgba(0,0,0,0.09);
  --border2:     rgba(0,0,0,0.05);
  --text:        #0c0c0e;
  --text2:       #5c5c64;
  --text3:       #9c9ca4;
  --logo-budget: #0c0c0e;
  --logo-bynan:  #0c0c0e;
  --green:       #1a9e52;
  --green-bg:    rgba(26,158,82,0.08);
  --red:         #d93025;
  --red-bg:      rgba(217,48,37,0.08);
  --blue:        #1a73e8;
  --blue-bg:     rgba(26,115,232,0.08);
  --amber:       #e37400;
  --amber-bg:    rgba(227,116,0,0.1);
  --shadow-sm:   0 1px 4px rgba(0,0,0,0.06);
  --shadow:      0 4px 20px rgba(0,0,0,0.08);
  --shadow-lg:   0 16px 48px rgba(0,0,0,0.14);
  --radius-sm:   6px;
  --radius:      12px;
  --radius-lg:   18px;
  --radius-xl:   24px;
  --nav-h:       68px;
  --safe-b:      env(safe-area-inset-bottom, 12px);
  --safe-t:      env(safe-area-inset-top, 0px);

  /* Desktop sidebar */
  --sidebar-w:   240px;
}

[data-theme="dark"] {
  --bg:          #0c0c0e;
  --bg2:         #131316;
  --bg3:         #1a1a1f;
  --surface:     #1a1a1f;
  --surface2:    #202028;
  --border:      rgba(255,255,255,0.08);
  --border2:     rgba(255,255,255,0.04);
  --text:        #f0f0f5;
  --text2:       #8c8ca0;
  --text3:       #5c5c6e;
  --logo-budget: #ffffff;
  --logo-bynan:  #f0f0f5;
  --green:       #34d472;
  --green-bg:    rgba(52,212,114,0.1);
  --red:         #f05450;
  --red-bg:      rgba(240,84,80,0.1);
  --blue:        #6aa6f0;
  --blue-bg:     rgba(106,166,240,0.1);
  --amber:       #ffb840;
  --amber-bg:    rgba(255,184,64,0.1);
  --shadow-sm:   0 1px 4px rgba(0,0,0,0.4);
  --shadow:      0 4px 20px rgba(0,0,0,0.5);
  --shadow-lg:   0 16px 48px rgba(0,0,0,0.7);
}

/* ═══════════════════════════════════════════════
   RESET
═══════════════════════════════════════════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height:100%;touch-action:manipulation;-webkit-text-size-adjust:100%;}
body{
  font-family:var(--font);
  background:var(--bg);
  color:var(--text);
  height:100%;
  min-height:100dvh;
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  transition:background 0.2s,color 0.2s;
}
button{font-family:var(--font);cursor:pointer;border:none;outline:none;background:none;}
input,select,textarea{font-family:var(--font);outline:none;border:none;background:none;}
ul,li{list-style:none;}
a{text-decoration:none;color:inherit;cursor:pointer;}
select{appearance:none;-webkit-appearance:none;}

/* ═══════════════════════════════════════════════
   LOGO MARK
═══════════════════════════════════════════════ */
.logo {
  display:flex;
  align-items:baseline;
  gap:0;
  font-size:22px;
  font-weight:800;
  letter-spacing:-0.8px;
  user-select:none;
}
.logo .budget { color:var(--logo-budget); transition:color 0.2s; }
.logo .bynan  { color:var(--logo-bynan); font-weight:300; transition:color 0.2s; }
.logo-sm { font-size:18px; }
.logo-lg { font-size:28px; }

/* ═══════════════════════════════════════════════
   APP SHELL
═══════════════════════════════════════════════ */
#app {
  width:100%;
  height:100dvh;
  display:flex;
  overflow:hidden;
  position:relative;
}

/* ─ Mobile: screens stacked ─ */
.screen {
  display:none;
  flex-direction:column;
  width:100%;
  height:100%;
  overflow:hidden;
  animation:screenIn 0.2s ease;
}
.screen.active{display:flex;}

@keyframes screenIn {
  from{opacity:0;transform:translateY(5px);}
  to{opacity:1;transform:none;}
}

/* ═══════════════════════════════════════════════
   SIDEBAR (always in DOM, hidden on mobile)
═══════════════════════════════════════════════ */
.sidebar {
  display:none; /* hidden by default, shown on desktop */
}

.sidebar-nav { flex:1; display:flex; flex-direction:column; gap:2px; padding:0 12px; }
.sidebar-bottom { padding:0 12px; display:flex; flex-direction:column; gap:2px; }
.sidebar-item {
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:var(--radius-sm);
  cursor:pointer; font-size:14px; font-weight:500;
  color:var(--text2); transition:all 0.15s;
}
.sidebar-item:hover { background:var(--bg3); color:var(--text); }
.sidebar-item.active { background:var(--bg3); color:var(--text); font-weight:600; }
.sidebar-item .sico {
  width:30px; height:30px; border-radius:var(--radius-sm);
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:all 0.15s;
}
/* Active icon: filled background */
.sidebar-item.active .sico { background:var(--text); }
.sidebar-item.active .sico svg { stroke:var(--bg); }
/* Inactive icon: just the stroke, visible in both themes */
.sidebar-item .sico svg { width:15px; height:15px; stroke:var(--text2); stroke-width:1.8; fill:none; }
.sidebar-logo { padding:0 24px 32px; }

/* ═══════════════════════════════════════════════
   DESKTOP LAYOUT (960px+)
═══════════════════════════════════════════════ */
@media(min-width:960px){
  #app { flex-direction:row; }

  .sidebar {
    display:flex;
    flex-direction:column;
    width:var(--sidebar-w);
    height:100%;
    background:var(--surface);
    border-right:1px solid var(--border);
    padding:32px 0 24px;
    flex-shrink:0;
    z-index:10;
    position:relative; /* important: keep it in flow */
  }

  /* desktop-main takes the remaining width */
  .desktop-main {
    flex:1;
    min-width:0;
    height:100%;
    overflow:hidden;
    position:relative; /* screens position:absolute relative to THIS */
    display:flex;
    flex-direction:column;
  }

  /* screens stack inside desktop-main */
  .screen {
    position:absolute;
    top:0; left:0; right:0; bottom:0;
    display:none;
    flex-direction:column;
    overflow:hidden;
  }
  .screen.active { display:flex; }

  /* Hide bottom nav & fab on desktop */
  .bottom-nav { display:none !important; }
  .fab        { display:none !important; }

  /* Show desktop-only add button */
  .desktop-add-btn { display:flex !important; }

  /* Login screen: centered inside desktop-main area */
  #login-screen {
    align-items:center;
    justify-content:center;
  }
}

@media(max-width:959px){
  .sidebar         { display:none !important; }
  .desktop-main    { display:contents; }
  .desktop-add-btn { display:none !important; }

  /* Mobile: screens are normal block flow */
  .screen {
    position:relative;
    display:none;
    flex-direction:column;
    width:100%;
    height:100%;
    overflow:hidden;
  }
  .screen.active { display:flex; }
}

/* ═══════════════════════════════════════════════
   PAGE LAYOUT
═══════════════════════════════════════════════ */
.main-layout{display:flex;flex-direction:column;width:100%;height:100%;overflow:hidden;}
.page-content{
  flex:1;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  padding-bottom:calc(var(--nav-h) + var(--safe-b) + 36px);
}
.page-content::-webkit-scrollbar{display:none;}

@media(min-width:960px){
  .page-content{padding-bottom:24px;}
}

/* ─ Header ─ */
.page-header{
  padding:calc(max(var(--safe-t),16px) + 4px) 20px 14px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:0;z-index:100;
  background:var(--bg);
  border-bottom:1px solid transparent;
  transition:border-color 0.2s;
}
.page-header.scrolled{border-bottom-color:var(--border);}
.header-left h2{font-size:20px;font-weight:700;letter-spacing:-0.3px;}
.header-left p{font-size:12px;color:var(--text3);margin-top:1px;}
.header-right{display:flex;align-items:center;gap:6px;}

@media(min-width:960px){
  .page-header{padding:20px 32px 16px;}
  .header-left h2{font-size:22px;}
}

.icon-btn{
  width:38px;height:38px;
  border-radius:50%;
  background:var(--surface);
  border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all 0.15s;
  flex-shrink:0;
}
.icon-btn:active{transform:scale(0.9);}
.icon-btn svg{width:18px;height:18px;stroke:var(--text2);stroke-width:1.8;fill:none;}

/* Desktop add button */
.desktop-add-btn{
  display:none;
  align-items:center;gap:8px;
  padding:9px 16px;
  background:var(--text);
  color:var(--bg);
  border-radius:var(--radius);
  font-size:13px;font-weight:600;
  cursor:pointer;transition:all 0.15s;
  border:none;
}
.desktop-add-btn:hover{opacity:0.85;}
.desktop-add-btn svg{width:14px;height:14px;stroke:var(--bg);stroke-width:2;fill:none;}

/* ─ Bottom Nav (mobile) ─ */
.bottom-nav{
  position:fixed;bottom:10px;left:0;right:0;
  z-index:200;
  padding:8px 16px calc(var(--safe-b) + 6px);
  background:transparent;
  border-top:none;
}
.nav-pills{
  display:flex;align-items:center;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:100px;
  padding:4px;gap:2px;
  box-shadow:0 4px 24px rgba(0,0,0,0.14), 0 1px 6px rgba(0,0,0,0.08);
  max-width:480px;margin:0 auto;
}
.nav-pill{
  flex:1;
  display:flex;align-items:center;justify-content:center;gap:5px;
  padding:8px;
  border-radius:100px;
  cursor:pointer;
  transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1);
  font-size:12px;font-weight:500;
  color:var(--text3);white-space:nowrap;
}
.nav-pill svg{width:17px;height:17px;stroke:currentColor;stroke-width:1.8;fill:none;flex-shrink:0;}
.nav-pill .nav-label{overflow:hidden;max-width:0;opacity:0;transition:max-width 0.2s,opacity 0.2s;}
.nav-pill.active{background:var(--text);color:var(--bg);}
.nav-pill.active .nav-label{max-width:72px;opacity:1;}

/* ─ FAB (mobile) ─ */
.fab{
  position:fixed;
  bottom:calc(var(--nav-h) + var(--safe-b) + 22px);
  right:18px;
  width:52px;height:52px;
  border-radius:50%;
  background:var(--text);color:var(--bg);
  font-size:24px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  box-shadow:0 4px 20px rgba(0,0,0,0.3);
  transition:all 0.2s cubic-bezier(0.34,1.56,0.64,1);
  z-index:150;border:none;line-height:1;
}
.fab:active{transform:scale(0.87);}
.fab.hidden{transform:scale(0) translateY(20px);opacity:0;pointer-events:none;}
.fab svg{width:20px;height:20px;stroke:var(--bg);stroke-width:2.2;fill:none;}

/* ═══════════════════════════════════════════════
   LOGIN SCREEN
═══════════════════════════════════════════════ */
#login-screen{
  align-items:center;justify-content:center;
  padding:max(var(--safe-t),24px) 24px calc(var(--safe-b) + 24px);
  background:var(--bg);
  width:100%;
  height:100%;
}
.login-brand{text-align:center;margin-bottom:48px;}
.login-brand .logo-mark{
  width:60px;height:60px;
  background:var(--text);
  border-radius:16px;
  display:inline-flex;align-items:center;justify-content:center;
  margin-bottom:20px;
}
.login-brand .logo-mark svg{width:28px;height:28px;stroke:var(--bg);stroke-width:1.8;fill:none;}
.login-step{width:100%;max-width:340px;}

.user-list{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:10px;}
.user-card{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:20px 14px;text-align:center;
  cursor:pointer;transition:all 0.18s;
  box-shadow:var(--shadow-sm);
}
.user-card:hover{border-color:var(--text3);box-shadow:var(--shadow);}
.user-card:active{transform:scale(0.96);}
.user-card .uav{
  width:44px;height:44px;
  border-radius:50%;
  background:var(--bg3);
  margin:0 auto 10px;
  display:flex;align-items:center;justify-content:center;
}
.user-card .uav svg{width:20px;height:20px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.user-card .uname{font-size:14px;font-weight:600;color:var(--text);}




/* PIN */
.pin-header{display:flex;align-items:center;gap:12px;margin-bottom:28px;}
.back-btn{
  width:38px;height:38px;border-radius:50%;
  background:var(--surface);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all 0.15s;flex-shrink:0;
}
.back-btn:active{transform:scale(0.92);}
.back-btn svg{width:16px;height:16px;stroke:var(--text2);stroke-width:2;fill:none;}
.pin-user-info{flex:1;}
.pin-user-info .pname{font-size:18px;font-weight:700;}
.pin-user-info .psub{font-size:12px;color:var(--text3);margin-top:2px;}

.pin-dots{display:flex;gap:14px;justify-content:center;margin-bottom:36px;}
.pin-dot{
  width:13px;height:13px;border-radius:50%;
  border:1.5px solid var(--border);background:transparent;
  transition:all 0.15s;
}
.pin-dot.filled{background:var(--text);border-color:var(--text);transform:scale(1.15);}
.pin-dot.error{background:var(--red);border-color:var(--red);animation:shake 0.4s ease;}

@keyframes shake{0%,100%{transform:translateX(0);}20%,60%{transform:translateX(-6px);}40%,80%{transform:translateX(6px);}}

.numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.numpad-btn{
  aspect-ratio:1.35;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  font-size:20px;font-weight:600;color:var(--text);
  cursor:pointer;transition:all 0.12s;
  display:flex;align-items:center;justify-content:center;
  user-select:none;box-shadow:var(--shadow-sm);
}
.numpad-btn:active{transform:scale(0.91);background:var(--bg3);}
.numpad-btn.delete svg{width:18px;height:18px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.numpad-btn.empty{background:transparent;border-color:transparent;box-shadow:none;pointer-events:none;}

/* ═══════════════════════════════════════════════
   HOME SCREEN
═══════════════════════════════════════════════ */
#home-screen .page-content{padding-top:0;}

.home-hero{
  margin:10px 16px 18px;
  background:var(--text);
  border-radius:var(--radius-xl);
  padding:26px 22px 22px;
  color:var(--bg);position:relative;overflow:hidden;
  box-sizing:border-box;
  width:auto;
}
.home-hero::before{
  content:'';position:absolute;
  top:-50px;right:-50px;
  width:200px;height:200px;
  background:rgba(255,255,255,0.03);border-radius:50%;
}

@media(min-width:960px){
  .home-hero{margin:16px 32px 20px;}
}

.hero-period{
  font-size:11px;font-weight:500;opacity:0.5;
  text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;
  display:flex;align-items:center;gap:8px;
}
.hero-period button{
  background:rgba(255,255,255,0.14);color:inherit;border:none;
  border-radius:20px;padding:3px 10px;font-size:10px;cursor:pointer;
  font-family:var(--font);font-weight:500;opacity:0.8;
}
.hero-balance{font-size:38px;font-weight:800;letter-spacing:-1.5px;line-height:1;margin-bottom:5px;font-family:var(--mono);}
.hero-balance .currency{font-size:20px;font-weight:400;opacity:0.6;margin-right:2px;vertical-align:4px;font-family:var(--font);}
.hero-change{font-size:12px;opacity:0.5;margin-bottom:22px;}
.hero-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;position:relative;z-index:1;width:100%;}
.hero-stat{background:rgba(255,255,255,0.1);border-radius:var(--radius);padding:12px;min-width:0;}
.hero-stat-label{font-size:10px;opacity:0.6;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:5px;display:flex;align-items:center;gap:5px;}
.hero-stat-label svg{width:10px;height:10px;stroke:currentColor;stroke-width:2;fill:none;flex-shrink:0;}
.hero-stat-value{font-size:17px;font-weight:700;letter-spacing:-0.5px;font-family:var(--mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.hero-stat-value.income{color:#6ee7b7;}
.hero-stat-value.expense{color:#fca5a5;}

/* Quick actions */
.quick-actions{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;padding:0 16px 18px;}
@media(min-width:960px){.quick-actions{padding:0 32px 20px;grid-template-columns:repeat(4,1fr);max-width:600px;}}
.quick-action{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:14px 8px;
  text-align:center;
  cursor:pointer;transition:all 0.15s;
  box-shadow:var(--shadow-sm);
}
.quick-action:active{transform:scale(0.96);}
.quick-action:hover{box-shadow:var(--shadow);border-color:var(--text3);}
.qa-icon{
  width:34px;height:34px;border-radius:var(--radius-sm);
  background:var(--bg3);
  margin:0 auto 8px;
  display:flex;align-items:center;justify-content:center;
}
.qa-icon svg{width:16px;height:16px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.qa-label{font-size:11px;font-weight:600;color:var(--text2);letter-spacing:0.2px;}

/* Spending chart */
.spending-chart-card{
  margin:0 16px 18px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:18px;box-shadow:var(--shadow-sm);
}
@media(min-width:960px){.spending-chart-card{margin:0 32px 20px;}}
.chart-title{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:14px;}
.chart-title span:first-child{font-size:13px;font-weight:600;color:var(--text2);}
.mini-chart{display:flex;align-items:flex-end;gap:6px;height:60px;}
.chart-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.chart-bar{width:100%;border-radius:3px 3px 0 0;background:var(--border);transition:height 0.4s cubic-bezier(0.34,1.2,0.64,1);min-height:3px;}
.chart-bar.active{background:var(--text);}
.chart-bar-label{font-size:9px;color:var(--text3);font-weight:500;}

/* Section */
.section-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px 12px;
}
@media(min-width:960px){.section-header{padding:0 32px 14px;}}
.section-header h3{font-size:15px;font-weight:700;}
.section-header a{font-size:13px;font-weight:500;color:var(--text3);}
.section-header a:hover{color:var(--text);}

/* Transaction list */
.txn-list{padding:0 16px;display:flex;flex-direction:column;gap:7px;}
@media(min-width:960px){.txn-list{padding:0 32px;}}
.txn-item{
  display:flex;align-items:center;gap:12px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:13px;
  cursor:pointer;transition:all 0.15s;box-shadow:var(--shadow-sm);
}
.txn-item:active{transform:scale(0.98);}
.txn-item:hover{box-shadow:var(--shadow);border-color:var(--text3);}
.txn-icon{
  width:40px;height:40px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;background:var(--bg3);
}
.txn-icon svg{width:17px;height:17px;stroke-width:1.8;fill:none;}
.txn-icon.income{background:var(--green-bg);}
.txn-icon.income svg{stroke:var(--green);}
.txn-icon.expense{background:var(--red-bg);}
.txn-icon.expense svg{stroke:var(--red);}
.txn-info{flex:1;min-width:0;}
.txn-name{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.txn-sub{font-size:11px;color:var(--text3);margin-top:2px;}
.txn-amount{font-family:var(--mono);font-size:15px;font-weight:700;flex-shrink:0;}
.txn-amount.income{color:var(--green);}
.txn-amount.expense{color:var(--red);}

.empty-state{text-align:center;padding:48px 24px;color:var(--text3);}
.empty-state svg{width:36px;height:36px;stroke:var(--text3);stroke-width:1.2;fill:none;margin-bottom:10px;opacity:0.5;}
.empty-state p{font-size:13px;}

/* ═══════════════════════════════════════════════
   TRANSACTIONS SCREEN
═══════════════════════════════════════════════ */
.filter-bar{padding:0 16px 14px;display:flex;gap:7px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.filter-bar::-webkit-scrollbar{display:none;}
@media(min-width:960px){.filter-bar{padding:0 32px 16px;}}
.filter-chip{
  padding:6px 14px;border-radius:100px;
  border:1px solid var(--border);background:var(--surface);
  font-size:12px;font-weight:500;color:var(--text2);
  cursor:pointer;white-space:nowrap;transition:all 0.15s;flex-shrink:0;
}
.filter-chip.active{background:var(--text);border-color:var(--text);color:var(--bg);}
.filter-chip:active{transform:scale(0.94);}

.month-nav{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px 14px;
}
@media(min-width:960px){.month-nav{padding:0 32px 16px;}}
.month-nav .month-label{font-size:14px;font-weight:600;}
.month-nav button{
  width:32px;height:32px;border-radius:50%;
  background:var(--surface);border:1px solid var(--border);
  color:var(--text);font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;
}
.month-nav button:active{transform:scale(0.9);}

.txn-date-group{padding:0 16px 4px;}
@media(min-width:960px){.txn-date-group{padding:0 32px 4px;}}
.txn-date-group .date-label{
  font-size:11px;font-weight:600;color:var(--text3);
  text-transform:uppercase;letter-spacing:0.6px;padding:10px 0 7px;
}

/* ═══════════════════════════════════════════════
   ANALYTICS
═══════════════════════════════════════════════ */
.analytics-summary{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 16px 18px;}
@media(min-width:960px){.analytics-summary{padding:0 32px 20px;grid-template-columns:repeat(4,1fr);}}
.analytics-card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px;box-shadow:var(--shadow-sm);
}
.analytics-card .ac-label{font-size:11px;color:var(--text3);font-weight:500;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.4px;}
.analytics-card .ac-value{font-size:20px;font-weight:700;letter-spacing:-0.5px;font-family:var(--mono);}
.analytics-card .ac-value.green{color:var(--green);}
.analytics-card .ac-value.red{color:var(--red);}
.analytics-card .ac-change{font-size:10px;color:var(--text3);margin-top:3px;}

.donut-card{
  margin:0 16px 18px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-sm);
}
@media(min-width:960px){.donut-card{margin:0 32px 20px;}}
.donut-wrap{display:flex;align-items:center;gap:18px;}
.donut-svg{flex-shrink:0;}
.donut-legend{flex:1;display:flex;flex-direction:column;gap:8px;}
.legend-item{display:flex;align-items:center;gap:7px;}
.legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.legend-label{font-size:12px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.legend-pct{font-size:12px;font-weight:600;font-family:var(--mono);}

.budget-item{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:14px;margin:0 16px 7px;box-shadow:var(--shadow-sm);
}
@media(min-width:960px){.budget-item{margin:0 32px 8px;}}
.budget-item-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px;}
.budget-item-name{font-size:13px;font-weight:600;}
.budget-item-amounts{font-size:11px;color:var(--text3);font-family:var(--mono);}
.budget-bar{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.budget-bar-fill{height:100%;border-radius:3px;transition:width 0.5s cubic-bezier(0.34,1.2,0.64,1);}
.budget-bar-fill.ok{background:var(--green);}
.budget-bar-fill.warning{background:var(--amber);}
.budget-bar-fill.over{background:var(--red);}

/* ═══════════════════════════════════════════════
   MORE SCREEN
═══════════════════════════════════════════════ */
.more-user-card{
  margin:0 16px 18px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-lg);padding:18px;
  display:flex;align-items:center;gap:14px;box-shadow:var(--shadow-sm);
}
@media(min-width:960px){.more-user-card{margin:0 32px 20px;}}
.more-user-avatar{
  width:52px;height:52px;border-radius:50%;
  background:var(--bg3);border:1.5px solid var(--border);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.more-user-avatar svg{width:22px;height:22px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.more-user-info h3{font-size:17px;font-weight:700;}
.more-user-info p{font-size:12px;color:var(--text3);margin-top:2px;}

.more-section{margin:0 16px 7px;}
@media(min-width:960px){.more-section{margin:0 32px 8px;}}
.more-section-label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:0.9px;color:var(--text3);padding:0 4px 7px;}
.more-list{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow-sm);}
.more-list-item{
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  cursor:pointer;transition:background 0.15s;border-bottom:1px solid var(--border2);
}
.more-list-item:last-child{border-bottom:none;}
.more-list-item:active{background:var(--bg3);}
.more-list-item:hover{background:var(--surface2);}
.mli-icon{
  width:34px;height:34px;border-radius:var(--radius-sm);background:var(--bg3);
  display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.mli-icon svg{width:15px;height:15px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.mli-text{flex:1;}
.mli-text .mlt{font-size:14px;font-weight:500;}
.mli-text .mls{font-size:11px;color:var(--text3);margin-top:2px;}
.mli-arrow{color:var(--text3);font-size:14px;}
.mli-toggle{
  width:44px;height:24px;background:var(--border);border-radius:100px;
  position:relative;cursor:pointer;transition:background 0.2s;flex-shrink:0;
}
.mli-toggle.on{background:var(--text);}
.mli-toggle::after{
  content:'';position:absolute;
  width:18px;height:18px;background:white;border-radius:50%;
  top:3px;left:3px;
  transition:transform 0.2s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 1px 3px rgba(0,0,0,0.2);
}
.mli-toggle.on::after{transform:translateX(20px);}

/* Income sources */
.income-sources-list{padding:0 16px;display:flex;flex-direction:column;gap:7px;}
@media(min-width:960px){.income-sources-list{padding:0 32px;}}
.income-source-item{
  display:flex;align-items:center;gap:12px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:13px;box-shadow:var(--shadow-sm);
}
.is-icon{
  width:38px;height:38px;border-radius:var(--radius-sm);
  background:var(--blue-bg);display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.is-icon svg{width:16px;height:16px;stroke:var(--blue);stroke-width:1.8;fill:none;}
.is-name{font-size:14px;font-weight:600;flex:1;}
.is-delete{
  width:30px;height:30px;border-radius:var(--radius-sm);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text3);transition:all 0.15s;background:transparent;border:none;
}
.is-delete svg{width:15px;height:15px;stroke:currentColor;stroke-width:1.8;fill:none;}
.is-delete:active{color:var(--red);background:var(--red-bg);}

/* Categories manage */
.cat-list{padding:0 16px;display:flex;flex-direction:column;gap:7px;}
@media(min-width:960px){.cat-list{padding:0 32px;}}
.cat-item{
  display:flex;align-items:center;gap:12px;
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius);padding:12px;box-shadow:var(--shadow-sm);
}
.cat-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.cat-item-name{font-size:14px;font-weight:500;flex:1;}
.cat-item-type{font-size:11px;color:var(--text3);margin-left:auto;padding-right:8px;}
.cat-delete{
  width:28px;height:28px;display:flex;align-items:center;justify-content:center;
  cursor:pointer;color:var(--text3);transition:all 0.15s;background:transparent;border:none;border-radius:6px;
}
.cat-delete svg{width:13px;height:13px;stroke:currentColor;stroke-width:1.8;fill:none;}
.cat-delete:active{color:var(--red);background:var(--red-bg);}

/* ═══════════════════════════════════════════════
   MODALS / SHEETS
═══════════════════════════════════════════════ */
.modal-overlay{
  position:fixed;inset:0;z-index:500;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity 0.22s ease;
}
.modal-overlay.open{opacity:1;pointer-events:all;}
.modal-overlay .backdrop{
  position:absolute;inset:0;
  background:rgba(0,0,0,0.5);
  backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);cursor:pointer;
}
.bottom-sheet{
  position:relative;z-index:1;
  width:100%;max-width:540px;
  background:var(--surface);
  border-radius:var(--radius-xl) var(--radius-xl) 0 0;
  padding:0 0 calc(var(--safe-b) + 8px);
  transform:translateY(100%);
  transition:transform 0.32s cubic-bezier(0.34,1.1,0.64,1);
  max-height:92dvh;overflow:hidden;display:flex;flex-direction:column;
}
.modal-overlay.open .bottom-sheet{transform:translateY(0);}

@media(min-width:640px){
  .bottom-sheet{max-width:480px;border-radius:var(--radius-xl);margin-bottom:24px;}
  .modal-overlay{align-items:center;}
}

.sheet-handle{width:34px;height:4px;background:var(--border);border-radius:2px;margin:11px auto 0;flex-shrink:0;}
.sheet-header{
  padding:15px 20px 12px;
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;border-bottom:1px solid var(--border);
}
.sheet-header h3{font-size:16px;font-weight:700;}
.sheet-close{
  width:30px;height:30px;border-radius:50%;
  background:var(--bg3);border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;
}
.sheet-close svg{width:14px;height:14px;stroke:var(--text2);stroke-width:2;fill:none;}
.sheet-close:active{transform:scale(0.88);}
.sheet-body{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:18px;}
.sheet-body::-webkit-scrollbar{display:none;}

/* Form */
.form-group{margin-bottom:15px;}
.form-label{font-size:11px;font-weight:600;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;display:block;}
.form-input{
  width:100%;padding:12px 14px;
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--radius);font-size:15px;font-family:var(--font);
  color:var(--text);transition:border-color 0.15s;
}
.form-input:focus{border-color:var(--text);}
select.form-input{cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239c9ca4' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px;}

.type-toggle{display:grid;grid-template-columns:1fr 1fr;background:var(--bg3);border-radius:var(--radius);padding:3px;gap:3px;}
.type-btn{
  padding:9px;border-radius:9px;font-size:13px;font-weight:600;
  cursor:pointer;transition:all 0.18s;text-align:center;
  color:var(--text2);border:none;background:transparent;font-family:var(--font);
}
.type-btn.active.income{background:var(--green-bg);color:var(--green);}
.type-btn.active.expense{background:var(--red-bg);color:var(--red);}

.amount-input-wrap{position:relative;display:flex;align-items:center;}
.amount-currency{position:absolute;left:14px;font-size:18px;font-weight:400;color:var(--text3);pointer-events:none;}
.amount-input-wrap .form-input{padding-left:32px;font-size:26px;font-weight:700;font-family:var(--mono);letter-spacing:-0.5px;}

.category-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.category-chip{
  padding:9px 6px;border-radius:var(--radius);
  border:1px solid var(--border);background:var(--bg2);
  text-align:center;cursor:pointer;transition:all 0.15s;font-family:var(--font);
}
.category-chip:active{transform:scale(0.93);}
.category-chip.selected{border-color:var(--text);background:var(--text);color:var(--bg);}
.cc-dot{width:8px;height:8px;border-radius:50%;margin:0 auto 5px;}
.category-chip.selected .cc-dot{background:rgba(255,255,255,0.4)!important;}
.cc-label{font-size:10px;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

.source-select{display:flex;flex-direction:column;gap:7px;}
.source-option{
  display:flex;align-items:center;gap:9px;
  padding:11px 13px;
  background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--radius);cursor:pointer;transition:all 0.15s;font-family:var(--font);
}
.source-option.selected{border-color:var(--text);background:var(--bg3);}
.source-option:active{transform:scale(0.97);}
.source-option .so-icon{
  width:30px;height:30px;border-radius:var(--radius-sm);
  background:var(--bg3);display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.source-option .so-icon svg{width:13px;height:13px;stroke:var(--text2);stroke-width:1.8;fill:none;}
.source-option .so-name{font-size:13px;font-weight:500;flex:1;}
.source-option .so-check{font-size:14px;opacity:0;transition:opacity 0.15s;color:var(--text);}
.source-option .so-check svg{width:13px;height:13px;stroke:currentColor;stroke-width:2.5;fill:none;}
.source-option.selected .so-check{opacity:1;}

.sheet-footer{padding:14px 20px 0;flex-shrink:0;border-top:1px solid var(--border);}
.btn-primary{
  width:100%;padding:14px;background:var(--text);color:var(--bg);
  border-radius:var(--radius);font-size:15px;font-weight:700;
  cursor:pointer;transition:all 0.15s;border:none;font-family:var(--font);
}
.btn-primary:active{transform:scale(0.97);opacity:0.85;}
.btn-primary:disabled{opacity:0.4;pointer-events:none;}
.btn-secondary{
  width:100%;padding:12px;background:transparent;color:var(--text2);
  border-radius:var(--radius);font-size:14px;font-weight:500;
  cursor:pointer;border:1px solid var(--border);font-family:var(--font);
  margin-top:7px;transition:all 0.15s;
}
.btn-secondary:active{background:var(--bg3);}

/* Color picker */
.color-swatches{display:flex;flex-wrap:wrap;gap:8px;}
.color-swatch{
  width:30px;height:30px;border-radius:50%;cursor:pointer;
  transition:transform 0.15s;border:3px solid transparent;
}
.color-swatch:hover{transform:scale(1.15);}
.color-swatch.selected{border-color:var(--text);transform:scale(1.1);}

/* ─ Toast ─ */
.toast-container{
  position:fixed;top:calc(max(var(--safe-t),16px) + 8px);
  left:16px;right:16px;z-index:1000;
  display:flex;flex-direction:column;gap:7px;pointer-events:none;
}
.toast{
  background:var(--text);color:var(--bg);
  padding:12px 14px;border-radius:var(--radius);
  font-size:13px;font-weight:500;box-shadow:var(--shadow-lg);
  animation:toastIn 0.28s cubic-bezier(0.34,1.56,0.64,1);
  display:flex;align-items:center;gap:8px;
  transition:opacity 0.3s;
}
.toast svg{width:14px;height:14px;stroke:currentColor;stroke-width:2;fill:none;flex-shrink:0;}
.toast.error{background:var(--red);color:white;}
.toast.success{background:var(--green);color:white;}
@keyframes toastIn{from{opacity:0;transform:translateY(-14px) scale(0.93);}to{opacity:1;transform:none;}}

/* Confirm */
.confirm-dialog{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--radius-lg);padding:22px 18px;
  max-width:300px;width:calc(100% - 48px);margin:auto;box-shadow:var(--shadow-lg);
  animation:dialogIn 0.2s ease;
}
.confirm-overlay{
  position:fixed;inset:0;z-index:600;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,0.55);backdrop-filter:blur(6px);
  opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.confirm-overlay.open{opacity:1;pointer-events:all;}
@keyframes dialogIn{from{opacity:0;transform:scale(0.88) translateY(12px);}to{opacity:1;transform:none;}}
.confirm-title{font-size:16px;font-weight:700;margin-bottom:7px;}
.confirm-body{font-size:13px;color:var(--text2);margin-bottom:18px;line-height:1.5;}
.confirm-btns{display:flex;gap:7px;}
.btn-cancel{flex:1;padding:11px;border-radius:var(--radius-sm);background:var(--bg3);border:none;font-size:13px;font-weight:500;cursor:pointer;font-family:var(--font);color:var(--text2);transition:all 0.15s;}
.btn-confirm{flex:1;padding:11px;border-radius:var(--radius-sm);background:var(--red);border:none;font-size:13px;font-weight:600;cursor:pointer;font-family:var(--font);color:white;transition:all 0.15s;}
.btn-cancel:active,.btn-confirm:active{transform:scale(0.95);}

/* Loading */
.loading-overlay{
  position:fixed;inset:0;z-index:800;background:var(--bg);
  display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;
  opacity:1;transition:opacity 0.3s;
}
.loading-overlay.hidden{opacity:0;pointer-events:none;}
.spinner{
  width:28px;height:28px;
  border:2.5px solid var(--border);border-top-color:var(--text);
  border-radius:50%;animation:spin 0.7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}
.loading-text{font-size:13px;color:var(--text3);}

/* Transition */
.slide-up{animation:slideUp 0.28s ease;}
@keyframes slideUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:none;}}
</style>
</head>
<body>
<div id="app">

<!-- TOAST -->
<div class="toast-container" id="toast-container"></div>

<!-- LOADING -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-text">Loading budgetBynan…</div>
</div>

<!-- CONFIRM -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-dialog">
    <div class="confirm-title" id="confirm-title">Are you sure?</div>
    <div class="confirm-body"  id="confirm-body">This action cannot be undone.</div>
    <div class="confirm-btns">
      <button class="btn-cancel"  id="confirm-cancel">Cancel</button>
      <button class="btn-confirm" id="confirm-ok">Delete</button>
    </div>
  </div>
</div>

<!-- DESKTOP SIDEBAR (hidden on mobile) -->
<nav class="sidebar" id="sidebar" style="display:none">
  <div class="sidebar-logo">
    <div class="logo logo-sm">
      <span class="budget">budget</span><span class="bynan">Bynan</span>
    </div>
  </div>
  <div class="sidebar-nav">
    <div class="sidebar-item active" data-screen="home">
      <div class="sico">
        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      </div>
      <span>Overview</span>
    </div>
    <div class="sidebar-item" data-screen="transactions">
      <div class="sico">
        <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      </div>
      <span>Transactions</span>
    </div>
    <div class="sidebar-item" data-screen="analytics">
      <div class="sico">
        <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      </div>
      <span>Analytics</span>
    </div>
    <div class="sidebar-item" data-screen="more">
      <div class="sico">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 1.41 1.41M2 12H1M23 12h-1M4.93 19.07a10 10 0 0 1-1.41-1.41M19.07 19.07a10 10 0 0 1-1.41 1.41M4.93 4.93a10 10 0 0 1 1.41-1.41"/></svg>
      </div>
      <span>Settings</span>
    </div>
  </div>
  <div class="sidebar-bottom">
    <div class="sidebar-item" id="sidebar-theme">
      <div class="sico">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
      </div>
      <span id="sidebar-theme-label">Light Mode</span>
    </div>
    <div class="sidebar-item" id="sidebar-logout">
      <div class="sico">
        <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      </div>
      <span>Sign Out</span>
    </div>
  </div>
</nav>

<!-- DESKTOP MAIN WRAPPER -->
<div class="desktop-main" id="desktop-main">

<!-- ════════ LOGIN ════════ -->
<div class="screen active" id="login-screen">
  <div class="login-brand">
    <div class="logo-mark">
      <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
    </div>
    <div class="logo logo-lg" style="justify-content:center;margin-bottom:6px;">
      <span class="budget">budget</span><span class="bynan">Bynan</span>
    </div>
    <p style="font-size:13px;color:var(--text3)">Your personal finance tracker</p>
  </div>

  <div class="login-step" id="step-select">
    <div class="user-list" id="user-list"></div>
    <p style="text-align:center;font-size:12px;color:var(--text3);margin-top:16px;line-height:1.6;">
      Don't see your name?<br>Ask the admin to add you.
    </p>
    </div>

  <div class="login-step" id="step-pin" style="display:none">
    <div class="pin-header">
      <button class="back-btn" id="pin-back">
        <svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg>
      </button>
      <div class="pin-user-info">
        <div class="pname" id="pin-username"></div>
        <div class="psub">Enter your 4-digit PIN</div>
      </div>
    </div>
    <div class="pin-dots" id="pin-dots">
      <div class="pin-dot" data-i="0"></div>
      <div class="pin-dot" data-i="1"></div>
      <div class="pin-dot" data-i="2"></div>
      <div class="pin-dot" data-i="3"></div>
    </div>
    <div class="numpad">
      <button class="numpad-btn" data-n="1">1</button>
      <button class="numpad-btn" data-n="2">2</button>
      <button class="numpad-btn" data-n="3">3</button>
      <button class="numpad-btn" data-n="4">4</button>
      <button class="numpad-btn" data-n="5">5</button>
      <button class="numpad-btn" data-n="6">6</button>
      <button class="numpad-btn" data-n="7">7</button>
      <button class="numpad-btn" data-n="8">8</button>
      <button class="numpad-btn" data-n="9">9</button>
      <button class="numpad-btn empty"></button>
      <button class="numpad-btn" data-n="0">0</button>
      <button class="numpad-btn delete" id="pin-delete">
        <svg viewBox="0 0 24 24"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" y1="9" x2="12" y2="15"/><line x1="12" y1="9" x2="18" y2="15"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- ════════ HOME ════════ -->
<div class="screen" id="home-screen">
  <div class="main-layout">
    <div class="page-content" id="home-content">
      <div class="page-header" id="home-header">
        <div class="header-left">
          <h2>Good <span id="greeting-time">morning</span></h2>
          <p id="home-username-display"></p>
        </div>
        <div class="header-right">
          <button class="icon-btn" id="theme-toggle-home" title="Toggle theme">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
          </button>
          <button class="icon-btn" id="logout-btn" title="Logout">
            <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          </button>
          <button class="desktop-add-btn" id="desktop-add-btn">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Transaction
          </button>
        </div>
      </div>

      <div class="home-hero" id="home-hero">
        <div class="hero-period">
          <span id="hero-period-label">January 2025</span>
          <button id="hero-period-btn">Change</button>
        </div>
        <div class="hero-balance"><span class="currency">$</span><span id="hero-balance">0.00</span></div>
        <div class="hero-change" id="hero-change"></div>
        <div class="hero-stats">
          <div class="hero-stat">
            <div class="hero-stat-label">
              <svg viewBox="0 0 24 24"><polyline points="17 11 12 6 7 11"/><line x1="12" y1="6" x2="12" y2="18"/></svg>
              Income
            </div>
            <div class="hero-stat-value income" id="hero-income">$0</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-label">
              <svg viewBox="0 0 24 24"><polyline points="7 13 12 18 17 13"/><line x1="12" y1="6" x2="12" y2="18"/></svg>
              Expenses
            </div>
            <div class="hero-stat-value expense" id="hero-expense">$0</div>
          </div>
        </div>
      </div>

      <div class="quick-actions">
        <div class="quick-action" id="qa-add-expense">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><polyline points="7 13 12 18 17 13"/><line x1="12" y1="6" x2="12" y2="18"/></svg></div>
          <div class="qa-label">Expense</div>
        </div>
        <div class="quick-action" id="qa-add-income">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><polyline points="17 11 12 6 7 11"/><line x1="12" y1="6" x2="12" y2="18"/></svg></div>
          <div class="qa-label">Income</div>
        </div>
        <div class="quick-action" id="qa-budgets">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
          <div class="qa-label">Budgets</div>
        </div>
        <div class="quick-action" id="qa-sources">
          <div class="qa-icon"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
          <div class="qa-label">Sources</div>
        </div>
      </div>

      <div class="spending-chart-card">
        <div class="chart-title">
          <span>7-Day Spending</span>
          <span id="chart-total" style="font-family:var(--mono);font-size:13px;font-weight:700;color:var(--text)"></span>
        </div>
        <div class="mini-chart" id="mini-chart"></div>
      </div>

      <div class="section-header">
        <h3>Recent</h3>
        <a id="see-all-link">See all</a>
      </div>
      <div class="txn-list" id="recent-txn-list">
        <div class="empty-state">
          <svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
          <p>No transactions yet</p>
        </div>
      </div>
      <div style="height:10px"></div>
    </div>
    <div class="bottom-nav">
      <div class="nav-pills">
        <div class="nav-pill active" data-screen="home">
          <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          <span class="nav-label">Home</span>
        </div>
        <div class="nav-pill" data-screen="transactions">
          <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          <span class="nav-label">Transactions</span>
        </div>
        <div class="nav-pill" data-screen="analytics">
          <svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
          <span class="nav-label">Analytics</span>
        </div>
        <div class="nav-pill" data-screen="more">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
          <span class="nav-label">More</span>
        </div>
      </div>
    </div>
  </div>
  <button class="fab" id="fab">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>
</div>

<!-- ════════ TRANSACTIONS ════════ -->
<div class="screen" id="transactions-screen">
  <div class="main-layout">
    <div class="page-content">
      <div class="page-header">
        <div class="header-left"><h2>Transactions</h2></div>
        <div class="header-right">
          <button class="desktop-add-btn" id="desktop-add-btn-txn">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add
          </button>
        </div>
      </div>
      <div class="month-nav">
        <button id="txn-prev-month">‹</button>
        <span class="month-label" id="txn-month-label">January 2025</span>
        <button id="txn-next-month">›</button>
      </div>
      <div class="filter-bar" id="txn-filters">
        <div class="filter-chip active" data-filter="all">All</div>
        <div class="filter-chip" data-filter="income">Income</div>
        <div class="filter-chip" data-filter="expense">Expense</div>
      </div>
      <div id="txn-list-container">
        <div class="empty-state">
          <svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/></svg>
          <p>No transactions this month</p>
        </div>
      </div>
      <div style="height:10px"></div>
    </div>
    <div class="bottom-nav">
      <div class="nav-pills">
        <div class="nav-pill" data-screen="home"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-label">Home</span></div>
        <div class="nav-pill active" data-screen="transactions"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span class="nav-label">Transactions</span></div>
        <div class="nav-pill" data-screen="analytics"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="nav-label">Analytics</span></div>
        <div class="nav-pill" data-screen="more"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg><span class="nav-label">More</span></div>
      </div>
    </div>
  </div>
  <button class="fab" id="fab-txn">
    <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  </button>
</div>

<!-- ════════ ANALYTICS ════════ -->
<div class="screen" id="analytics-screen">
  <div class="main-layout">
    <div class="page-content">
      <div class="page-header">
        <div class="header-left"><h2>Analytics</h2></div>
        <div class="header-right">
          <button class="desktop-add-btn" id="desktop-add-btn-ana">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add
          </button>
        </div>
      </div>
      <div class="month-nav">
        <button id="ana-prev-month">‹</button>
        <span class="month-label" id="ana-month-label">January 2025</span>
        <button id="ana-next-month">›</button>
      </div>
      <div class="analytics-summary">
        <div class="analytics-card"><div class="ac-label">Income</div><div class="ac-value green" id="ana-income">$0</div></div>
        <div class="analytics-card"><div class="ac-label">Expenses</div><div class="ac-value red" id="ana-expense">$0</div></div>
        <div class="analytics-card"><div class="ac-label">Net Balance</div><div class="ac-value" id="ana-balance">$0</div></div>
        <div class="analytics-card"><div class="ac-label">vs Last Month</div><div class="ac-value" id="ana-vsmonth">—</div><div class="ac-change" id="ana-vsmonth-label"></div></div>
      </div>
      <div class="section-header"><h3>Expense Breakdown</h3></div>
      <div class="donut-card">
        <div class="donut-wrap">
          <svg class="donut-svg" width="100" height="100" viewBox="0 0 100 100" id="donut-svg">
            <circle cx="50" cy="50" r="36" fill="none" stroke="var(--border)" stroke-width="12"/>
          </svg>
          <div class="donut-legend" id="donut-legend">
            <div style="font-size:12px;color:var(--text3)">No expense data</div>
          </div>
        </div>
      </div>
      <div class="section-header"><h3>Budgets</h3><a id="edit-budgets-link">Edit</a></div>
      <div id="budget-list-container">
        <div class="empty-state" style="padding:24px">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <p>No budgets set</p>
        </div>
      </div>
      <div style="height:10px"></div>
    </div>
    <div class="bottom-nav">
      <div class="nav-pills">
        <div class="nav-pill" data-screen="home"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-label">Home</span></div>
        <div class="nav-pill" data-screen="transactions"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span class="nav-label">Transactions</span></div>
        <div class="nav-pill active" data-screen="analytics"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="nav-label">Analytics</span></div>
        <div class="nav-pill" data-screen="more"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg><span class="nav-label">More</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ════════ MORE ════════ -->
<div class="screen" id="more-screen">
  <div class="main-layout">
    <div class="page-content">
      <div class="page-header"><div class="header-left"><h2>Settings</h2></div></div>

      <div class="more-user-card" id="more-user-card">
        <div class="more-user-avatar" id="more-avatar">
          <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        </div>
        <div class="more-user-info">
          <h3 id="more-name">—</h3>
          <p>Personal account</p>
        </div>
      </div>

      <div class="more-section">
        <div class="more-section-label">Manage</div>
        <div class="more-list">
          <div class="more-list-item" id="ml-income-sources">
            <div class="mli-icon"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
            <div class="mli-text"><div class="mlt">Income Sources</div><div class="mls">Manage your income streams</div></div>
            <span class="mli-arrow">›</span>
          </div>
          <div class="more-list-item" id="ml-categories">
            <div class="mli-icon"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></div>
            <div class="mli-text"><div class="mlt">Categories</div><div class="mls">Add or remove categories</div></div>
            <span class="mli-arrow">›</span>
          </div>
          <div class="more-list-item" id="ml-budgets-more">
            <div class="mli-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
            <div class="mli-text"><div class="mlt">Set Budgets</div><div class="mls">Monthly spending limits</div></div>
            <span class="mli-arrow">›</span>
          </div>
        </div>
      </div>

      <div class="more-section" style="margin-top:14px">
        <div class="more-section-label">Appearance</div>
        <div class="more-list">
          <div class="more-list-item">
            <div class="mli-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/></svg></div>
            <div class="mli-text"><div class="mlt">Dark Mode</div><div class="mls">Switch to dark theme</div></div>
            <div class="mli-toggle" id="dark-mode-toggle"></div>
          </div>
        </div>
      </div>

      <div class="more-section" style="margin-top:14px">
        <div class="more-section-label">Account</div>
        <div class="more-list">
          <div class="more-list-item" id="ml-switch">
            <div class="mli-icon"><svg viewBox="0 0 24 24"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></div>
            <div class="mli-text"><div class="mlt">Switch Profile</div></div>
            <span class="mli-arrow">›</span>
          </div>
          <div class="more-list-item" id="ml-logout">
            <div class="mli-icon"><svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></div>
            <div class="mli-text"><div class="mlt" style="color:var(--red)">Sign Out</div></div>
          </div>
        </div>
      </div>

      <div style="height:10px"></div>
    </div>
    <div class="bottom-nav">
      <div class="nav-pills">
        <div class="nav-pill" data-screen="home"><svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg><span class="nav-label">Home</span></div>
        <div class="nav-pill" data-screen="transactions"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><span class="nav-label">Transactions</span></div>
        <div class="nav-pill" data-screen="analytics"><svg viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg><span class="nav-label">Analytics</span></div>
        <div class="nav-pill active" data-screen="more"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg><span class="nav-label">More</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ════════ INCOME SOURCES SUB-SCREEN ════════ -->
<div class="screen" id="sources-screen">
  <div class="main-layout">
    <div class="page-content">
      <div class="page-header">
        <div class="header-left" style="display:flex;align-items:center;gap:10px">
          <button class="back-btn" id="sources-back"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
          <h2 style="font-size:18px">Income Sources</h2>
        </div>
        <div class="header-right">
          <button class="icon-btn" id="add-source-btn" title="Add source">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
      </div>
      <div class="income-sources-list" id="sources-list">
        <div class="empty-state">
          <svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
          <p>Add your income sources</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════ CATEGORIES SUB-SCREEN ════════ -->
<div class="screen" id="categories-screen">
  <div class="main-layout">
    <div class="page-content">
      <div class="page-header">
        <div class="header-left" style="display:flex;align-items:center;gap:10px">
          <button class="back-btn" id="categories-back"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>
          <h2 style="font-size:18px">Categories</h2>
        </div>
        <div class="header-right">
          <button class="icon-btn" id="add-cat-btn" title="Add category">
            <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          </button>
        </div>
      </div>

      <div class="filter-bar" id="cat-type-filter">
        <div class="filter-chip active" data-ctype="expense">Expense</div>
        <div class="filter-chip" data-ctype="income">Income</div>
      </div>

      <div class="cat-list" id="cat-list">
        <div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><p>No categories yet</p></div>
      </div>
    </div>
  </div>
</div>

<!-- ════════ MODALS ════════ -->

<!-- Add Transaction -->
<div class="modal-overlay" id="add-txn-modal">
  <div class="backdrop" id="add-txn-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3 id="add-txn-title">Add Transaction</h3>
      <button class="sheet-close" id="add-txn-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body" id="add-txn-body">
      <div class="form-group">
        <div class="type-toggle">
          <button class="type-btn expense active" data-type="expense">Expense</button>
          <button class="type-btn income" data-type="income">Income</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Amount</label>
        <div class="amount-input-wrap">
          <span class="amount-currency">$</span>
          <input class="form-input" id="txn-amount" type="number" placeholder="0.00" step="0.01" min="0" inputmode="decimal">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <input class="form-input" id="txn-desc" type="text" placeholder="What was this for?">
      </div>
      <div class="form-group">
        <label class="form-label">Date</label>
        <input class="form-input" id="txn-date" type="date">
      </div>
      <div class="form-group" id="source-group" style="display:none">
        <label class="form-label">Income Source</label>
        <div class="source-select" id="source-select"></div>
      </div>
      <div class="form-group">
        <label class="form-label">Category</label>
        <div class="category-grid" id="category-grid"></div>
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-txn-btn">Save Transaction</button>
    </div>
  </div>
</div>

<!-- Add Income Source -->
<div class="modal-overlay" id="add-source-modal">
  <div class="backdrop" id="add-source-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>Add Income Source</h3>
      <button class="sheet-close" id="add-source-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Source Name</label>
        <input class="form-input" id="source-name" type="text" placeholder="e.g. Freelance Design">
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-source-btn">Add Source</button>
    </div>
  </div>
</div>

<!-- Budget Editor -->
<div class="modal-overlay" id="budget-modal">
  <div class="backdrop" id="budget-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>Set Budget</h3>
      <button class="sheet-close" id="budget-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Category</label>
        <select class="form-input" id="budget-cat"></select>
      </div>
      <div class="form-group">
        <label class="form-label">Monthly Limit ($)</label>
        <input class="form-input" id="budget-amount" type="number" placeholder="500" min="0">
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-budget-btn">Save Budget</button>
    </div>
  </div>
</div>

<!-- Add Category -->
<div class="modal-overlay" id="add-cat-modal">
  <div class="backdrop" id="add-cat-backdrop"></div>
  <div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <h3>Add Category</h3>
      <button class="sheet-close" id="add-cat-close"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="sheet-body">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" id="cat-name" type="text" placeholder="e.g. Groceries">
      </div>
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-input" id="cat-type-select">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Color</label>
        <div class="color-swatches" id="color-swatches"></div>
      </div>
    </div>
    <div class="sheet-footer">
      <button class="btn-primary" id="save-cat-btn">Add Category</button>
    </div>
  </div>
</div>

</div><!-- #desktop-main -->
</div><!-- #app -->

<script>
/* ══════════════════════════════════
   CONFIG
══════════════════════════════════ */
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzFUCJ79JXodkV9J0YXqT-uudzzErXZJkZsExFxa_yqCyQyYl0KLT0TA6IWZP1DPTQo/exec';

/* ══════════════════════════════════
   STATE
══════════════════════════════════ */
const state = {
  user:null, users:[], transactions:[], categories:[], budgets:[], sources:[], summary:null,
  currentMonth: new Date().getMonth()+1,
  currentYear:  new Date().getFullYear(),
  txnFilter:'all', txnMonth:new Date().getMonth()+1, txnYear:new Date().getFullYear(),
  anaMonth:new Date().getMonth()+1, anaYear:new Date().getFullYear(),
  txnType:'expense', selectedCat:null, selectedSrc:null,
  catFilter:'expense',
  theme: localStorage.getItem('bbn-theme') || 'auto',
  selectedColor:'#6366f1',
};

const COLORS = ['#6366f1','#f59e0b','#10b981','#ef4444','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316','#84cc16','#06b6d4','#a855f7'];

/* ══════════════════════════════════
   THEME
══════════════════════════════════ */
function applyTheme(){
  const sys = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const dark = state.theme==='dark'||(state.theme==='auto'&&sys);
  document.documentElement.setAttribute('data-theme', dark?'dark':'light');
  document.querySelector('meta[name="theme-color"]').content = dark?'#0c0c0e':'#f7f7f5';
  const tog = document.getElementById('dark-mode-toggle');
  if(tog) tog.classList.toggle('on',dark);
  // sidebar theme label
  const sl = document.getElementById('sidebar-theme-label');
  if(sl) sl.textContent = dark?'Light Mode':'Dark Mode';
}
function toggleTheme(){
  const dark = document.documentElement.getAttribute('data-theme')==='dark';
  state.theme = dark?'light':'dark';
  localStorage.setItem('bbn-theme',state.theme);
  applyTheme();
}
window.matchMedia('(prefers-color-scheme:dark)').addEventListener('change',()=>{if(state.theme==='auto')applyTheme();});
document.getElementById('theme-toggle-home').addEventListener('click',toggleTheme);
document.getElementById('dark-mode-toggle').addEventListener('click',toggleTheme);
document.getElementById('sidebar-theme')?.addEventListener('click',toggleTheme);

/* ══════════════════════════════════
   API
══════════════════════════════════ */
async function api(action,data={}){
  if(!GAS_URL||GAS_URL.includes('YOUR_GOOGLE')) return mockAPI(action,data);
  try{
    const body=JSON.stringify({action,data});
    // GAS requires no-cors for cross-origin POST, so we use a form-encoded workaround
    const r=await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body:body
    });
    const txt=await r.text();
    try{ return JSON.parse(txt); }
    catch(e){ console.error('GAS response not JSON:',txt); return{success:false,error:'Invalid response from server'}; }
  }catch(e){
    console.error('API fetch error:',e);
    return{success:false,error:e.message};
  }
}

/* ── MOCK DB ── */
const mockDB={
  users:[{userId:'u1',name:'Alex'},{userId:'u2',name:'Sam'}],
  pins:{u1:'1234',u2:'0000'},
  transactions:[
    {txnId:'t1',userId:'u1',type:'expense',amount:42.50,category:'Food',description:'Lunch',date:today(),incomeSourceId:'',createdAt:today()},
    {txnId:'t2',userId:'u1',type:'expense',amount:25.00,category:'Transport',description:'Ride',date:today(),incomeSourceId:'',createdAt:today()},
    {txnId:'t3',userId:'u1',type:'income', amount:3200, category:'Salary',description:'Monthly salary',date:today(),incomeSourceId:'src1',createdAt:today()},
    {txnId:'t4',userId:'u1',type:'expense',amount:89.99,category:'Shopping',description:'New shoes',date:prevDay(1),incomeSourceId:'',createdAt:prevDay(1)},
    {txnId:'t5',userId:'u1',type:'expense',amount:15.00,category:'Entertainment',description:'Streaming',date:prevDay(2),incomeSourceId:'',createdAt:prevDay(2)},
  ],
  categories:[
    {catId:'cat1',userId:'default',type:'expense',name:'Food',color:'#ef4444'},
    {catId:'cat2',userId:'default',type:'expense',name:'Transport',color:'#3b82f6'},
    {catId:'cat3',userId:'default',type:'expense',name:'Shopping',color:'#f59e0b'},
    {catId:'cat4',userId:'default',type:'expense',name:'Bills',color:'#10b981'},
    {catId:'cat5',userId:'default',type:'expense',name:'Entertainment',color:'#8b5cf6'},
    {catId:'cat6',userId:'default',type:'expense',name:'Health',color:'#ec4899'},
    {catId:'cat7',userId:'default',type:'expense',name:'Travel',color:'#06b6d4'},
    {catId:'cat8',userId:'default',type:'expense',name:'Other',color:'#6b7280'},
    {catId:'cat9',userId:'default',type:'income',name:'Salary',color:'#10b981'},
    {catId:'cat10',userId:'default',type:'income',name:'Freelance',color:'#3b82f6'},
    {catId:'cat11',userId:'default',type:'income',name:'Investment',color:'#8b5cf6'},
    {catId:'cat12',userId:'default',type:'income',name:'Other Income',color:'#14b8a6'},
  ],
  budgets:[
    {budgetId:'b1',userId:'u1',category:'Food',amount:300,period:'monthly',updatedAt:today()},
    {budgetId:'b2',userId:'u1',category:'Transport',amount:150,period:'monthly',updatedAt:today()},
  ],
  sources:[
    {sourceId:'src1',userId:'u1',name:'Primary Job',isActive:true},
    {sourceId:'src2',userId:'u1',name:'Freelance',isActive:true},
  ],
};
function today(){return new Date().toISOString().split('T')[0];}
function prevDay(n){const d=new Date();d.setDate(d.getDate()-n);return d.toISOString().split('T')[0];}

function mockAPI(action,data){
  switch(action){
    case 'getUsers': return {success:true,users:mockDB.users};
    case 'login':{
      const u=mockDB.users.find(x=>x.userId===data.userId);
      if(u&&String(mockDB.pins[data.userId])===String(data.pin)) return{success:true,user:u};
      return{success:false,error:'Invalid PIN'};
    }
    case 'addUser':{
      const id='u'+Date.now();
      mockDB.users.push({userId:id,name:data.name});
      mockDB.pins[id]=data.pin;
      return{success:true,userId:id};
    }
    case 'getTransactions':{
      let t=mockDB.transactions.filter(x=>x.userId===data.userId);
      if(data.month) t=t.filter(x=>new Date(x.date).getMonth()+1===+data.month);
      if(data.year)  t=t.filter(x=>new Date(x.date).getFullYear()===+data.year);
      if(data.type)  t=t.filter(x=>x.type===data.type);
      t.sort((a,b)=>new Date(b.date)-new Date(a.date));
      return{success:true,transactions:t};
    }
    case 'addTransaction':{
      const t={txnId:'t'+Date.now(),...data,createdAt:new Date().toISOString()};
      mockDB.transactions.push(t);
      return{success:true,txnId:t.txnId};
    }
    case 'deleteTransaction':{
      const i=mockDB.transactions.findIndex(t=>t.txnId===data.txnId&&t.userId===data.userId);
      if(i>-1)mockDB.transactions.splice(i,1);
      return{success:true};
    }
    case 'getCategories':{
      const c=mockDB.categories.filter(x=>x.userId==='default'||x.userId===data.userId);
      return{success:true,categories:c};
    }
    case 'addCategory':{
      const c={catId:'cat_'+Date.now(),...data};
      mockDB.categories.push(c);
      return{success:true};
    }
    case 'deleteCategory':{
      const i=mockDB.categories.findIndex(c=>c.catId===data.catId);
      if(i>-1)mockDB.categories.splice(i,1);
      return{success:true};
    }
    case 'getBudgets': return{success:true,budgets:mockDB.budgets.filter(b=>b.userId===data.userId)};
    case 'setBudget':{
      const i=mockDB.budgets.findIndex(b=>b.userId===data.userId&&b.category===data.category);
      if(i>-1) mockDB.budgets[i]={...mockDB.budgets[i],amount:data.amount};
      else mockDB.budgets.push({budgetId:'b'+Date.now(),...data,updatedAt:today()});
      return{success:true};
    }
    case 'getIncomeSources': return{success:true,sources:mockDB.sources.filter(s=>s.userId===data.userId&&s.isActive)};
    case 'addIncomeSource':{
      const s={sourceId:'src'+Date.now(),...data,isActive:true};
      mockDB.sources.push(s);
      return{success:true,sourceId:s.sourceId};
    }
    case 'deleteIncomeSource':{
      const s=mockDB.sources.find(x=>x.sourceId===data.sourceId&&x.userId===data.userId);
      if(s)s.isActive=false;
      return{success:true};
    }
    case 'getSummary':{
      const m=data.month||new Date().getMonth()+1;
      const y=data.year||new Date().getFullYear();
      const all=mockDB.transactions.filter(t=>{
        const d=new Date(t.date);
        return t.userId===data.userId&&d.getMonth()+1===+m&&d.getFullYear()===+y;
      });
      const totalIncome=all.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
      const totalExpense=all.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
      const expCat={};
      all.filter(t=>t.type==='expense').forEach(t=>expCat[t.category]=(expCat[t.category]||0)+t.amount);
      const daily={};
      const now2=new Date();
      for(let i=6;i>=0;i--){const d=new Date(now2);d.setDate(d.getDate()-i);daily[d.toISOString().split('T')[0]]=0;}
      mockDB.transactions.filter(t=>t.userId===data.userId&&t.type==='expense').forEach(t=>{
        const k=new Date(t.date).toISOString().split('T')[0];
        if(k in daily)daily[k]+=t.amount;
      });
      const pm=+m===1?12:+m-1, py=+m===1?+y-1:+y;
      const prev=mockDB.transactions.filter(t=>{
        const d=new Date(t.date);
        return t.userId===data.userId&&d.getMonth()+1===pm&&d.getFullYear()===py&&t.type==='expense';
      }).reduce((s,t)=>s+t.amount,0);
      return{success:true,summary:{month:m,year:y,totalIncome,totalExpense,balance:totalIncome-totalExpense,
        expenseByCategory:expCat,dailySpending:daily,prevMonthExpense:prev,
        recentTransactions:mockDB.transactions.filter(t=>t.userId===data.userId).sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5)}};
    }
    default: return{success:false,error:'Unknown action'};
  }
}

/* ══════════════════════════════════
   HELPERS
══════════════════════════════════ */
function fmt(n,sign=false){
  const s=Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  if(sign) return (n>=0?'+$':'-$')+s;
  return '$'+s;
}
function monthName(m,y){return new Date(y,m-1,1).toLocaleDateString('en-US',{month:'long',year:'numeric'});}
function relDate(d){
  const dt=new Date(d), t=new Date(); t.setHours(0,0,0,0);
  const diff=Math.floor((t-dt)/86400000);
  if(diff===0)return'Today'; if(diff===1)return'Yesterday';
  return dt.toLocaleDateString('en-US',{month:'short',day:'numeric'});
}
function greeting(){const h=new Date().getHours();return h<12?'morning':h<17?'afternoon':'evening';}
function getCat(name,type){
  return state.categories.find(c=>c.name===name&&c.type===type)||state.categories.find(c=>c.name===name)||{color:'#888'};
}

/* ══════════════════════════════════
   TOAST / CONFIRM
══════════════════════════════════ */
function toast(msg,type='info'){
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.textContent=msg;
  document.getElementById('toast-container').prepend(el);
  setTimeout(()=>el.style.opacity='0',2500);
  setTimeout(()=>el.remove(),3000);
}
function confirmDlg(title,body){
  return new Promise(resolve=>{
    document.getElementById('confirm-title').textContent=title;
    document.getElementById('confirm-body').textContent=body;
    const ov=document.getElementById('confirm-overlay');
    ov.classList.add('open');
    const ok=()=>{cleanup();resolve(true);};
    const cancel=()=>{cleanup();resolve(false);};
    const cleanup=()=>{ov.classList.remove('open');dok.removeEventListener('click',ok);dcancel.removeEventListener('click',cancel);};
    const dok=document.getElementById('confirm-ok'), dcancel=document.getElementById('confirm-cancel');
    dok.addEventListener('click',ok);dcancel.addEventListener('click',cancel);
  });
}

/* ══════════════════════════════════
   SCREEN NAV
══════════════════════════════════ */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id);
  if(el) el.classList.add('active');
}

function navTo(screen){
  // Update nav pills (mobile bottom + desktop sidebar)
  document.querySelectorAll('.nav-pill,.sidebar-item[data-screen]').forEach(p=>{
    p.classList.toggle('active',p.dataset.screen===screen);
  });
  showScreen(screen+'-screen');
  if(screen==='transactions') loadTransactions();
  if(screen==='analytics')    loadAnalytics();
  if(screen==='more')         renderMore();
}

document.querySelectorAll('.nav-pill').forEach(p=>p.addEventListener('click',()=>navTo(p.dataset.screen)));
document.querySelectorAll('.sidebar-item[data-screen]').forEach(p=>p.addEventListener('click',()=>navTo(p.dataset.screen)));

/* ══════════════════════════════════
   SIDEBAR VISIBILITY
══════════════════════════════════ */
function showSidebar(show){
  const sidebar=document.getElementById('sidebar');
  if(window.innerWidth>=960){
    sidebar.style.display = show ? 'flex' : 'none';
  } else {
    sidebar.style.display = 'none';
  }
}
window.addEventListener('resize',()=>showSidebar(!!state.user));
// Initially hide sidebar until logged in
showSidebar(false);

/* ══════════════════════════════════
   MODAL HELPERS
══════════════════════════════════ */
function openModal(id){document.getElementById(id).classList.add('open');document.body.style.overflow='hidden';}
function closeModal(id){document.getElementById(id).classList.remove('open');document.body.style.overflow='';}

['add-txn','add-source','budget','add-cat'].forEach(id=>{
  document.getElementById(id+'-backdrop')?.addEventListener('click',()=>closeModal(id+'-modal'));
  document.getElementById(id+'-close')?.addEventListener('click',()=>closeModal(id+'-modal'));
});

/* ══════════════════════════════════
   LOGIN
══════════════════════════════════ */
let pinBuffer='', selectedUser=null;

async function initLogin(){
  const r=await api('getUsers');
  if(r.success){state.users=r.users;renderUserList();}
}

function renderUserList(){
  const el=document.getElementById('user-list');
  el.innerHTML=state.users.map(u=>`
    <div class="user-card" data-uid="${u.userId}">
      <div class="uav"><svg viewBox="0 0 24 24" style="width:20px;height:20px;stroke:var(--text2);stroke-width:1.8;fill:none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>
      <div class="uname">${u.name}</div>
    </div>
  `).join('');
  el.querySelectorAll('.user-card').forEach(c=>{
    c.addEventListener('click',()=>{
      selectedUser=state.users.find(u=>u.userId===c.dataset.uid);
      document.getElementById('pin-username').textContent=selectedUser.name;
      document.getElementById('step-select').style.display='none';
      document.getElementById('step-pin').style.display='block';
      pinBuffer='';updatePinDots();
    });
  });
}

function updatePinDots(){
  document.querySelectorAll('.pin-dot').forEach((d,i)=>d.classList.toggle('filled',i<pinBuffer.length));
}

document.querySelectorAll('.numpad-btn[data-n]').forEach(b=>{
  b.addEventListener('click',async()=>{
    if(pinBuffer.length>=4)return;
    pinBuffer+=b.dataset.n;updatePinDots();
    if(pinBuffer.length===4){
      const r=await api('login',{userId:selectedUser.userId,pin:pinBuffer});
      if(r.success){
        state.user=r.user;
        // Save user to localStorage for persistence
        localStorage.setItem('bbn-user',JSON.stringify(r.user));
        await afterLogin();
      } else {
        document.querySelectorAll('.pin-dot').forEach(d=>d.classList.add('error'));
        setTimeout(()=>{
          document.querySelectorAll('.pin-dot').forEach(d=>d.classList.remove('error'));
          pinBuffer='';updatePinDots();
        },800);
      }
    }
  });
});

document.getElementById('pin-delete').addEventListener('click',()=>{pinBuffer=pinBuffer.slice(0,-1);updatePinDots();});
document.getElementById('pin-back').addEventListener('click',()=>{
  document.getElementById('step-select').style.display='block';
  document.getElementById('step-pin').style.display='none';
  pinBuffer='';
});

async function afterLogin(){
  showSidebar(true);
  showScreen('home-screen');
  document.getElementById('greeting-time').textContent=greeting();
  document.getElementById('home-username-display').textContent=state.user.name;

  // Load cached data immediately
  const cached=localStorage.getItem('bbn-data-'+state.user.userId);
  if(cached){
    try{
      const d=JSON.parse(cached);
      if(d.categories) state.categories=d.categories;
      if(d.sources) state.sources=d.sources;
      if(d.budgets) state.budgets=d.budgets;
    }catch(e){}
  }

  // Render home with what we have, then sync in background
  await refreshHome();
  syncInBackground();
}

async function syncInBackground(){
  if(!state.user)return;
  const uid=state.user.userId;
  // Parallel fetch
  const [rc,rs,rb]=await Promise.all([
    api('getCategories',{userId:uid}),
    api('getIncomeSources',{userId:uid}),
    api('getBudgets',{userId:uid}),
  ]);
  if(rc.success) state.categories=rc.categories;
  if(rs.success) state.sources=rs.sources;
  if(rb.success) state.budgets=rb.budgets;

  // Cache
  localStorage.setItem('bbn-data-'+uid, JSON.stringify({
    categories:state.categories, sources:state.sources, budgets:state.budgets
  }));

  // Re-render active screen quietly
  const active=document.querySelector('.screen.active')?.id;
  if(active==='home-screen') await refreshHome();
}

/* ══════════════════════════════════
   HOME
══════════════════════════════════ */
async function refreshHome(){
  const r=await api('getSummary',{userId:state.user.userId,month:state.currentMonth,year:state.currentYear});
  if(!r.success)return;
  const s=r.summary;
  state.summary=s;

  document.getElementById('hero-period-label').textContent=monthName(state.currentMonth,state.currentYear);
  document.getElementById('hero-balance').textContent=fmt(s.balance).replace('$','');
  document.getElementById('hero-income').textContent=fmt(s.totalIncome);
  document.getElementById('hero-expense').textContent=fmt(s.totalExpense);

  const diff=s.prevMonthExpense?((s.totalExpense-s.prevMonthExpense)/s.prevMonthExpense*100).toFixed(1):null;
  document.getElementById('hero-change').textContent=diff
    ? `${diff>0?'+':''}${diff}% vs last month`
    : 'First month of data';

  renderMiniChart(s.dailySpending);
  renderRecentTxns(s.recentTransactions);
}

function renderMiniChart(daily){
  const keys=Object.keys(daily);
  const vals=keys.map(k=>daily[k]);
  const max=Math.max(...vals,1);
  const total=vals.reduce((a,b)=>a+b,0);
  document.getElementById('chart-total').textContent=fmt(total);
  const chart=document.getElementById('mini-chart');
  chart.innerHTML=keys.map((k,i)=>{
    const h=Math.max((vals[i]/max)*52,3);
    const day=new Date(k).toLocaleDateString('en-US',{weekday:'short'}).slice(0,2);
    const isToday=k===today();
    return`<div class="chart-col">
      <div class="chart-bar${isToday?' active':''}" style="height:${h}px"></div>
      <div class="chart-bar-label">${day}</div>
    </div>`;
  }).join('');
}

function renderRecentTxns(txns){
  const el=document.getElementById('recent-txn-list');
  if(!txns||!txns.length){
    el.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg><p>No transactions yet</p></div>`;
    return;
  }
  el.innerHTML=txns.map(t=>txnHtml(t)).join('');
  el.querySelectorAll('.txn-item').forEach(item=>{
    item.addEventListener('click',()=>handleDeleteTxn(item.dataset.id));
  });
}

function txnHtml(t){
  const cat=getCat(t.category,t.type);
  const icon=t.type==='income'
    ?`<svg viewBox="0 0 24 24"><polyline points="17 11 12 6 7 11"/><line x1="12" y1="6" x2="12" y2="18"/></svg>`
    :`<svg viewBox="0 0 24 24"><polyline points="7 13 12 18 17 13"/><line x1="12" y1="6" x2="12" y2="18"/></svg>`;
  return`<div class="txn-item" data-id="${t.txnId}">
    <div class="txn-icon ${t.type}">${icon}</div>
    <div class="txn-info">
      <div class="txn-name">${t.description||t.category}</div>
      <div class="txn-sub">${t.category} &middot; ${relDate(t.date)}</div>
    </div>
    <div class="txn-amount ${t.type}">${t.type==='income'?'+':'-'}${fmt(t.amount)}</div>
  </div>`;
}

async function handleDeleteTxn(txnId){
  const ok=await confirmDlg('Delete Transaction','This will permanently remove this record.');
  if(!ok)return;
  const r=await api('deleteTransaction',{txnId,userId:state.user.userId});
  if(r.success){
    toast('Deleted','success');
    await refreshHome();
    const active=document.querySelector('.screen.active')?.id;
    if(active==='transactions-screen') await loadTransactions();
    if(active==='analytics-screen') await loadAnalytics();
  }
}

/* ══════════════════════════════════
   TRANSACTIONS SCREEN
══════════════════════════════════ */
async function loadTransactions(){
  const r=await api('getTransactions',{userId:state.user.userId,month:state.txnMonth,year:state.txnYear});
  if(!r.success)return;
  let txns=r.transactions;
  document.getElementById('txn-month-label').textContent=monthName(state.txnMonth,state.txnYear);

  if(state.txnFilter!=='all') txns=txns.filter(t=>t.type===state.txnFilter);
  const container=document.getElementById('txn-list-container');
  if(!txns.length){
    container.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/></svg><p>No transactions this month</p></div>`;
    return;
  }
  // Group by date
  const groups={};
  txns.forEach(t=>{const k=t.date.split('T')[0];if(!groups[k])groups[k]=[];groups[k].push(t);});
  container.innerHTML=Object.keys(groups).sort((a,b)=>new Date(b)-new Date(a)).map(k=>`
    <div class="txn-date-group">
      <div class="date-label">${relDate(k)}</div>
      <div class="txn-list">${groups[k].map(t=>txnHtml(t)).join('')}</div>
    </div>
  `).join('');
  container.querySelectorAll('.txn-item').forEach(item=>{
    item.addEventListener('click',()=>handleDeleteTxn(item.dataset.id));
  });
}

// Filter chips
document.getElementById('txn-filters').querySelectorAll('.filter-chip').forEach(c=>{
  c.addEventListener('click',()=>{
    document.getElementById('txn-filters').querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');state.txnFilter=c.dataset.filter;loadTransactions();
  });
});

document.getElementById('txn-prev-month').addEventListener('click',()=>{
  state.txnMonth--;if(state.txnMonth<1){state.txnMonth=12;state.txnYear--;}loadTransactions();
});
document.getElementById('txn-next-month').addEventListener('click',()=>{
  state.txnMonth++;if(state.txnMonth>12){state.txnMonth=1;state.txnYear++;}loadTransactions();
});

/* ══════════════════════════════════
   ANALYTICS
══════════════════════════════════ */
async function loadAnalytics(){
  const r=await api('getSummary',{userId:state.user.userId,month:state.anaMonth,year:state.anaYear});
  if(!r.success)return;
  const s=r.summary;
  document.getElementById('ana-month-label').textContent=monthName(state.anaMonth,state.anaYear);
  document.getElementById('ana-income').textContent=fmt(s.totalIncome);
  document.getElementById('ana-expense').textContent=fmt(s.totalExpense);
  document.getElementById('ana-balance').textContent=fmt(s.balance);
  document.getElementById('ana-balance').className='ac-value '+(s.balance>=0?'green':'red');

  if(s.prevMonthExpense){
    const diff=((s.totalExpense-s.prevMonthExpense)/s.prevMonthExpense*100).toFixed(1);
    document.getElementById('ana-vsmonth').textContent=fmt(s.totalExpense-s.prevMonthExpense,true);
    document.getElementById('ana-vsmonth').className='ac-value '+(diff<=0?'green':'red');
    document.getElementById('ana-vsmonth-label').textContent=`${diff>0?'+':''}${diff}% vs last month`;
  }

  renderDonut(s.expenseByCategory);
  renderBudgets(s.expenseByCategory);
}

document.getElementById('ana-prev-month').addEventListener('click',()=>{
  state.anaMonth--;if(state.anaMonth<1){state.anaMonth=12;state.anaYear--;}loadAnalytics();
});
document.getElementById('ana-next-month').addEventListener('click',()=>{
  state.anaMonth++;if(state.anaMonth>12){state.anaMonth=1;state.anaYear++;}loadAnalytics();
});

function renderDonut(expCat){
  const entries=Object.entries(expCat).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const total=entries.reduce((s,[,v])=>s+v,0);
  const svg=document.getElementById('donut-svg');
  const legend=document.getElementById('donut-legend');
  if(!total){
    svg.innerHTML='<circle cx="50" cy="50" r="36" fill="none" stroke="var(--border)" stroke-width="12"/>';
    legend.innerHTML='<div style="font-size:12px;color:var(--text3)">No expense data</div>';
    return;
  }
  let arcs='<circle cx="50" cy="50" r="36" fill="none" stroke="var(--border)" stroke-width="12"/>';
  let cumulative=0;
  const circ=2*Math.PI*36;
  legend.innerHTML='';
  entries.forEach(([name,val])=>{
    const cat=getCat(name,'expense');
    const pct=val/total;
    const dash=pct*circ;
    const gap=circ-dash;
    const rot=cumulative*360-90;
    arcs+=`<circle cx="50" cy="50" r="36" fill="none" stroke="${cat.color}" stroke-width="12"
      stroke-dasharray="${dash} ${gap}"
      transform="rotate(${rot} 50 50)"/>`;
    cumulative+=pct;
    legend.innerHTML+=`<div class="legend-item">
      <div class="legend-dot" style="background:${cat.color}"></div>
      <div class="legend-label">${name}</div>
      <div class="legend-pct">${(pct*100).toFixed(0)}%</div>
    </div>`;
  });
  svg.innerHTML=arcs;
}

function renderBudgets(expCat){
  const container=document.getElementById('budget-list-container');
  if(!state.budgets.length){
    container.innerHTML='<div class="empty-state" style="padding:24px"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg><p>No budgets set</p></div>';
    return;
  }
  container.innerHTML=state.budgets.filter(b=>b.userId===state.user.userId).map(b=>{
    const spent=expCat[b.category]||0;
    const pct=Math.min((spent/b.amount)*100,100);
    const cls=pct>=100?'over':pct>=75?'warning':'ok';
    return`<div class="budget-item">
      <div class="budget-item-top">
        <div class="budget-item-name">${b.category}</div>
        <div class="budget-item-amounts">${fmt(spent)} / ${fmt(b.amount)}</div>
      </div>
      <div class="budget-bar"><div class="budget-bar-fill ${cls}" style="width:${pct}%"></div></div>
    </div>`;
  }).join('');
}

/* ══════════════════════════════════
   MORE / SETTINGS
══════════════════════════════════ */
function renderMore(){
  if(!state.user)return;
  document.getElementById('more-name').textContent=state.user.name;
  const dark=document.documentElement.getAttribute('data-theme')==='dark';
  document.getElementById('dark-mode-toggle').classList.toggle('on',dark);
}

/* ══════════════════════════════════
   ADD TRANSACTION
══════════════════════════════════ */
function openAddTxnModal(type='expense'){
  state.txnType=type;state.selectedCat=null;state.selectedSrc=null;
  document.querySelectorAll('.type-btn').forEach(b=>b.classList.toggle('active',b.dataset.type===type));
  document.getElementById('txn-date').value=today();
  document.getElementById('txn-amount').value='';
  document.getElementById('txn-desc').value='';
  document.getElementById('source-group').style.display=type==='income'?'block':'none';
  renderCategoryGrid(type);renderSourceSelect();
  openModal('add-txn-modal');
}

function renderCategoryGrid(type){
  const cats=state.categories.filter(c=>c.type===type);
  const grid=document.getElementById('category-grid');
  grid.innerHTML=cats.map(c=>`
    <button class="category-chip" data-name="${c.name}">
      <div class="cc-dot" style="background:${c.color}"></div>
      <div class="cc-label">${c.name}</div>
    </button>
  `).join('');
  grid.querySelectorAll('.category-chip').forEach(chip=>{
    chip.addEventListener('click',()=>{
      grid.querySelectorAll('.category-chip').forEach(c=>c.classList.remove('selected'));
      chip.classList.add('selected');state.selectedCat=chip.dataset.name;
    });
  });
}

function renderSourceSelect(){
  const el=document.getElementById('source-select');
  if(!state.sources.length){
    el.innerHTML='<div style="font-size:12px;color:var(--text3)">No income sources. Add one in Settings.</div>';return;
  }
  el.innerHTML=state.sources.map(s=>`
    <button class="source-option" data-id="${s.sourceId}">
      <div class="so-icon"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
      <span class="so-name">${s.name}</span>
      <span class="so-check"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg></span>
    </button>
  `).join('');
  el.querySelectorAll('.source-option').forEach(opt=>{
    opt.addEventListener('click',()=>{
      el.querySelectorAll('.source-option').forEach(o=>o.classList.remove('selected'));
      opt.classList.add('selected');state.selectedSrc=opt.dataset.id;
    });
  });
}

document.querySelectorAll('.type-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    state.txnType=btn.dataset.type;
    document.querySelectorAll('.type-btn').forEach(b=>b.classList.toggle('active',b.dataset.type===state.txnType));
    document.getElementById('source-group').style.display=state.txnType==='income'?'block':'none';
    renderCategoryGrid(state.txnType);
  });
});

document.getElementById('save-txn-btn').addEventListener('click',async()=>{
  const amount=parseFloat(document.getElementById('txn-amount').value);
  const desc=document.getElementById('txn-desc').value.trim();
  const date=document.getElementById('txn-date').value;
  if(!amount||amount<=0){toast('Enter a valid amount','error');return;}
  if(!state.selectedCat){toast('Select a category','error');return;}
  const r=await api('addTransaction',{
    userId:state.user.userId,type:state.txnType,amount,
    category:state.selectedCat,description:desc,date,
    incomeSourceId:state.selectedSrc||''
  });
  if(r.success){
    closeModal('add-txn-modal');toast('Transaction added','success');
    await refreshHome();
    const active=document.querySelector('.screen.active')?.id;
    if(active==='transactions-screen')await loadTransactions();
    if(active==='analytics-screen')await loadAnalytics();
  } else {toast('Failed to save','error');}
});

/* ══════════════════════════════════
   BUDGET MODAL
══════════════════════════════════ */
function openBudgetModal(){
  const sel=document.getElementById('budget-cat');
  const expCats=state.categories.filter(c=>c.type==='expense');
  sel.innerHTML=expCats.map(c=>`<option value="${c.name}">${c.name}</option>`).join('');
  document.getElementById('budget-amount').value='';
  openModal('budget-modal');
}
document.getElementById('save-budget-btn').addEventListener('click',async()=>{
  const category=document.getElementById('budget-cat').value;
  const amount=parseFloat(document.getElementById('budget-amount').value);
  if(!amount||amount<=0){toast('Enter a valid amount','error');return;}
  const r=await api('setBudget',{userId:state.user.userId,category,amount,period:'monthly'});
  if(r.success){
    const r2=await api('getBudgets',{userId:state.user.userId});
    if(r2.success)state.budgets=r2.budgets;
    closeModal('budget-modal');toast('Budget saved','success');
    if(document.getElementById('analytics-screen').classList.contains('active'))await loadAnalytics();
  }
});

/* ══════════════════════════════════
   ADD USER
══════════════════════════════════ */


/* ══════════════════════════════════
   INCOME SOURCES
══════════════════════════════════ */
async function renderSourcesList(){
  const el=document.getElementById('sources-list');
  const r=await api('getIncomeSources',{userId:state.user.userId});
  if(r.success)state.sources=r.sources;
  if(!state.sources.length){
    el.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg><p>Add your income sources</p></div>`;
    return;
  }
  el.innerHTML=state.sources.map(s=>`
    <div class="income-source-item">
      <div class="is-icon"><svg viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg></div>
      <div class="is-name">${s.name}</div>
      <button class="is-delete" data-id="${s.sourceId}">
        <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
      </button>
    </div>
  `).join('');
  el.querySelectorAll('.is-delete').forEach(b=>{
    b.addEventListener('click',async()=>{
      const ok=await confirmDlg('Delete Source','This will remove the income source.');
      if(!ok)return;
      const r=await api('deleteIncomeSource',{sourceId:b.dataset.id,userId:state.user.userId});
      if(r.success){toast('Removed','success');renderSourcesList();}
    });
  });
}

document.getElementById('ml-income-sources').addEventListener('click',()=>{showScreen('sources-screen');renderSourcesList();});
document.getElementById('sources-back').addEventListener('click',()=>{showScreen('more-screen');renderMore();});
document.getElementById('add-source-btn').addEventListener('click',()=>openModal('add-source-modal'));
document.getElementById('save-source-btn').addEventListener('click',async()=>{
  const name=document.getElementById('source-name').value.trim();
  if(!name){toast('Enter a source name','error');return;}
  const r=await api('addIncomeSource',{userId:state.user.userId,name});
  if(r.success){
    closeModal('add-source-modal');
    document.getElementById('source-name').value='';
    toast('Source added','success');renderSourcesList();
  }
});

/* ══════════════════════════════════
   CATEGORIES
══════════════════════════════════ */
async function renderCatList(){
  const el=document.getElementById('cat-list');
  const r=await api('getCategories',{userId:state.user.userId});
  if(r.success)state.categories=r.categories;
  const cats=state.categories.filter(c=>c.type===state.catFilter&&(c.userId==='default'||c.userId===state.user.userId));
  if(!cats.length){
    el.innerHTML=`<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><p>No categories</p></div>`;
    return;
  }
  el.innerHTML=cats.map(c=>`
    <div class="cat-item">
      <div class="cat-dot" style="background:${c.color}"></div>
      <div class="cat-item-name">${c.name}</div>
      <div class="cat-item-type">${c.type}</div>
      ${c.userId!=='default'?`<button class="cat-delete" data-id="${c.catId}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg></button>`:''}
    </div>
  `).join('');
  el.querySelectorAll('.cat-delete').forEach(b=>{
    b.addEventListener('click',async()=>{
      const ok=await confirmDlg('Delete Category','This will remove the category.');
      if(!ok)return;
      const r=await api('deleteCategory',{catId:b.dataset.id});
      if(r.success){toast('Removed','success');renderCatList();}
    });
  });
}

document.getElementById('ml-categories').addEventListener('click',()=>{showScreen('categories-screen');renderCatList();});
document.getElementById('categories-back').addEventListener('click',()=>{showScreen('more-screen');renderMore();});

document.getElementById('cat-type-filter').querySelectorAll('.filter-chip').forEach(c=>{
  c.addEventListener('click',()=>{
    document.getElementById('cat-type-filter').querySelectorAll('.filter-chip').forEach(x=>x.classList.remove('active'));
    c.classList.add('active');state.catFilter=c.dataset.ctype;renderCatList();
  });
});

document.getElementById('add-cat-btn').addEventListener('click',()=>{
  // Setup color swatches
  const sw=document.getElementById('color-swatches');
  sw.innerHTML=COLORS.map(c=>`<div class="color-swatch${c===state.selectedColor?' selected':''}" data-color="${c}" style="background:${c}"></div>`).join('');
  sw.querySelectorAll('.color-swatch').forEach(s=>{
    s.addEventListener('click',()=>{
      sw.querySelectorAll('.color-swatch').forEach(x=>x.classList.remove('selected'));
      s.classList.add('selected');state.selectedColor=s.dataset.color;
    });
  });
  openModal('add-cat-modal');
});

document.getElementById('save-cat-btn').addEventListener('click',async()=>{
  const name=document.getElementById('cat-name').value.trim();
  const type=document.getElementById('cat-type-select').value;
  if(!name){toast('Enter a category name','error');return;}
  const r=await api('addCategory',{userId:state.user.userId,type,name,color:state.selectedColor});
  if(r.success){
    closeModal('add-cat-modal');
    document.getElementById('cat-name').value='';
    toast('Category added','success');
    await syncInBackground();
    renderCatList();
  }
});

/* ══════════════════════════════════
   QUICK ACTIONS / BUTTONS
══════════════════════════════════ */
document.getElementById('fab').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('fab-txn').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('desktop-add-btn').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('desktop-add-btn-txn').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('desktop-add-btn-ana').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('qa-add-expense').addEventListener('click',()=>openAddTxnModal('expense'));
document.getElementById('qa-add-income').addEventListener('click',()=>openAddTxnModal('income'));
document.getElementById('qa-budgets').addEventListener('click',openBudgetModal);
document.getElementById('qa-sources').addEventListener('click',()=>{showScreen('sources-screen');renderSourcesList();});
document.getElementById('see-all-link').addEventListener('click',()=>navTo('transactions'));
document.getElementById('edit-budgets-link').addEventListener('click',openBudgetModal);
document.getElementById('ml-budgets-more').addEventListener('click',openBudgetModal);

document.getElementById('hero-period-btn').addEventListener('click',()=>{
  state.currentMonth--;if(state.currentMonth<1){state.currentMonth=12;state.currentYear--;}
  refreshHome();
});

document.getElementById('home-content').addEventListener('scroll',function(){
  document.getElementById('home-header').classList.toggle('scrolled',this.scrollTop>8);
});

/* ══════════════════════════════════
   LOGOUT
══════════════════════════════════ */
function logout(){
  state.user=null;state.transactions=[];state.summary=null;
  localStorage.removeItem('bbn-user');
  showSidebar(false);
  showScreen('login-screen');
  document.getElementById('step-select').style.display='block';
  document.getElementById('step-pin').style.display='none';
  initLogin();
}
document.getElementById('logout-btn').addEventListener('click',logout);
document.getElementById('ml-logout').addEventListener('click',logout);
document.getElementById('sidebar-logout')?.addEventListener('click',logout);
document.getElementById('ml-switch').addEventListener('click',logout);

/* ══════════════════════════════════
   INIT
══════════════════════════════════ */
applyTheme();

// Try to restore session
const savedUser=localStorage.getItem('bbn-user');
if(savedUser){
  try{
    state.user=JSON.parse(savedUser);
    showSidebar(true);
    document.getElementById('greeting-time').textContent=greeting();
    document.getElementById('home-username-display').textContent=state.user.name;
    showScreen('home-screen');
    (async()=>{
      await syncInBackground();
      await refreshHome();
    })();
  }catch(e){localStorage.removeItem('bbn-user');initLogin();}
} else {
  initLogin();
}

// Hide loading
document.getElementById('loading-overlay').classList.add('hidden');
</script>
</body>
</html>
